<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>מערכת ניהול פרויקטים</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
  <style>
    :root {
      /* צבעים עיקריים */
      --primary: #4361ee;
      --primary-light: #4895ef;
      --primary-dark: #3a0ca3;
      --secondary: #7209b7;
      --success: #0bb5a0;
      --warning: #ff9e00;
      --danger: #e63946;
      --info: #4cc9f0;
      --dark: #2b2d42;
      --light: #f8f9fa;
      --gray: #adb5bd;
      --white: #ffffff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      --radius: 12px;
      
      /* צבעי רקע */
      --bg-light: #f5f7fb;
      --card-hover: #f0f4ff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Rubik', Arial, sans-serif;
      direction: rtl;
      margin: 0;
      padding: 0;
      background-color: var(--bg-light);
      color: var(--dark);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* עיצוב כרטיסיות */
    .card {
      background-color: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 24px;
      transition: all 0.3s ease;
      border: none;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      color: var(--dark);
    }

    .card-body {
      position: relative;
    }

    /* לוח כרטיסיות */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .dashboard-col-2 {
      grid-column: span 2;
    }

    .dashboard-row-2 {
      grid-row: span 2;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .dashboard-col-2 {
        grid-column: span 1;
      }
    }

    .hidden {
      display: none !important;
    }

    h1, h2, h3, h4, h5, h6 {
      color: var(--dark);
      margin-top: 0;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      font-family: inherit;
      transition: border-color 0.3s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    /* כפתורים חדשים */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: var(--primary);
      color: var(--white);
      border: none;
      border-radius: var(--radius);
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      text-align: center;
      font-size: 14px;
      gap: 8px;
    }

    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-lg {
      padding: 12px 20px;
      font-size: 16px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 8px;
    }

    .btn-success {
      background-color: var(--success);
    }

    .btn-success:hover {
      background-color: #099a88;
    }

    .btn-danger {
      background-color: var(--danger);
    }

    .btn-danger:hover {
      background-color: #d32f3d;
    }

    .btn-warning {
      background-color: var(--warning);
      color: var(--dark);
    }

    .btn-warning:hover {
      background-color: #e68a00;
    }

    .btn-info {
      background-color: var(--info);
    }

    .btn-info:hover {
      background-color: #3ab7de;
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background-color: var(--primary);
      color: var(--white);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--dark);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      margin: -10px;
    }

    .col {
      flex: 1;
      padding: 10px;
    }

    /* רשימת פרויקטים */
    .project-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .project-card {
      position: relative;
      cursor: pointer;
      overflow: hidden;
      border-radius: var(--radius);
      background-color: var(--white);
      border: none;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      height: 100%;
    }

    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      background-color: var(--card-hover);
    }

    .project-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: 5px;
      background: var(--primary);
      border-radius: 2px;
    }

    .project-card.overdue::before {
      background: var(--danger);
    }

    .project-card-content {
      padding: 20px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .project-card-title {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: var(--dark);
    }

    .project-card-description {
      color: #6c757d;
      margin-bottom: 10px;
      flex-grow: 1;
    }

    .project-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }

    .project-type-indicator {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .personal-project {
      background-color: #d5f5e3;
      color: #27ae60;
    }

    .team-project {
      background-color: #d4e6f1;
      color: #2980b9;
    }

    /* רשימת חברי צוות */
    .member-list {
      margin-top: 20px;
    }

    .member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background-color: #f8f9fa;
      border-radius: var(--radius);
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    .member-item:hover {
      background-color: #e9ecef;
      transform: translateY(-2px);
    }

    /* רשימת משימות */
    .task-list {
      margin-top: 20px;
    }

    .task-item {
      display: flex;
      flex-direction: column;
      padding: 16px;
      background-color: var(--light);
      border-radius: var(--radius);
      margin-bottom: 16px;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-right: 3px solid transparent;
    }

    .task-item:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .task-item.completed {
      background-color: #e8f5e9;
      border-right: 3px solid var(--success);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .task-content {
      flex-grow: 1;
      margin-bottom: 12px;
    }

    .task-title {
      margin: 0 0 8px 0;
      font-weight: 500;
      color: var(--dark);
      font-size: 16px;
    }

    .task-description {
      color: #6c757d;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
      font-size: 12px;
      align-items: center;
    }

    .task-due-date {
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-due-date.overdue {
      color: var(--danger);
      font-weight: 500;
    }

    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      justify-content: flex-end;
    }

    /* מודלים */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow-y: auto;
    }

    .modal-content {
      background-color: var(--white);
      margin: 10% auto;
      padding: 30px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      box-shadow: var(--shadow);
      animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      margin: 0;
      font-size: 20px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 24px;
      color: var(--gray);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    /* טאבים */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      overflow-x: auto;
      white-space: nowrap;
      background-color: var(--white);
      border-radius: var(--radius);
      padding: 4px;
      box-shadow: var(--shadow);
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      color: var(--gray);
      transition: all 0.3s;
      border-radius: 8px;
    }

    .tab:hover {
      color: var(--primary);
      background-color: rgba(67, 97, 238, 0.05);
    }

    .tab.active {
      background-color: var(--primary);
      color: var(--white);
    }

    /* אוטנטיקציה */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary) 100%);
    }

    .auth-card {
      width: 100%;
      max-width: 400px;
      padding: 30px;
      background-color: var(--white);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    /* תגיות ומדבקות */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .badge-owner {
      background-color: #fff3e6;
      color: #ff8c00;
    }

    .badge-member {
      background-color: #e6f3ff;
      color: #0070f3;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      background-color: #e9ecef;
      color: #495057;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      margin: 0 5px 5px 0;
    }

    .tag.high {
      background-color: #f8d7da;
      color: #dc3545;
    }

    .tag.medium {
      background-color: #fff3cd;
      color: #ffc107;
    }

    .tag.low {
      background-color: #d1e7dd;
      color: #198754;
    }

    .tag-blue {
      background-color: #cfe2ff;
      color: #0d6efd;
    }

    .tag-green {
      background-color: #d1e7dd;
      color: #198754;
    }

    .tag-red {
      background-color: #f8d7da;
      color: #dc3545;
    }

    .tag-yellow {
      background-color: #fff3cd;
      color: #ffc107;
    }

    .tag-purple {
      background-color: #e2d9f3;
      color: #6f42c1;
    }

    .tag-cyan {
      background-color: #d7f5fc;
      color: #17a2b8;
    }

    /* סטטוס משימה */
    .task-status {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      gap: 5px;
    }

    .status-not-started {
      background-color: #e9ecef;
      color: #495057;
    }

    .status-in-progress {
      background-color: #cfe2ff;
      color: #0d6efd;
    }

    .status-completed {
      background-color: #d1e7dd;
      color: #198754;
    }

    .status-waiting {
      background-color: #fff3cd;
      color: #ffc107;
    }

    .status-blocked {
      background-color: #f8d7da;
      color: #dc3545;
    }

    /* בקשות עזרה */
    .help-request {
      background-color: #ffedd1;
      border-right: 3px solid var(--warning);
    }

    /* תגיות מקוננות */
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      margin-bottom: 15px;
      background-color: white;
    }

    .tag-item {
      display: flex;
      align-items: center;
      background-color: #e9ecef;
      padding: 3px 10px;
      border-radius: 16px;
      font-size: 12px;
    }

    .tag-close {
      margin-right: 5px;
      cursor: pointer;
    }

    .tag-input {
      flex-grow: 1;
      border: none;
      outline: none;
      padding: 5px;
      margin-bottom: 0;
    }

    /* טוען */
    .loader-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(67, 97, 238, 0.2);
      border-radius: 50%;
      border-top: 5px solid var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ניווט */
    .navbar {
      background-color: var(--white);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 12px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .navbar-brand {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navbar-brand i {
      font-size: 24px;
    }

    .navbar-nav {
      display: flex;
      align-items: center;
    }

    .nav-item {
      margin-right: 20px;
    }

    .nav-link {
      color: var(--dark);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
      padding: 8px 12px;
      border-radius: 8px;
    }

    .nav-link:hover {
      color: var(--primary);
      background-color: rgba(67, 97, 238, 0.05);
    }

    .nav-link.active {
      color: var(--primary);
      background-color: rgba(67, 97, 238, 0.1);
    }

    /* תפריט משתמש */
    .user-menu {
      position: relative;
      cursor: pointer;
    }

    .user-menu-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      border-radius: var(--radius);
      transition: all 0.3s;
    }

    .user-menu-toggle:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--primary);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
    }

    .user-menu-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background-color: var(--white);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 8px 0;
      min-width: 200px;
      z-index: 1000;
      display: none;
      margin-top: 8px;
    }

    .user-menu-dropdown.show {
      display: block;
      animation: fadeInDown 0.3s;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-menu-item {
      padding: 10px 15px;
      display: flex;
      text-decoration: none;
      color: var(--dark);
      transition: background-color 0.3s;
      align-items: center;
      gap: 8px;
    }

    .user-menu-item:hover {
      background-color: #f8f9fa;
    }

    .user-menu-item.logout {
      color: var(--danger);
    }

    /* חיפוש */
    .search-container {
      display: flex;
      margin-bottom: 20px;
      position: relative;
    }

    .search-container input {
      flex: 1;
      padding-left: 40px;
      margin-bottom: 0;
      border-radius: var(--radius);
      border: 1px solid #e4e6ef;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .search-container input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .search-container .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }

    /* כפתור שינוי סטטוס מהיר */
    .quick-status-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .status-btn {
      font-size: 12px !important;
      padding: 3px 8px !important;
      border-radius: 12px !important;
      cursor: pointer;
      transition: all 0.2s;
      border: none !important;
    }

    .status-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* אייקונים עם תוויות */
    .icon-with-text {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* התראות */
    .notifications-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 2000;
      max-width: 300px;
    }

    .notification {
      background-color: var(--white);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-right: 5px solid var(--primary);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 10px;
      animation: notificationFadeIn 0.3s;
    }

    @keyframes notificationFadeIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .notification-title {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .notification-message {
      font-size: 14px;
      color: #666;
    }

    /* סגנון העלאת קבצים */
    .file-upload-container {
      border: 2px dashed #ddd;
      border-radius: var(--radius);
      padding: 15px;
      text-align: center;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-upload-container:hover {
      border-color: var(--primary);
    }

    .file-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .file-item {
      display: flex;
      align-items: center;
      background-color: #f8f9fa;
      padding: 5px 10px;
      border-radius: var(--radius);
      font-size: 12px;
    }

    .file-delete {
      margin-right: 5px;
      cursor: pointer;
      color: var(--danger);
    }

    /* פאנל פרופיל משתמש */
    .profile-panel {
      background-color: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      margin-left: 15px;
    }

    .profile-name {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    .profile-email {
      color: #666;
      margin: 5px 0 0 0;
    }

    .profile-form {
      margin-top: 20px;
    }

    /* פאנל הגדרות */
    .settings-panel {
      background-color: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .settings-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }

    .settings-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .settings-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--primary);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }

    .setting-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .setting-option-label {
      font-weight: 500;
    }

    .setting-option-description {
      color: #666;
      font-size: 13px;
      margin-top: 3px;
    }

    /* גיליון סגנון עבור התאמת מסך */
    @media (max-width: 768px) {
      .project-list {
        grid-template-columns: 1fr;
      }

      .row {
        flex-direction: column;
      }

      .navbar-container {
        flex-direction: column;
        gap: 10px;
      }

      .navbar-nav {
        flex-direction: column;
        width: 100%;
      }

      .nav-item {
        width: 100%;
        margin-right: 0;
        text-align: center;
        padding: 8px 0;
      }

      .hamburger-menu {
        display: block;
      }

      .nav-collapsed {
        display: none;
      }
    }

    /* התראות העבודה בתהליך וצבעי התראות */
    .overlay-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: rgba(52, 152, 219, 0.9);
      color: white;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      animation: fadeInRight 0.3s;
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  </style>
</head>
<body>
  <!-- טוען -->
  <div id="loader" class="loader-container">
    <div class="loader"></div>
  </div>

  <!-- פאנל התראות -->
  <div id="notifications-panel" class="notifications-panel"></div>

  <!-- אזור התחברות -->
  <div id="auth-section" class="auth-container hidden">
    <div class="auth-card">
      <h1 style="text-align: center; margin-bottom: 30px; color: var(--primary);">
        <i class="fas fa-tasks" style="margin-left: 10px;"></i>
        מערכת ניהול פרויקטים
      </h1>
      <div id="auth-error" style="color: var(--danger); margin-bottom: 15px; display: none; padding: 10px; background-color: rgba(230, 57, 70, 0.1); border-radius: var(--radius);"></div>

      <div class="form-group">
        <label for="email">אימייל:</label>
        <input type="email" id="email" placeholder="הכנס אימייל">
      </div>

      <div class="form-group" id="display-name-container" style="display: none;">
        <label for="display-name">כינוי משתמש:</label>
        <input type="text" id="display-name" placeholder="הכנס כינוי לתצוגה">
      </div>

      <div class="form-group">
        <label for="password">סיסמה:</label>
        <input type="password" id="password" placeholder="הכנס סיסמה">
      </div>

      <!-- כפתורי התחברות -->
      <div id="login-actions" style="display: flex; gap: 10px; margin-top: 20px;">
        <button id="login-btn" class="btn btn-lg" style="flex: 1;">
          <i class="fas fa-sign-in-alt"></i> התחברות
        </button>
        <button id="switch-to-register" class="btn btn-success btn-lg" style="flex: 1;">
          <i class="fas fa-user-plus"></i> הרשמה
        </button>
      </div>

      <!-- כפתורי הרשמה -->
      <div id="register-actions" style="display: none; gap: 10px; margin-top: 20px;">
        <button id="register-btn" class="btn btn-success btn-lg" style="flex: 1;">
          <i class="fas fa-user-plus"></i> הרשמה
        </button>
        <button id="login-mode-btn" class="btn btn-outline btn-lg" style="flex: 1;">
          <i class="fas fa-arrow-right"></i> חזרה להתחברות
        </button>
      </div>
    </div>
  </div>

  <!-- אזור האפליקציה -->
  <div id="app-section" class="hidden">
    <!-- סרגל ניווט -->
    <div class="navbar">
      <div class="navbar-container">
        <div style="display: flex; align-items: center;">
          <div class="hamburger-menu" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <a href="#" class="navbar-brand">
            <i class="fas fa-tasks"></i> 
            ניהול פרויקטים
          </a>
        </div>
        <div class="navbar-nav" id="navbar-nav">
          <div class="nav-item">
            <a href="#" id="nav-projects" class="nav-link active">
              <i class="fas fa-project-diagram"></i> פרויקטים
            </a>
          </div>
          <div class="nav-item">
            <a href="#" id="nav-dashboard" class="nav-link">
              <i class="fas fa-tasks"></i> המשימות שלי
            </a>
          </div>
          <div class="nav-item">
            <a href="#" id="nav-stats" class="nav-link">
              <i class="fas fa-chart-bar"></i> סטטיסטיקות
            </a>
          </div>
          <div class="nav-item">
            <a href="#" id="nav-activity" class="nav-link">
              <i class="fas fa-history"></i> היסטוריית פעילות
            </a>
          </div>
          <div class="user-menu">
            <div class="user-menu-toggle">
              <div class="user-avatar" id="user-avatar"></div>
              <span id="user-email"></span>
              <i class="fas fa-angle-down"></i>
            </div>
            <div class="user-menu-dropdown">
              <a href="#" id="profile-btn" class="user-menu-item">
                <i class="fas fa-user"></i> הפרופיל שלי
              </a>
              <a href="#" id="settings-btn" class="user-menu-item">
                <i class="fas fa-cog"></i> הגדרות
              </a>
              <a href="#" id="logout-btn" class="user-menu-item logout">
                <i class="fas fa-sign-out-alt"></i> התנתק
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- תצוגת רשימת פרויקטים -->
      <div id="projects-view">
        <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2><i class="fas fa-project-diagram"></i> הפרויקטים שלי</h2>
          <button id="add-project-btn" class="btn btn-success">
            <i class="fas fa-plus"></i> פרויקט חדש
          </button>
        </div>

        <!-- אזור חיפוש -->
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="search-projects" placeholder="חיפוש פרויקטים לפי שם, תיאור או תגיות...">
        </div>

        <div class="tabs">
          <div class="tab active" data-filter="all">כל הפרויקטים</div>
          <div class="tab" data-filter="personal">פרויקטים אישיים</div>
          <div class="tab" data-filter="team">פרויקטים צוותיים</div>
        </div>

        <div id="projects-list" class="project-list">
          <!-- פרויקטים יוצגו כאן -->
          <div>טוען פרויקטים...</div>
        </div>
      </div>

      <!-- תצוגת דשבורד המשימות -->
      <div id="dashboard-view" class="hidden">
        <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2><i class="fas fa-tasks"></i> המשימות שלי</h2>
          <button id="export-tasks-btn" class="btn btn-outline">
            <i class="fas fa-file-export"></i> ייצוא משימות
          </button>
        </div>

        <!-- אזור חיפוש -->
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="search-tasks" placeholder="חיפוש משימות לפי שם, תיאור או תגיות...">
        </div>

        <div class="dashboard-filter" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
          <select id="dashboard-filter-project" class="form-control">
            <option value="all">כל הפרויקטים</option>
            <!-- אפשרויות יתווספו דינמית -->
          </select>
          <select id="dashboard-sort-by" class="form-control">
            <option value="deadline">מיון לפי תאריך</option>
            <option value="name">מיון לפי שם</option>
            <option value="project">מיון לפי פרויקט</option>
            <option value="status">מיון לפי סטטוס</option>
          </select>
          <select id="dashboard-filter-tag" class="form-control">
            <option value="all">כל התגיות</option>
            <!-- תגיות יתווספו דינמית -->
          </select>
          <select id="dashboard-filter-status" class="form-control">
            <option value="all">כל הסטטוסים</option>
            <option value="not-started">טרם התחילה</option>
            <option value="in-progress">בתהליך</option>
            <option value="waiting">ממתינה</option>
            <option value="blocked">תקועה</option>
            <option value="completed">הושלמה</option>
          </select>
        </div>

        <!-- דשבורד של כרטיסיות -->
        <div class="dashboard-grid">
          <!-- משימות לביצוע -->
          <div class="card dashboard-col-2">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-list-ul"></i> משימות לביצוע</h3>
            </div>
            <div class="card-body">
              <div id="dashboard-tasks" class="task-list">
                <!-- המשימות יוצגו כאן -->
              </div>
            </div>
          </div>

          <!-- בקשות עזרה -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-hands-helping"></i> בקשות עזרה
                <span class="badge" style="background-color: var(--warning); color: white;"><i class="fas fa-hands-helping"></i></span>
              </h3>
            </div>
            <div class="card-body">
              <div id="dashboard-help-tasks" class="task-list">
                <!-- בקשות העזרה יוצגו כאן -->
              </div>
            </div>
          </div>

          <!-- משימות שהושלמו -->
          <div class="card dashboard-col-2">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-check-circle"></i> משימות שהושלמו</h3>
            </div>
            <div class="card-body">
              <div id="dashboard-completed-tasks" class="task-list">
                <!-- המשימות שהושלמו יוצגו כאן -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- תצוגת סטטיסטיקות -->
      <div id="stats-view" class="hidden">
        <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2><i class="fas fa-chart-bar"></i> סטטיסטיקות</h2>
        </div>

        <div class="dashboard-grid">
          <!-- התקדמות פרויקטים -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-project-diagram"></i> התקדמות פרויקטים</h3>
            </div>
            <div class="card-body">
              <canvas id="projects-progress-chart" style="max-height: 250px;"></canvas>
            </div>
          </div>

          <!-- משימות לפי סטטוס -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-tasks"></i> משימות לפי סטטוס</h3>
            </div>
            <div class="card-body">
              <canvas id="tasks-by-status-chart" style="max-height: 250px;"></canvas>
            </div>
          </div>

          <!-- עומס משימות שבועי -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-calendar-alt"></i> עומס משימות שבועי</h3>
            </div>
            <div class="card-body">
              <canvas id="weekly-tasks-chart" style="max-height: 250px;"></canvas>
            </div>
          </div>

          <!-- התפלגות לפי תגיות -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-tags"></i> התפלגות לפי תגיות</h3>
            </div>
            <div class="card-body">
              <canvas id="tasks-by-tag-chart" style="max-height: 250px;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- תצוגת היסטוריית פעילות -->
      <div id="activity-view" class="hidden">
        <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2><i class="fas fa-history"></i> היסטוריית פעילות</h2>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-list"></i> רשימת פעילות</h3>
          </div>
          <div class="card-body">
            <ul id="activity-log" class="activity-log" style="list-style: none; padding: 0; margin: 0;">
              <!-- היסטוריית פעילות תוצג כאן -->
              <li style="padding: 12px; border-bottom: 1px solid #eee;">טוען היסטוריה...</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- תצוגת פרויקט ספציפי -->
      <div id="project-detail-view" class="hidden">
        <div class="card" style="margin-bottom: 20px;">
          <div class="card-body">
            <button id="back-to-projects" class="btn btn-outline" style="margin-bottom: 15px;">
              <i class="fas fa-arrow-right"></i> חזרה לרשימת הפרויקטים
            </button>

            <div id="project-detail" style="margin-top: 20px;">
              <!-- פרטי הפרויקט יוצגו כאן -->
            </div>
          </div>
        </div>

        <!-- גרף התקדמות הפרויקט -->
        <div class="card" style="margin-bottom: 20px;">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-chart-pie"></i> התקדמות הפרויקט</h3>
          </div>
          <div class="card-body" style="padding: 15px;">
            <canvas id="project-progress-chart" style="max-height: 250px;"></canvas>
          </div>
        </div>

        <!-- חברי צוות לפרויקט צוותי -->
        <div id="team-members-section" class="hidden" style="margin-bottom: 20px;">
          <div class="card">
            <div class="card-header">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title"><i class="fas fa-users"></i> חברי צוות</h3>
                <button id="add-member-btn" class="btn btn-success">
                  <i class="fas fa-user-plus"></i> הוסף חבר צוות
                </button>
              </div>
            </div>
            <div class="card-body">
              <div id="team-members-list" class="member-list">
                <!-- חברי צוות יוצגו כאן -->
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 class="card-title"><i class="fas fa-tasks"></i> משימות</h3>
              <div>
                <button id="add-task-btn" class="btn">
                  <i class="fas fa-plus"></i> הוסף משימה
                </button>
                <button id="add-help-request-btn" class="btn btn-warning">
                  <i class="fas fa-hands-helping"></i> בקשת עזרה
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="task-sort" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
              <select id="task-sort-by" class="form-control">
                <option value="createdAt-desc">חדש לישן</option>
                <option value="createdAt-asc">ישן לחדש</option>
                <option value="deadline-asc">תאריך הקרוב ביותר</option>
                <option value="name-asc">לפי שם (א-ת)</option>
                <option value="status-asc">לפי סטטוס</option>
              </select>
              <select id="task-filter-tag" class="form-control">
                <option value="all">כל התגיות</option>
                <!-- תגיות יתווספו דינמית -->
              </select>
              <select id="task-filter-status" class="form-control">
                <option value="all">כל הסטטוסים</option>
                <option value="not-started">טרם התחילה</option>
                <option value="in-progress">בתהליך</option>
                <option value="waiting">ממתינה</option>
                <option value="blocked">תקועה</option>
                <option value="completed">הושלמה</option>
              </select>
              <!-- פילטר לפי אחראי - רק לפרויקטים צוותיים -->
              <select id="task-filter-assignee" class="form-control hidden">
                <option value="all">כל האחראים</option>
                <option value="none">ללא אחראי</option>
                <!-- אפשרויות יתווספו דינמית -->
              </select>
            </div>

            <!-- תצוגת טאבים לפרויקט צוותי -->
            <div class="tabs hidden" id="task-view-tabs">
              <div class="tab active" data-view="list">תצוגת רשימה</div>
              <div class="tab" data-view="assignee">לפי אחראי</div>
            </div>

            <!-- תצוגת רשימת משימות -->
            <div id="tasks-list-view">
              <div id="tasks-list" class="task-list">
                <!-- משימות יוצגו כאן -->
              </div>
            </div>

            <!-- תצוגת משימות לפי אחראי -->
            <div id="tasks-by-assignee-view" class="hidden">
              <!-- משימות ללא אחראי - למעלה -->
              <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                  <h3 class="card-title"><i class="fas fa-user-slash"></i> משימות ללא אחראי</h3>
                </div>
                <div class="card-body">
                  <div id="unassigned-tasks-list" class="task-list">
                    <!-- משימות ללא אחראי יוצגו כאן -->
                  </div>
                </div>
              </div>

              <!-- משימות לפי אחראי -->
              <div id="tasks-by-assignee" class="tasks-by-assignee">
                <!-- משימות לפי אחראי יוצגו כאן -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- אזור פרופיל המשתמש -->
      <div id="profile-view" class="hidden">
        <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2><i class="fas fa-user"></i> הפרופיל שלי</h2>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-id-card"></i> פרטים אישיים</h3>
          </div>
          <div class="card-body">
            <div class="profile-header">
              <div class="profile-avatar" id="profile-avatar"></div>
              <div>
                <h3 class="profile-name" id="profile-name"></h3>
                <p class="profile-email" id="profile-email-display"></p>
              </div>
            </div>

            <div class="profile-form">
              <div class="form-group">
                <label for="profile-display-name">שם תצוגה:</label>
                <input type="text" id="profile-display-name">
              </div>

              <div style="margin-top: 20px;">
                <button id="save-profile-btn" class="btn btn-success">
                  <i class="fas fa-save"></i> שמור שינויים
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-chart-pie"></i> סיכום פעילות</h3>
          </div>
          <div class="card-body">
            <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div style="text-align: center; padding: 15px;">
                <div style="font-size: 30px; font-weight: bold; color: var(--primary);" id="profile-projects-count">0</div>
                <div style="color: #666;">פרויקטים</div>
              </div>
              <div style="text-align: center; padding: 15px;">
                <div style="font-size: 30px; font-weight: bold; color: var(--info);" id="profile-tasks-count">0</div>
                <div style="color: #666;">משימות</div>
              </div>
              <div style="text-align: center; padding: 15px;">
                <div style="font-size: 30px; font-weight: bold; color: var(--success);" id="profile-completed-count">0</div>
                <div style="color: #666;">הושלמו</div>
              </div>
              <div style="text-align: center; padding: 15px;">
                <div style="font-size: 30px; font-weight: bold; color: var(--warning);" id="profile-pending-count">0</div>
                <div style="color: #666;">ממתינות</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- אזור הגדרות -->
      <div id="settings-view" class="hidden">
        <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2><i class="fas fa-cog"></i> הגדרות</h2>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-bell"></i> התראות</h3>
          </div>
          <div class="card-body">
            <div class="settings-section">
              <div class="setting-option">
                <div>
                  <div class="setting-option-label">התראות על משימות קרובות</div>
                  <div class="setting-option-description">קבלת התראות על משימות שתאריך היעד שלהן מתקרב</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="setting-task-reminders" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <div class="setting-option">
                <div>
                  <div class="setting-option-label">התראות על משימות חדשות</div>
                  <div class="setting-option-description">קבלת התראות כאשר מישהו מוסיף אותך למשימה</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="setting-new-task-alerts" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <div class="setting-option">
                <div>
                  <div class="setting-option-label">הודעות צ'אט</div>
                  <div class="setting-option-description">קבלת התראות על הודעות חדשות בצ'אט המשימה</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="setting-chat-notifications" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <div class="settings-section">
              <div class="settings-title">תצוגה</div>

              <div class="setting-option">
                <div>
                  <div class="setting-option-label">מצב כהה</div>
                  <div class="setting-option-description">הפעלת מצב תצוגה כהה</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="setting-dark-mode">
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <div class="setting-option">
                <div>
                  <div class="setting-option-label">הצג משימות שהושלמו</div>
                  <div class="setting-option-description">הצגת משימות שהושלמו ברשימת המשימות</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="setting-show-completed" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <div style="margin-top: 20px;">
              <button id="save-settings-btn" class="btn btn-success">
                <i class="fas fa-save"></i> שמור הגדרות
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- מודל פרויקט -->
  <div id="project-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="project-modal-title" class="modal-title">פרויקט חדש</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="form-group">
        <label for="project-name">שם הפרויקט:</label>
        <input type="text" id="project-name" placeholder="הזן שם לפרויקט">
      </div>

      <div class="form-group">
      <label for="project-description">תיאור הפרויקט:</label>
        <textarea id="project-description" placeholder="הזן תיאור לפרויקט" rows="4"></textarea>
      </div>

      <div class="form-group">
        <label for="project-deadline">תאריך יעד:</label>
        <input type="date" id="project-deadline">
      </div>

      <div class="form-group">
        <label for="project-type">סוג פרויקט:</label>
        <select id="project-type">
          <option value="personal">פרויקט אישי</option>
          <option value="team">פרויקט צוותי</option>
        </select>
      </div>

      <input type="hidden" id="project-id">

      <div class="modal-footer">
        <button id="save-project-btn" class="btn btn-success">שמור</button>
        <button id="cancel-project-btn" class="btn btn-outline">ביטול</button>
      </div>
    </div>
  </div>

  <!-- מודל חבר צוות -->
  <div id="team-member-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">הוספת חבר צוות לפרויקט</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="form-group">
        <label id="member-email-label" for="member-email">חיפוש (אימייל או שם):</label>
        <input type="text" id="member-email" placeholder="הזן אימייל או שם של חבר צוות">
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          הזן לפחות 3 תווים כדי להתחיל בחיפוש
        </div>
      </div>

      <div id="member-search-results"></div>

      <div class="modal-footer">
        <button id="add-member-confirm-btn" class="btn btn-success" disabled>הוסף לפרויקט</button>
        <button id="cancel-member-btn" class="btn btn-outline">ביטול</button>
      </div>
    </div>
  </div>

  <!-- מודל צ'אט משימה -->
  <div id="task-chat-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="chat-task-name" class="modal-title">צ'אט משימה</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="task-chat" id="task-chat-messages" style="max-height: 350px; overflow-y: auto; padding: 15px; background-color: #f8f9fa; border-radius: var(--radius); margin-bottom: 15px;">
        <!-- הודעות צ'אט יוצגו כאן -->
        <div style="margin-bottom: 15px;">
          <div style="font-weight: 500;">מערכת</div>
          <div style="font-size: 12px; color: #666;">עכשיו</div>
          <div style="background-color: white; padding: 10px; border-radius: var(--radius); display: inline-block; margin-top: 5px;">ברוכים הבאים לצ'אט המשימה!</div>
        </div>
      </div>

      <div style="display: flex; gap: 10px;">
        <input type="text" id="chat-message" style="margin-bottom: 0;" placeholder="הקלד הודעה...">
        <button id="send-chat-message" class="btn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>

      <input type="hidden" id="chat-task-id">
    </div>
  </div>

  <!-- מודל משימה -->
  <div id="task-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="task-modal-title" class="modal-title">משימה חדשה</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="form-group">
        <label for="task-name">שם המשימה:</label>
        <input type="text" id="task-name" placeholder="הזן שם למשימה">
      </div>

      <div class="form-group">
        <label for="task-description">תיאור המשימה:</label>
        <textarea id="task-description" placeholder="הזן תיאור למשימה" rows="4"></textarea>
      </div>

      <!-- חדש: העלאת קבצים -->
      <div class="form-group">
        <label>קבצים מצורפים:</label>
        <div class="file-upload-container" id="file-upload-area">
          <i class="fas fa-cloud-upload-alt" style="font-size: 24px; color: var(--gray);"></i>
          <p>גרור קבצים לכאן או לחץ לבחירת קבצים</p>
          <input type="file" id="task-files" multiple style="display: none;">
        </div>
        <div class="file-preview" id="file-preview"></div>
      </div>

      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="task-deadline">תאריך יעד:</label>
            <input type="date" id="task-deadline">
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="task-status">סטטוס:</label>
            <select id="task-status">
              <option value="not-started">טרם התחילה</option>
              <option value="in-progress">בתהליך</option>
              <option value="waiting">ממתינה לאירוע/תאריך</option>
              <option value="blocked">תקועה</option>
              <option value="completed">הושלמה</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-group" id="task-blocked-reason-container" style="display: none;">
        <label for="task-blocked-reason">סיבת העיכוב:</label>
        <input type="text" id="task-blocked-reason" placeholder="הסבר מדוע המשימה תקועה">
      </div>

      <div class="form-group" id="task-waiting-for-container" style="display: none;">
        <label for="task-waiting-for">ממתינה ל:</label>
        <input type="text" id="task-waiting-for" placeholder="תאריך או אירוע שאליו המשימה ממתינה">
      </div>

      <div class="form-group" id="task-tags-container">
        <label for="task-tags">תגיות:</label>
        <div class="tags-input">
          <div id="task-tags-items"></div>
          <input type="text" id="task-tag-input" class="tag-input" placeholder="הוסף תגית ולחץ Enter">
        </div>
      </div>

      <div id="task-assignee-section" class="form-group hidden">
        <label for="task-assignee">שייך ל:</label>
        <select id="task-assignee">
          <option value="">לא משויך</option>
          <!-- אפשרויות חברי צוות יתווספו דינמית -->
        </select>
      </div>

      <div id="task-help-section" class="form-group hidden">
        <div class="form-group">
          <label>
            <input type="checkbox" id="task-help-request">
            בקשת עזרה צוותית
          </label>
        </div>
      </div>

      <input type="hidden" id="task-id">
      <input type="hidden" id="task-project-id">
      <input type="hidden" id="task-tags-hidden">

      <div class="modal-footer">
        <button id="save-task-btn" class="btn btn-success">שמור</button>
        <button id="cancel-task-btn" class="btn btn-outline">ביטול</button>
      </div>
    </div>
  </div>

  <!-- מודל ניהול משתמשים -->
  <div id="user-management-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ניהול משתמשים</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="form-group">
        <h4>הוספת משתמש מורשה</h4>
        <label for="authorized-email">אימייל:</label>
        <input type="email" id="authorized-email" placeholder="הזן אימייל של משתמש">
        <button id="add-authorized-btn" class="btn btn-success">הוסף משתמש מורשה</button>
      </div>

      <div style="margin-top: 20px;">
        <h4>רשימת משתמשים מורשים</h4>
        <div id="authorized-users-list" class="user-management-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: var(--radius);">
          <div>טוען משתמשים...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- מודל בקשות הרשמה -->
  <div id="pending-registrations-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">בקשות הרשמה ממתינות</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div id="pending-registrations-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: var(--radius); margin-bottom: 20px;">
        <div>טוען בקשות הרשמה...</div>
      </div>

      <div class="modal-footer">
        <button id="close-registrations-btn" class="btn btn-outline">סגור</button>
      </div>
    </div>
  </div>

  <!-- ספריות Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-storage-compat.js"></script>

  <!-- ספריית Chart.js לגרפים -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script>
    // תצורת Firebase
    // משתנים גלובליים
    let auth;
    let db;
    let storage;
    let charts = {}; // אחסון של אובייקטי הגרפים

    // פונקציה לטעינת תצורת Firebase מהשרת
    function initializeFirebase() {
      showLoader();

      fetch('/api/firebase-config')
        .then(response => {
          if (!response.ok) {
            throw new Error('בעיה בטעינת תצורת Firebase: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          console.log('תצורת Firebase נטענה בהצלחה');

          // שמירת אימייל האדמין מהתשובה
          adminEmail = data.adminEmail;

          // אתחול Firebase עם תצורה שהתקבלה
          firebase.initializeApp(data.firebaseConfig);

          // קיצורי דרך לשירותים
          auth = firebase.auth();
          db = firebase.firestore();
          storage = firebase.storage();

          // מעקב אחר התחברות המשתמש
          startAuthListener();
        })
        .catch(error => {
          console.error('שגיאה בטעינת תצורת Firebase:', error);
          document.getElementById('auth-error').textContent = 'שגיאה בטעינת הגדרות האפליקציה: ' + error.message;
          document.getElementById('auth-error').style.display = 'block';
          hideLoader();
        });
    }

    // פונקציה למעקב אחר מצב התחברות המשתמש
    function startAuthListener() {
      auth.onAuthStateChanged(user => {
        if (user) {
          // המשתמש מחובר - נבדוק אם הוא מורשה
          showLoader();

          // אם זה המנהל, אפשר לו גישה ישירה
          if (user.email === adminEmail) {
            // המשתמש הוא המנהל
            currentUser = {
              uid: user.uid,
              email: user.email,
              isAdmin: true
            };

            // עדכון ממשק המשתמש
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').textContent = user.email.charAt(0).toUpperCase();

            // עדכון תפריט למנהל
            updateUserMenuForAdmin();

            // שמירת המידע על המשתמש אם עוד לא קיים
                ensureUserIsRegistered(user.email, user.uid, true);

                // טעינת הפרויקטים של המשתמש
                loadProjects();
                hideLoader();
              } else {
                // בדיקת סטטוס המשתמש
                db.collection('users').doc(user.uid).get()
                  .then(doc => {
                    if (doc.exists) {
                      const userData = doc.data();

                      if (userData.status === 'approved') {
                        // המשתמש מאושר
                        currentUser = {
                          uid: user.uid,
                          email: user.email,
                          displayName: userData.displayName || user.email.split('@')[0],
                          isAdmin: false
                        };

                        // עדכון ממשק המשתמש
                        document.getElementById('auth-section').classList.add('hidden');
                        document.getElementById('app-section').classList.remove('hidden');
                        document.getElementById('user-email').textContent = currentUser.displayName;
                        document.getElementById('user-avatar').textContent = (currentUser.displayName.charAt(0) || "?").toUpperCase();

                        // טעינת הפרויקטים של המשתמש
                        loadProjects();
                      } else if (userData.status === 'pending') {
                        // המשתמש ממתין לאישור
                        document.getElementById('auth-error').textContent = 'החשבון שלך ממתין לאישור מנהל המערכת. נסה שוב מאוחר יותר.';
                        document.getElementById('auth-error').style.display = 'block';

                        // ניתוק המשתמש
                        auth.signOut();
                      } else if (userData.status === 'rejected') {
                        // המשתמש נדחה
                        document.getElementById('auth-error').textContent = 'בקשת ההרשמה שלך נדחתה על ידי מנהל המערכת.';
                        document.getElementById('auth-error').style.display = 'block';

                        // ניתוק המשתמש
                        auth.signOut();
                      }
                    } else {
                      // אין מידע על המשתמש - יצירת רשומה עם סטטוס ממתין
                      return db.collection('users').doc(user.uid).set({
                        userId: user.uid,
                        email: user.email,
                        displayName: user.email.split('@')[0],
                        isAdmin: false,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                      }).then(() => {
                        document.getElementById('auth-error').textContent = 'החשבון שלך ממתין לאישור מנהל המערכת. נסה שוב מאוחר יותר.';
                        document.getElementById('auth-error').style.display = 'block';

                        // ניתוק המשתמש
                        auth.signOut();
                      });
                    }
                    hideLoader();
                  })
                  .catch(error => {
                    hideLoader();
                    console.error("Error checking user status:", error);
                    document.getElementById('auth-error').textContent = 'שגיאה בבדיקת הרשאות: ' + error.message;
                    document.getElementById('auth-error').style.display = 'block';

                    // ניתוק המשתמש במקרה של שגיאה
                    auth.signOut();
                  });
              }
            } else {
              // המשתמש לא מחובר
              currentUser = null;
              document.getElementById('auth-section').classList.remove('hidden');
              document.getElementById('app-section').classList.add('hidden');
              document.getElementById('auth-error').style.display = 'none';
              hideLoader();
            }
          });
        }

        // משתנים גלובליים
        let adminEmail = null;
        let currentUser = null;
        let currentProjectId = null;
        let currentProjectData = null;
        let currentProjectMembers = [];
        let currentFilter = "all";
        let allTags = new Set();
        let allProjects = [];
        let userDashboardTasks = [];
        let currentTaskView = "list"; // מצב תצוגת המשימות: "list" או "assignee"
        let uploadedFiles = []; // מערך לאחסון הקבצים שהועלו
        let userSettings = {
          taskReminders: true,
          newTaskAlerts: true,
          chatNotifications: true,
          darkMode: false,
          showCompleted: true
        };

        // מיפוי סטטוסים
        const statusLabels = {
          'not-started': 'טרם התחילה',
          'in-progress': 'בתהליך',
          'waiting': 'ממתינה',
          'blocked': 'תקועה',
          'completed': 'הושלמה'
        };

        // הסתרת החלקים ב-DOM עד לקבלת סטטוס החיבור של המשתמש
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('app-section').classList.add('hidden');

        // הצגת והסתרת לוודר
        function showLoader() {
          document.getElementById('loader').classList.remove('hidden');
        }

        function hideLoader() {
          document.getElementById('loader').classList.add('hidden');
        }

        // אירועי לחיצה - אימות
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('switch-to-register').addEventListener('click', function() {
          document.getElementById('display-name-container').style.display = 'block';
          document.getElementById('login-actions').style.display = 'none';
          document.getElementById('register-actions').style.display = 'flex';
        });
        document.getElementById('login-mode-btn').addEventListener('click', function() {
          document.getElementById('display-name-container').style.display = 'none';
          document.getElementById('login-actions').style.display = 'flex';
          document.getElementById('register-actions').style.display = 'none';
        });
        document.getElementById('register-btn').addEventListener('click', register);
        document.getElementById('logout-btn').addEventListener('click', logout);

        // אירועי לחיצה - ניווט
        document.getElementById('nav-projects').addEventListener('click', function(e) {
          e.preventDefault();
          activateNavItem('nav-projects');
          showView('projects-view');
        });

        document.getElementById('nav-dashboard').addEventListener('click', function(e) {
          e.preventDefault();
          activateNavItem('nav-dashboard');
          showView('dashboard-view');
          loadDashboard();
        });

        document.getElementById('nav-stats').addEventListener('click', function(e) {
          e.preventDefault();
          activateNavItem('nav-stats');
          showView('stats-view');
          loadStats();
        });

        document.getElementById('nav-activity').addEventListener('click', function(e) {
          e.preventDefault();
          activateNavItem('nav-activity');
          showView('activity-view');
          loadActivityLog();
        });

        // סרגל ניווט למובייל
        document.getElementById('hamburger-menu').addEventListener('click', function() {
          const navbarNav = document.getElementById('navbar-nav');
          navbarNav.classList.toggle('active');
        });

        // Toggle user menu
        document.querySelector('.user-menu-toggle').addEventListener('click', function() {
          document.querySelector('.user-menu-dropdown').classList.toggle('show');
        });

        // פרופיל והגדרות
        document.getElementById('profile-btn').addEventListener('click', function(e) {
          e.preventDefault();
          showView('profile-view');
          document.querySelector('.user-menu-dropdown').classList.remove('show');
          loadUserProfile();
        });

        document.getElementById('settings-btn').addEventListener('click', function(e) {
          e.preventDefault();
          showView('settings-view');
          document.querySelector('.user-menu-dropdown').classList.remove('show');
          loadUserSettings();
        });

        // שמירת שינויים בפרופיל
        document.getElementById('save-profile-btn').addEventListener('click', saveUserProfile);

        // שמירת הגדרות
        document.getElementById('save-settings-btn').addEventListener('click', saveUserSettings);

        // עדכון הגדרות מצב כהה
        document.getElementById('setting-dark-mode').addEventListener('change', function() {
          toggleDarkMode(this.checked);
        });

        // Close user menu when clicking outside
        window.addEventListener('click', function(e) {
          if (!e.target.closest('.user-menu')) {
            const dropdown = document.querySelector('.user-menu-dropdown');
            if (dropdown.classList.contains('show')) {
              dropdown.classList.remove('show');
            }
          }
        });

        // חיפוש פרויקטים
        document.getElementById('search-projects').addEventListener('input', function() {
          const searchTerm = this.value.trim().toLowerCase();
          filterProjects(searchTerm);
        });

        // חיפוש משימות
        document.getElementById('search-tasks').addEventListener('input', function() {
          const searchTerm = this.value.trim().toLowerCase();
          filterDashboardTasks(searchTerm);
        });

        // ייצוא משימות
        document.getElementById('export-tasks-btn').addEventListener('click', exportTasks);

        // אירועי לחיצה - פרויקטים
        document.getElementById('add-project-btn').addEventListener('click', showAddProjectModal);
        document.getElementById('save-project-btn').addEventListener('click', saveProject);
        document.getElementById('cancel-project-btn').addEventListener('click', () => {
          document.getElementById('project-modal').style.display = 'none';
        });

        // אירועי לחיצה - חברי צוות
        document.getElementById('add-member-btn').addEventListener('click', showAddMemberModal);
        document.getElementById('add-member-confirm-btn').addEventListener('click', addMemberToProject);
        document.getElementById('cancel-member-btn').addEventListener('click', () => {
          document.getElementById('team-member-modal').style.display = 'none';
        });

        // אירועי לחיצה - חיפוש חברי צוות לפי הקלדה
        document.getElementById('member-email').addEventListener('input', searchUserByEmailOrName);

        // אירועי לחיצה - משימות
        document.getElementById('add-task-btn').addEventListener('click', () => showAddTaskModal(false));
        document.getElementById('add-help-request-btn').addEventListener('click', () => showAddTaskModal(true));
        document.getElementById('save-task-btn').addEventListener('click', saveTask);
        document.getElementById('cancel-task-btn').addEventListener('click', () => {
          document.getElementById('task-modal').style.display = 'none';
        });

        // אירועי צ'אט משימה
        document.getElementById('send-chat-message').addEventListener('click', sendChatMessage);
        document.getElementById('chat-message').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            sendChatMessage();
          }
        });

        // טיפול בגרירת והעלאת קבצים
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('task-files');

        fileUploadArea.addEventListener('click', () => {
          fileInput.click();
        });

        fileUploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          fileUploadArea.style.borderColor = 'var(--primary)';
        });

        fileUploadArea.addEventListener('dragleave', () => {
          fileUploadArea.style.borderColor = '#ddd';
        });

        fileUploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          fileUploadArea.style.borderColor = '#ddd';

          if (e.dataTransfer.files.length > 0) {
            handleFiles(e.dataTransfer.files);
          }
        });

        fileInput.addEventListener('change', () => {
          if (fileInput.files.length > 0) {
            handleFiles(fileInput.files);
          }
        });

        // אירוע לתגיות
        document.getElementById('task-tag-input').addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && this.value.trim() !== '') {
            e.preventDefault();
            addTag(this.value.trim());
            this.value = '';
          }
        });

        // אירוע לשינוי סטטוס משימה
        document.getElementById('task-status').addEventListener('change', function() {
          const status = this.value;
          const blockedContainer = document.getElementById('task-blocked-reason-container');
          const waitingContainer = document.getElementById('task-waiting-for-container');

          // הסתרה/הצגה של השדות המותנים בסטטוס
          blockedContainer.style.display = (status === 'blocked') ? 'block' : 'none';
          waitingContainer.style.display = (status === 'waiting') ? 'block' : 'none';
        });

        // סגירת מודלים בX
        document.querySelectorAll('.modal-close').forEach(close => {
          close.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
          });
        });

        // אירועי סינון דשבורד
        document.getElementById('dashboard-filter-project').addEventListener('change', filterDashboardTasks);
        document.getElementById('dashboard-sort-by').addEventListener('change', filterDashboardTasks);
        document.getElementById('dashboard-filter-tag').addEventListener('change', filterDashboardTasks);
        document.getElementById('dashboard-filter-status').addEventListener('change', filterDashboardTasks);

        // אירועי מיון משימות בפרויקט
        document.getElementById('task-sort-by').addEventListener('change', function() {
          loadTasks(currentProjectId);
        });

        document.getElementById('task-filter-tag').addEventListener('change', function() {
          loadTasks(currentProjectId);
        });

        document.getElementById('task-filter-status').addEventListener('change', function() {
          loadTasks(currentProjectId);
        });

        document.getElementById('task-filter-assignee').addEventListener('change', function() {
          if (currentTaskView === "list") {
            loadTasks(currentProjectId);
          } else {
            displayTasksByAssignee();
          }
        });

        // אירוע חזרה לרשימת פרויקטים
        document.getElementById('back-to-projects').addEventListener('click', () => {
          showView('projects-view');
          activateNavItem('nav-projects');
        });

        // אירועי טאבים לסינון פרויקטים
        document.querySelectorAll('.tabs .tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            // בדיקה אם זה לא טאבים של תצוגת משימות
            if (!e.target.closest('#task-view-tabs')) {
              document.querySelectorAll('.tabs .tab:not([data-view])').forEach(t => {
                t.classList.remove('active');
              });
              e.target.classList.add('active');
              currentFilter = e.target.dataset.filter;
              loadProjects();
            }
          });
        });

        // אירוע חלופות תצוגת משימות (רשימה / לפי אחראי)
        document.addEventListener('click', function(e) {
          if (e.target.classList.contains('tab') && e.target.closest('#task-view-tabs')) {
            // הסרת הסימון מכל הטאבים
            e.target.closest('#task-view-tabs').querySelectorAll('.tab').forEach(tab => {
              tab.classList.remove('active');
            });

            // הוספת סימון לטאב הנוכחי
            e.target.classList.add('active');

            // שינוי תצוגת המשימות
            // שינוי תצוגת המשימות
            const view = e.target.dataset.view;
            currentTaskView = view;

            if (view === 'list') {
              document.getElementById('tasks-list-view').classList.remove('hidden');
              document.getElementById('tasks-by-assignee-view').classList.add('hidden');
              loadTasks(currentProjectId);
            } else if (view === 'assignee') {
              document.getElementById('tasks-list-view').classList.add('hidden');
              document.getElementById('tasks-by-assignee-view').classList.remove('hidden');
              displayTasksByAssignee();
            }
          }
        });

        // פונקציה להצגת מודל בקשות הרשמה ממתינות
        function showPendingRegistrationsModal() {
          // בדוק הרשאות מנהל
          if (!currentUser || !currentUser.isAdmin) {
            alert('רק למנהל המערכת יש הרשאה לניהול בקשות הרשמה');
            return;
          }

          // הצג את המודל
          document.getElementById('pending-registrations-modal').style.display = 'block';

          // טען את רשימת בקשות ההרשמה הממתינות
          loadPendingRegistrations();
        }

        // פונקציה לטעינת בקשות הרשמה ממתינות
        function loadPendingRegistrations() {
          const pendingList = document.getElementById('pending-registrations-list');
          pendingList.innerHTML = 'טוען בקשות הרשמה...';

          db.collection('users')
            .where('status', '==', 'pending')
            .get()
            .then(snapshot => {
              if (snapshot.empty) {
                pendingList.innerHTML = '<div class="p-4">אין בקשות הרשמה ממתינות.</div>';
                return;
              }

              let pendingHTML = '';

              snapshot.forEach(doc => {
                const userData = doc.data();

                pendingHTML += `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                    <div>
                      <strong>${userData.email}</strong>
                      <div style="font-size: 12px; color: #666;">
                        נרשם: ${userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleString() : 'לא ידוע'}
                      </div>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-success approve-user-btn" data-id="${doc.id}" data-email="${userData.email}">
                        <i class="fas fa-check"></i> אשר
                      </button>
                      <button class="btn btn-sm btn-danger reject-user-btn" data-id="${doc.id}" data-email="${userData.email}">
                        <i class="fas fa-times"></i> דחה
                      </button>
                    </div>
                  </div>
                `;
              });

              pendingList.innerHTML = pendingHTML;

              // הוסף מאזינים לכפתורים
              pendingList.querySelectorAll('.approve-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                  const userId = this.getAttribute('data-id');
                  const userEmail = this.getAttribute('data-email');
                  approveUserRegistration(userId, userEmail);
                });
              });

              pendingList.querySelectorAll('.reject-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                  const userId = this.getAttribute('data-id');
                  const userEmail = this.getAttribute('data-email');
                  rejectUserRegistration(userId, userEmail);
                });
              });
            })
            .catch(error => {
              console.error("Error loading pending registrations:", error);
              pendingList.innerHTML = '<div style="color: var(--danger);">שגיאה בטעינת בקשות הרשמה: ' + error.message + '</div>';
            });
        }

        // פונקציה לעדכון תפריט המשתמש בהתאם לסוג המשתמש
        function updateUserMenuForAdmin() {
          if (currentUser && currentUser.isAdmin) {
            const userMenu = document.querySelector('.user-menu-dropdown');
            if (userMenu) {
              // מחיקת כל פריטי התפריט של המנהל קודם, למניעת כפילויות
              const existingAdminItems = userMenu.querySelectorAll('.admin-menu-item');
              existingAdminItems.forEach(item => item.remove());
              
              // הוסף ניהול בקשות הרשמה
              const pendingRequestsItem = document.createElement('a');
              pendingRequestsItem.href = '#';
              pendingRequestsItem.className = 'user-menu-item admin-menu-item';
              pendingRequestsItem.innerHTML = '<i class="fas fa-user-clock"></i> בקשות הרשמה ממתינות';
              pendingRequestsItem.addEventListener('click', showPendingRegistrationsModal);

              // הוסף לתפריט לפני פריט ההתנתקות
              const logoutItem = userMenu.querySelector('#logout-btn');
              if (logoutItem) {
                userMenu.insertBefore(pendingRequestsItem, logoutItem);
              } else {
                userMenu.appendChild(pendingRequestsItem);
              }
            }
          }
        }

        // פונקציה לשינוי תצוגה פעילה
        function showView(viewId) {
          // הסתרת כל התצוגות
          const views = [
            'projects-view', 
            'dashboard-view', 
            'stats-view', 
            'activity-view', 
            'project-detail-view',
            'profile-view',
            'settings-view'
          ];
          
          views.forEach(view => {
            document.getElementById(view).classList.add('hidden');
          });
          
          // הצגת התצוגה הנבחרת
          document.getElementById(viewId).classList.remove('hidden');
        }

        // פונקציה להפעלת פריט ניווט
        function activateNavItem(navId) {
          // הסרת הסימון מכל פריטי הניווט
          document.querySelectorAll('.nav-link').forEach(item => {
            item.classList.remove('active');
          });
          
          // הוספת סימון לפריט הנבחר
          document.getElementById(navId).classList.add('active');
        }

        // פונקציה לאישור משתמש
        function approveUserRegistration(userId, userEmail) {
          if (confirm(`האם אתה בטוח שברצונך לאשר את המשתמש ${userEmail}?`)) {
            showLoader();

            db.collection('users').doc(userId).update({
              status: 'approved',
              approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
              approvedBy: currentUser.uid
            })
            .then(() => {
              hideLoader();
              showNotification('משתמש אושר', `המשתמש ${userEmail} אושר בהצלחה`, 'success');
              loadPendingRegistrations(); // רענון הרשימה
            })
            .catch(error => {
              hideLoader();
              console.error("Error approving user:", error);
              showNotification('שגיאה', 'שגיאה באישור המשתמש: ' + error.message, 'danger');
            });
          }
        }

        // פונקציה לדחיית משתמש
        function rejectUserRegistration(userId, userEmail) {
          if (confirm(`האם אתה בטוח שברצונך לדחות את המשתמש ${userEmail}?`)) {
            showLoader();

            db.collection('users').doc(userId).update({
              status: 'rejected',
              rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
              rejectedBy: currentUser.uid
            })
            .then(() => {
              hideLoader();
              showNotification('משתמש נדחה', `המשתמש ${userEmail} נדחה בהצלחה`, 'warning');
              loadPendingRegistrations(); // רענון הרשימה
            })
            .catch(error => {
              hideLoader();
              console.error("Error rejecting user:", error);
              showNotification('שגיאה', 'שגיאה בדחיית המשתמש: ' + error.message, 'danger');
            });
          }
        }
        
        // וידוא שהמשתמש רשום במערכת
        function ensureUserIsRegistered(email, uid, isAdmin = false) {
          // בדיקה שהמשתמש כבר רשום במערכת
          db.collection('users').doc(uid).get()
            .then(doc => {
              if (!doc.exists) {
                // הוספת המשתמש למערכת
                return db.collection('users').doc(uid).set({
                  userId: uid,
                  email: email,
                  displayName: email.split('@')[0],
                  isAdmin: isAdmin,
                  status: 'approved',
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  settings: userSettings
                });
              } else if (isAdmin && !doc.data().isAdmin) {
                // עדכון המשתמש כמנהל אם צריך
                return db.collection('users').doc(uid).update({
                  isAdmin: true,
                  status: 'approved'
                });
              }
            })
            .catch(error => {
              console.error("Error checking user:", error);
            });
        }

        // פונקציות אימות
        function login() {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          if (!email || !password) {
            showAuthError('אנא הזן אימייל וסיסמה');
            return;
          }

          showLoader();
          auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
              hideLoader();
              console.error("Login error:", error);
              showAuthError('שגיאה בהתחברות: ' + error.message);
            });
        }

        function register() {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          const displayName = document.getElementById('display-name').value.trim();

          if (!email || !password) {
            showAuthError('אנא הזן אימייל וסיסמה');
            return;
          }

          if (password.length < 6) {
            showAuthError('הסיסמה חייבת להכיל לפחות 6 תווים');
            return;
          }

          if (!displayName) {
            showAuthError('אנא הזן כינוי משתמש');
            return;
          }

          showLoader();

          // בדיקה אם האימייל הוא המנהל
          if (email === adminEmail) {
            // זהו המנהל - אפשר לו להירשם ישירות
            auth.createUserWithEmailAndPassword(email, password)
              .then(userCredential => {
                const user = userCredential.user;

                // יצירת רשומת משתמש מנהל בדאטאבייס
                return db.collection('users').doc(user.uid).set({
                  userId: user.uid,
                  email: email,
                  displayName: displayName,
                  isAdmin: true,
                  status: 'approved',
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  settings: userSettings
                });
              })
              .then(() => {
                hideLoader();
                // המשתמש יעבור אוטומטית למסך הבא דרך מאזין האימות
              })
              .catch(error => {
                hideLoader();
                console.error("Registration error:", error);
                showAuthError('שגיאה בהרשמה: ' + error.message);
              });
          } else {
            // רישום משתמש רגיל
            auth.createUserWithEmailAndPassword(email, password)
              .then(userCredential => {
                const user = userCredential.user;

                // שמירת המידע על המשתמש עם סטטוס "ממתין לאישור"
                return db.collection('users').doc(user.uid).set({
                  userId: user.uid,
                  email: email,
                  displayName: displayName,
                  isAdmin: false,
                  status: 'pending',
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  settings: userSettings
                });
              })
              .then(() => {
                hideLoader();
                alert('נרשמת בהצלחה! הבקשה שלך ממתינה לאישור המנהל. תנותק מהמערכת עד לאישור.');
                // התנתקות אוטומטית עד לאישור
                return auth.signOut();
              })
              .catch(error => {
                hideLoader();
                console.error("Registration error:", error);
                showAuthError('שגיאה בהרשמה: ' + error.message);
              });
          }
        }

        function logout() {
          showLoader();
          auth.signOut()
            .catch(error => {
              hideLoader();
              console.error("Logout error:", error);
            });
        }

        function showAuthError(message) {
          const errorElement = document.getElementById('auth-error');
          errorElement.textContent = message;
          errorElement.style.display = 'block';
        }

        // פונקציה לטעינת פרופיל המשתמש
        function loadUserProfile() {
          if (!currentUser) return;
          
          showLoader();
          
          // הצגת הפרטים הידועים
          document.getElementById('profile-name').textContent = currentUser.displayName || currentUser.email.split('@')[0];
          document.getElementById('profile-email-display').textContent = currentUser.email;
          document.getElementById('profile-avatar').textContent = (currentUser.displayName ? currentUser.displayName.charAt(0) : currentUser.email.charAt(0)).toUpperCase();
          document.getElementById('profile-display-name').value = currentUser.displayName || '';
          
          // טעינת סטטיסטיקות
          Promise.all([
            // ספירת פרויקטים
            db.collection('projects')
              .where('userId', '==', currentUser.uid)
              .get(),
              
            // ספירת משימות
            db.collection('tasks')
              .where('assigneeId', '==', currentUser.uid)
              .get()
          ])
          .then(([projectsSnapshot, tasksSnapshot]) => {
            // עדכון סטטיסטיקות
            document.getElementById('profile-projects-count').textContent = projectsSnapshot.size;
            
            const tasks = tasksSnapshot.docs;
            document.getElementById('profile-tasks-count').textContent = tasks.length;
            
            const completedTasks = tasks.filter(doc => doc.data().status === 'completed').length;
            document.getElementById('profile-completed-count').textContent = completedTasks;
            
            const pendingTasks = tasks.filter(doc => doc.data().status !== 'completed').length;
            document.getElementById('profile-pending-count').textContent = pendingTasks;
            
            hideLoader();
          })
          .catch(error => {
            console.error("Error loading profile stats:", error);
            hideLoader();
          });
        }

        // פונקציה לשמירת פרופיל המשתמש
        function saveUserProfile() {
          if (!currentUser) return;
          
          const displayName = document.getElementById('profile-display-name').value.trim();
          
          if (!displayName) {
            showNotification('שגיאה', 'אנא הזן שם תצוגה', 'warning');
            return;
          }
          
          showLoader();
          
          db.collection('users').doc(currentUser.uid).update({
            displayName: displayName,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => {
            // עדכון המידע בזיכרון
            currentUser.displayName = displayName;
            
            // עדכון תצוגה
            document.getElementById('user-email').textContent = displayName;
            document.getElementById('user-avatar').textContent = displayName.charAt(0).toUpperCase();
            document.getElementById('profile-name').textContent = displayName;
            document.getElementById('profile-avatar').textContent = displayName.charAt(0).toUpperCase();
            
            hideLoader();
            showNotification('פרופיל עודכן', 'הפרופיל שלך עודכן בהצלחה', 'success');
          })
          .catch(error => {
            console.error("Error updating profile:", error);
            hideLoader();
            showNotification('שגיאה', 'שגיאה בעדכון פרופיל: ' + error.message, 'danger');
          });
        }

        // פונקציה לטעינת הגדרות המשתמש
        function loadUserSettings() {
          if (!currentUser) return;
          
          showLoader();
          
          db.collection('users').doc(currentUser.uid).get()
            .then(doc => {
              if (doc.exists && doc.data().settings) {
                // עדכון הגדרות גלובליות
                userSettings = doc.data().settings;
                
                // עדכון ממשק
                document.getElementById('setting-task-reminders').checked = userSettings.taskReminders !== false;
                document.getElementById('setting-new-task-alerts').checked = userSettings.newTaskAlerts !== false;
                document.getElementById('setting-chat-notifications').checked = userSettings.chatNotifications !== false;
                document.getElementById('setting-dark-mode').checked = userSettings.darkMode === true;
                document.getElementById('setting-show-completed').checked = userSettings.showCompleted !== false;
                
                // החלת מצב כהה אם צריך
                if (userSettings.darkMode) {
                  toggleDarkMode(true);
                }
              }
              
              hideLoader();
            })
            .catch(error => {
              console.error("Error loading settings:", error);
              hideLoader();
            });
        }

        // פונקציה לשמירת הגדרות המשתמש
        function saveUserSettings() {
          if (!currentUser) return;
          
          // קריאת הגדרות מהממשק
          const updatedSettings = {
            taskReminders: document.getElementById('setting-task-reminders').checked,
            newTaskAlerts: document.getElementById('setting-new-task-alerts').checked,
            chatNotifications: document.getElementById('setting-chat-notifications').checked,
            darkMode: document.getElementById('setting-dark-mode').checked,
            showCompleted: document.getElementById('setting-show-completed').checked
          };
          
          showLoader();
          
          // שמירה בדאטאבייס
          db.collection('users').doc(currentUser.uid).update({
            settings: updatedSettings,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => {
            // עדכון הגדרות גלובליות
            userSettings = updatedSettings;
            
            hideLoader();
            showNotification('הגדרות נשמרו', 'ההגדרות שלך נשמרו בהצלחה', 'success');
          })
          .catch(error => {
            console.error("Error saving settings:", error);
            hideLoader();
            showNotification('שגיאה', 'שגיאה בשמירת הגדרות: ' + error.message, 'danger');
          });
        }

        // פונקציה להפעלת מצב כהה
        function toggleDarkMode(enable) {
          const root = document.documentElement;
          
          if (enable) {
            root.style.setProperty('--bg-light', '#1a1a2e');
            root.style.setProperty('--white', '#2a2a3c');
            root.style.setProperty('--dark', '#e1e1e1');
            root.style.setProperty('--light', '#2a2a3c');
            root.style.setProperty('--gray', '#a0a0a0');
            root.style.setProperty('--card-hover', '#2d2d45');
          } else {
            root.style.setProperty('--bg-light', '#f5f7fb');
            root.style.setProperty('--white', '#ffffff');
            root.style.setProperty('--dark', '#2b2d42');
            root.style.setProperty('--light', '#f8f9fa');
            root.style.setProperty('--gray', '#adb5bd');
            root.style.setProperty('--card-hover', '#f0f4ff');
          }
        }

        // חדש - הצגת התראה
        function showNotification(title, message, type = 'info') {
          const notificationsPanel = document.getElementById('notifications-panel');

          const notification = document.createElement('div');
          notification.className = 'notification';
          
          // קביעת צבע לפי סוג ההתראה
          let borderColor, bgColor;
          switch(type) {
            case 'success':
              borderColor = 'var(--success)';
              bgColor = 'rgba(11, 181, 160, 0.1)';
              break;
            case 'warning':
              borderColor = 'var(--warning)';
              bgColor = 'rgba(255, 158, 0, 0.1)';
              break;
            case 'danger':
              borderColor = 'var(--danger)';
              bgColor = 'rgba(230, 57, 70, 0.1)';
              break;
            default:
              borderColor = 'var(--primary)';
              bgColor = 'rgba(67, 97, 238, 0.1)';
          }
          
          notification.style.borderRight = `5px solid ${borderColor}`;
          notification.style.backgroundColor = bgColor;

          notification.innerHTML = `
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
          `;

          notificationsPanel.appendChild(notification);

          // הסרת ההתראה אחרי 5 שניות
          setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(-20px)';
            setTimeout(() => {
              notificationsPanel.removeChild(notification);
            }, 300);
          }, 5000);
        }

        // חדש - בדיקת תאריכי יעד
        function checkDeadlines() {
          if (!currentUser || !userSettings.taskReminders) return;

          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);

          const threeDay = new Date(today);
          threeDay.setDate(threeDay.getDate() + 3);

          // מצא משימות עם תאריך יעד קרוב
          db.collection('tasks')
            .where('assigneeId', '==', currentUser.uid)
            .where('status', '!=', 'completed')
            .get()
            .then(snapshot => {
              snapshot.forEach(doc => {
                const task = doc.data();

                if (task.deadline) {
                  const deadlineDate = new Date(task.deadline);
                  deadlineDate.setHours(0, 0, 0, 0);

                  if (deadlineDate.getTime() === tomorrow.getTime()) {
                    showNotification('תזכורת משימה', `המשימה "${task.name}" צריכה להסתיים מחר!`, 'warning');
                  } else if (deadlineDate.getTime() === today.getTime()) {
                    showNotification('תזכורת משימה', `המשימה "${task.name}" צריכה להסתיים היום!`, 'danger');
                  } else if (deadlineDate < today) {
                    showNotification('משימה באיחור', `המשימה "${task.name}" עברה את תאריך היעד!`, 'danger');
                  } else if (deadlineDate <= threeDay) {
                    showNotification('משימה מתקרבת', `נותרו פחות מ-3 ימים למשימה "${task.name}"`, 'info');
                  }
                }
              });
            });
        }

        // חדש - פונקציה לטיפול בקבצים שהועלו
        function handleFiles(files) {
          const filePreview = document.getElementById('file-preview');

          Array.from(files).forEach(file => {
            // בדיקת גודל הקובץ (מקסימום 10MB)
            if (file.size > 10 * 1024 * 1024) {
              showNotification('שגיאה', `הקובץ ${file.name} גדול מדי. מקסימום 10MB.`, 'danger');
              return;
            }

            // הוספה למערך הקבצים
            uploadedFiles.push(file);

            // תצוגה מקדימה
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';

            // קביעת אייקון לפי סוג הקובץ
            let icon = 'fa-file';
            if (file.type.startsWith('image/')) icon = 'fa-file-image';
            else if (file.type.startsWith('video/')) icon = 'fa-file-video';
            else if (file.type.startsWith('audio/')) icon = 'fa-file-audio';
            else if (file.type.includes('pdf')) icon = 'fa-file-pdf';
            else if (file.type.includes('word')) icon = 'fa-file-word';
            else if (file.type.includes('excel') || file.type.includes('sheet')) icon = 'fa-file-excel';

            fileItem.innerHTML = `
              <i class="fas ${icon}" style="margin-left: 5px;"></i>
              <span>${file.name}</span>
              <i class="fas fa-times file-delete" data-name="${file.name}"></i>
            `;

            filePreview.appendChild(fileItem);
          });

          // הוספת אירוע מחיקה
          document.querySelectorAll('.file-delete').forEach(deleteBtn => {
            deleteBtn.addEventListener('click', function() {
              const fileName = this.getAttribute('data-name');

              // הסרה מהמערך
              uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);

              // הסרה מהתצוגה
              this.closest('.file-item').remove();
            });
          });
        }

        // חדש - העלאת קבצים ל-Firebase Storage
        async function uploadTaskFiles(taskId) {
          if (!uploadedFiles.length) return [];

          const filesMetadata = [];

          for (const file of uploadedFiles) {
            try {
              // יצירת הפניה ייחודית בסטורג'
              const fileRef = storage.ref(`tasks/${taskId}/${Date.now()}_${file.name}`);

              // העלאת הקובץ
              const snapshot = await fileRef.put(file);

              // קבלת הURL של הקובץ
              const downloadURL = await snapshot.ref.getDownloadURL();

              filesMetadata.push({
                name: file.name,
                path: snapshot.ref.fullPath,
                type: file.type,
                size: file.size,
                url: downloadURL,
                uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            } catch (error) {
              console.error(`Error uploading file ${file.name}:`, error);
            }
          }

          // ניקוי מערך הקבצים המוחזקים זמנית
          uploadedFiles = [];
          document.getElementById('file-preview').innerHTML = '';

          return filesMetadata;
        }

        // חדש - טעינת קבצים של משימה
        function loadTaskFiles(taskId) {
          const filePreview = document.getElementById('file-preview');
          filePreview.innerHTML = '';

          db.collection('tasks').doc(taskId).get()
            .then(doc => {
              if (doc.exists) {
                const task = doc.data();

                if (task.files && task.files.length > 0) {
                  task.files.forEach(file => {
                    // קביעת אייקון לפי סוג הקובץ
                    let icon = 'fa-file';
                    if (file.type.startsWith('image/')) icon = 'fa-file-image';
                    else if (file.type.startsWith('video/')) icon = 'fa-file-video';
                    else if (file.type.startsWith('audio/')) icon = 'fa-file-audio';
                    else if (file.type.includes('pdf')) icon = 'fa-file-pdf';
                    else if (file.type.includes('word')) icon = 'fa-file-word';
                    else if (file.type.includes('excel') || file.type.includes('sheet')) icon = 'fa-file-excel';

                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                      <a href="${file.url}" target="_blank" style="display:flex; align-items:center; text-decoration:none; color:inherit;">
                        <i class="fas ${icon}" style="margin-left: 5px;"></i>
                        <span>${file.name}</span>
                      </a>
                      <i class="fas fa-times file-delete" data-id="${taskId}" data-path="${file.path}"></i>
                    `;

                    filePreview.appendChild(fileItem);
                  });

                  // הוספת אירוע מחיקה
                    document.querySelectorAll('.file-delete').forEach(deleteBtn => {
                      deleteBtn.addEventListener('click', function() {
                        const taskId = this.getAttribute('data-id');
                        const filePath = this.getAttribute('data-path');
  
                        if (confirm(`האם אתה בטוח שברצונך למחוק קובץ זה?`)) {
                          deleteTaskFile(taskId, filePath, this.closest('.file-item'));
                        }
                      });
                    });
                  } else {
                    filePreview.innerHTML = '<div style="color:#888;">אין קבצים מצורפים</div>';
                  }
                }
              })
              .catch(error => {
                console.error("Error loading task files:", error);
              });
          }
  
          // חדש - מחיקת קובץ של משימה
          function deleteTaskFile(taskId, filePath, fileElement) {
            showLoader();
  
            // מחיקת הקובץ מהסטורג'
            storage.ref(filePath).delete()
              .then(() => {
                // עדכון המשימה בפיירסטור
                return db.collection('tasks').doc(taskId).get()
                  .then(doc => {
                    if (doc.exists) {
                      const task = doc.data();
                      const updatedFiles = task.files.filter(file => file.path !== filePath);
  
                      return db.collection('tasks').doc(taskId).update({
                        files: updatedFiles
                      });
                    }
                  });
              })
              .then(() => {
                // הסרת האלמנט מהתצוגה
                if (fileElement) {
                  fileElement.remove();
                }
  
                hideLoader();
                showNotification('הקובץ נמחק', 'הקובץ נמחק בהצלחה', 'success');
  
                // אם אין קבצים נוספים, הוסף הודעה
                const filePreview = document.getElementById('file-preview');
                if (filePreview.children.length === 0) {
                  filePreview.innerHTML = '<div style="color:#888;">אין קבצים מצורפים</div>';
                }
  
                // רענון היסטוריית פעילות
                logActivity(`מחק קובץ מהמשימה`, taskId);
              })
              .catch(error => {
                hideLoader();
                console.error("Error deleting file:", error);
                showNotification('שגיאה', 'אירעה שגיאה במחיקת הקובץ', 'danger');
              });
          }
  
          // פונקציה לתיעוד פעילות
          function logActivity(action, objectId, details = null) {
            if (!currentUser) return Promise.resolve();
            
            const activityData = {
              userId: currentUser.uid,
              email: currentUser.email,
              displayName: currentUser.displayName || currentUser.email.split('@')[0],
              action: action,
              objectId: objectId,
              details: details,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            return db.collection('activity_log').add(activityData)
              .catch(error => {
                console.error("Error logging activity:", error);
              });
          }
  
          // פונקציה לטעינת היסטוריית פעילות
          function loadActivityLog() {
            const activityLog = document.getElementById('activity-log');
            activityLog.innerHTML = '<li style="padding: 12px; border-bottom: 1px solid #eee;">טוען היסטוריה...</li>';
  
            db.collection('activity_log')
              .orderBy('timestamp', 'desc')
              .limit(50)
              .get()
              .then(snapshot => {
                if (snapshot.empty) {
                  activityLog.innerHTML = '<li style="padding: 12px; border-bottom: 1px solid #eee;">אין פעילות להצגה</li>';
                  return;
                }
  
                activityLog.innerHTML = '';
  
                snapshot.forEach(doc => {
                  const activity = doc.data();
                  const date = activity.timestamp ? new Date(activity.timestamp.toDate()) : new Date();
                  const timeStr = date.toLocaleString('he-IL');
  
                  let actionIcon = '';
  
                  // התאמת אייקון לפעולה
                  switch(activity.action) {
                    case 'יצר פרויקט':
                      actionIcon = 'fa-project-diagram';
                      break;
                    case 'ערך פרויקט':
                      actionIcon = 'fa-edit';
                      break;
                    case 'מחק פרויקט':
                      actionIcon = 'fa-trash-alt';
                      break;
                    case 'יצר משימה':
                      actionIcon = 'fa-tasks';
                      break;
                    case 'ערך משימה':
                      actionIcon = 'fa-edit';
                      break;
                    case 'מחק משימה':
                      actionIcon = 'fa-trash-alt';
                      break;
                    case 'הוסיף חבר צוות':
                      actionIcon = 'fa-user-plus';
                      break;
                    case 'הסיר חבר צוות':
                      actionIcon = 'fa-user-minus';
                      break;
                    case 'העלה קובץ':
                      actionIcon = 'fa-file-upload';
                      break;
                    case 'מחק קובץ':
                      actionIcon = 'fa-file-excel';
                      break;
                    case 'השלים משימה':
                      actionIcon = 'fa-check-circle';
                      break;
                    default:
                      actionIcon = 'fa-history';
                  }
  
                  const activityItem = document.createElement('li');
                  activityItem.className = 'activity-item';
                  activityItem.style.padding = '12px';
                  activityItem.style.borderBottom = '1px solid #eee';
                  activityItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                      <span style="background-color: #f0f0f0; width: 28px; height: 28px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-left: 10px;">
                        <i class="fas ${actionIcon}"></i>
                      </span>
                      <div>
                        <strong>${activity.displayName}</strong> ${activity.action}
                        ${activity.details ? `<div style="margin-top: 5px; color: #666;">${activity.details}</div>` : ''}
                        <div><span style="color: #888; font-size: 12px;">${timeStr}</span></div>
                      </div>
                    </div>
                  `;
  
                  activityLog.appendChild(activityItem);
                });
              })
              .catch(error => {
                console.error("Error loading activity log:", error);
                activityLog.innerHTML = '<li style="padding: 12px; border-bottom: 1px solid #eee;">שגיאה בטעינת היסטוריה</li>';
              });
          }
  
          // פונקציות סטטיסטיקות וגרפים
          function loadStats() {
            showLoader();
  
            // מחיקת גרפים קיימים
            for (const chartId in charts) {
              if (charts[chartId]) {
                charts[chartId].destroy();
              }
            }
  
            Promise.all([
              loadProjectsProgressChart(),
              loadTasksByStatusChart(),
              loadWeeklyTasksChart(),
              loadTasksByTagChart()
            ])
              .then(() => {
                hideLoader();
              })
              .catch(error => {
                console.error("Error loading statistics:", error);
                hideLoader();
                showNotification('שגיאה', 'אירעה שגיאה בטעינת הסטטיסטיקות', 'danger');
              });
          }
  
          function loadProjectsProgressChart() {
            return db.collection('projects')
              .where('userId', '==', currentUser.uid)
              .get()
              .then(projectsSnapshot => {
                const projectIds = projectsSnapshot.docs.map(doc => doc.id);
  
                if (projectIds.length === 0) {
                  return [];
                }
  
                // קבלת משימות לכל פרויקט
                const projectPromises = projectIds.map(projectId => {
                  return db.collection('tasks')
                    .where('projectId', '==', projectId)
                    .get()
                    .then(tasksSnapshot => {
                      const totalTasks = tasksSnapshot.size;
                      const completedTasks = tasksSnapshot.docs.filter(doc => doc.data().status === 'completed').length;
                      const project = projectsSnapshot.docs.find(doc => doc.id === projectId).data();
  
                      return {
                        name: project.name,
                        progress: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0,
                        totalTasks
                      };
                    });
                });
  
                return Promise.all(projectPromises);
              })
              .then(projectProgress => {
                // מיון פרויקטים לפי כמות משימות (הגדולים ביותר קודם)
                projectProgress.sort((a, b) => b.totalTasks - a.totalTasks);
  
                // הגבלה ל-10 הפרויקטים הגדולים
                const topProjects = projectProgress.slice(0, 10);
  
                const ctx = document.getElementById('projects-progress-chart').getContext('2d');
  
                charts.projectsProgress = new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: topProjects.map(p => p.name),
                    datasets: [{
                      label: 'התקדמות באחוזים',
                      data: topProjects.map(p => p.progress),
                      backgroundColor: topProjects.map(p => {
                        // צבע לפי אחוז התקדמות
                        if (p.progress >= 75) return 'rgba(40, 167, 69, 0.7)';
                        if (p.progress >= 50) return 'rgba(23, 162, 184, 0.7)';
                        if (p.progress >= 25) return 'rgba(255, 193, 7, 0.7)';
                        return 'rgba(220, 53, 69, 0.7)';
                      }),
                      borderColor: 'rgba(0, 0, 0, 0.1)',
                      borderWidth: 1
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: false
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                          display: true,
                          text: 'אחוז התקדמות'
                        }
                      },
                      x: {
                        title: {
                          display: true,
                          text: 'פרויקטים'
                        }
                      }
                    }
                  }
                });
              });
          }
  
          function loadTasksByStatusChart() {
            return Promise.all([
              // משימות שהמשתמש אחראי עליהן
              db.collection('tasks')
                .where('assigneeId', '==', currentUser.uid)
                .get(),
  
              // משימות בפרויקטים אישיים
              db.collection('projects')
                .where('userId', '==', currentUser.uid)
                .where('type', '==', 'personal')
                .get()
                .then(projectsSnapshot => {
                  const projectIds = projectsSnapshot.docs.map(doc => doc.id);
                  if (projectIds.length === 0) return { docs: [] };
  
                  return db.collection('tasks')
                    .where('projectId', 'in', projectIds)
                    .get();
                })
            ])
              .then(([assignedTasks, personalTasks]) => {
                // איחוד המשימות למערך אחד
                const allTasks = [...assignedTasks.docs, ...personalTasks.docs];
  
                // ספירת משימות לפי סטטוס
                const statusCounts = {
                  'not-started': 0,
                  'in-progress': 0,
                  'waiting': 0,
                  'blocked': 0,
                  'completed': 0
                };
  
                allTasks.forEach(doc => {
                  const status = doc.data().status || 'not-started';
                  if (statusCounts[status] !== undefined) {
                    statusCounts[status]++;
                  }
                });
  
                const ctx = document.getElementById('tasks-by-status-chart').getContext('2d');
  
                charts.tasksByStatus = new Chart(ctx, {
                  type: 'doughnut',
                  data: {
                    labels: [
                      'טרם התחילה',
                      'בתהליך',
                      'ממתינה',
                      'תקועה',
                      'הושלמה'
                    ],
                    datasets: [{
                      data: [
                        statusCounts['not-started'],
                        statusCounts['in-progress'],
                        statusCounts['waiting'],
                        statusCounts['blocked'],
                        statusCounts['completed']
                      ],
                      backgroundColor: [
                        '#e9ecef',
                        '#4895ef',
                        '#ffc107',
                        '#dc3545',
                        '#28a745'
                      ]
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: 'right',
                        labels: {
                          boxWidth: 12
                        }
                      }
                    },
                    cutout: '60%'
                  }
                });
              });
          }
  
          function loadWeeklyTasksChart() {
            // יצירת תאריכים לשבוע
            const dates = [];
            const today = new Date();
  
            for (let i = 6; i >= 0; i--) {
              const date = new Date();
              date.setDate(today.getDate() - i);
              dates.push(date);
            }
  
            return Promise.all([
              // משימות שהמשתמש אחראי עליהן
              db.collection('tasks')
                .where('assigneeId', '==', currentUser.uid)
                .get(),
  
              // משימות בפרויקטים אישיים
              db.collection('projects')
                .where('userId', '==', currentUser.uid)
                .where('type', '==', 'personal')
                .get()
                .then(projectsSnapshot => {
                  const projectIds = projectsSnapshot.docs.map(doc => doc.id);
                  if (projectIds.length === 0) return { docs: [] };
  
                  return db.collection('tasks')
                    .where('projectId', 'in', projectIds)
                    .get();
                })
            ])
              .then(([assignedTasks, personalTasks]) => {
                // איחוד המשימות למערך אחד
                const allTasks = [...assignedTasks.docs, ...personalTasks.docs].map(doc => {
                  const data = doc.data();
                  return {
                    deadline: data.deadline,
                    status: data.status
                  };
                });
  
                // ארגון משימות לפי תאריך
                const tasksByDate = dates.map(date => {
                  const dateStr = date.toISOString().split('T')[0];
  
                  return {
                    date: dateStr,
                    label: new Intl.DateTimeFormat('he-IL', { weekday: 'short', day: 'numeric', month: 'numeric' }).format(date),
                    count: allTasks.filter(task => task.deadline === dateStr).length,
                    completed: allTasks.filter(task => task.deadline === dateStr && task.status === 'completed').length
                  };
                });
  
                const ctx = document.getElementById('weekly-tasks-chart').getContext('2d');
  
                charts.weeklyTasks = new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: tasksByDate.map(d => d.label),
                    datasets: [
                      {
                        label: 'סך משימות',
                        data: tasksByDate.map(d => d.count),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                      },
                      {
                        label: 'משימות שהושלמו',
                        data: tasksByDate.map(d => d.completed),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                      }
                    ]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                      y: {
                        beginAtZero: true,
                        title: {
                          display: true,
                          text: 'מספר משימות'
                        }
                      },
                      x: {
                        title: {
                          display: true,
                          text: 'תאריך'
                        }
                      }
                    }
                  }
                });
              });
          }
  
          function loadTasksByTagChart() {
            return Promise.all([
              // משימות שהמשתמש אחראי עליהן
              db.collection('tasks')
                .where('assigneeId', '==', currentUser.uid)
                .get(),
  
              // משימות בפרויקטים אישיים
              db.collection('projects')
                .where('userId', '==', currentUser.uid)
                .where('type', '==', 'personal')
                .get()
                .then(projectsSnapshot => {
                  const projectIds = projectsSnapshot.docs.map(doc => doc.id);
                  if (projectIds.length === 0) return { docs: [] };
  
                  return db.collection('tasks')
                    .where('projectId', 'in', projectIds)
                    .get();
                })
            ])
              .then(([assignedTasks, personalTasks]) => {
                // איחוד המשימות למערך אחד
                const allTasks = [...assignedTasks.docs, ...personalTasks.docs];
  
                // ספירת משימות לפי תגית
                const tagCounts = {};
  
                allTasks.forEach(doc => {
                  const tags = doc.data().tags || [];
                  tags.forEach(tag => {
                    if (!tagCounts[tag]) {
                      tagCounts[tag] = 0;
                    }
                    tagCounts[tag]++;
                  });
                });
  
                // מיון התגיות לפי שכיחות (הנפוצות ביותר קודם)
                const sortedTags = Object.entries(tagCounts)
                  .sort((a, b) => b[1] - a[1])
                  .slice(0, 10); // Top 10 tags
  
                const ctx = document.getElementById('tasks-by-tag-chart').getContext('2d');
  
                // יצירת צבעים אקראיים לתגיות
                const colors = sortedTags.map((_, index) => {
                  const hue = (index * 137) % 360; // פיזור צבעים
                  return `hsla(${hue}, 70%, 60%, 0.7)`;
                });
  
                charts.tasksByTag = new Chart(ctx, {
                  type: 'doughnut',
                  data: {
                    labels: sortedTags.map(tag => tag[0]),
                    datasets: [{
                      data: sortedTags.map(tag => tag[1]),
                      backgroundColor: colors,
                      borderWidth: 1
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: 'right',
                        labels: {
                          boxWidth: 12
                        }
                      }
                    },
                    cutout: '60%'
                  }
                });
              });
          }
  
          // חדש - ייצוא נתונים
          function exportTasks() {
            if (!userDashboardTasks || userDashboardTasks.length === 0) {
              showNotification('אין משימות לייצוא', 'לא נמצאו משימות לייצא', 'warning');
              return;
            }
  
            // בניית CSV
            let csvContent = 'שם משימה,פרויקט,תיאור,תאריך יעד,סטטוס,תגיות\n';
  
            userDashboardTasks.forEach(task => {
              const project = allProjects.find(p => p.id === task.data.projectId);
              const projectName = project ? project.data.name : '';
              const description = task.data.description ? task.data.description.replace(/,/g, ' ').replace(/\n/g, ' ') : '';
              const deadline = task.data.deadline || '';
              const status = statusLabels[task.data.status] || '';
              const tags = task.data.tags ? task.data.tags.join(';') : '';
  
              csvContent += `"${task.data.name}","${projectName}","${description}","${deadline}","${status}","${tags}"\n`;
            });
  
            // יצירת קובץ להורדה
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `משימות_${new Date().toLocaleDateString('he-IL')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
  
            showNotification('הייצוא הושלם', 'המשימות יוצאו בהצלחה לקובץ CSV', 'success');
  
            // רישום פעילות
            logActivity('ייצא משימות', currentUser.uid, `ייצא ${userDashboardTasks.length} משימות`);
          }
  
          // פונקציה להפעלה בטעינת הדף
          document.addEventListener('DOMContentLoaded', initializeFirebase);
      </script>
      </body>
      </html>
