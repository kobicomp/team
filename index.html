<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="注专转  驻专拽 砖转 转拽转">
  <meta name="theme-color" content="#4361ee">
  <title>注专转  驻专拽 转拽转</title>

  <!-- 住驻转 favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">

  <!-- 驻 -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- 住驻专转 爪转 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">

  <style>
    /* ========== 1. 专转 住住转 爪注 专 ========== */
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --primary-dark: #3a0ca3;
      --secondary: #4cc9f0;
      --success: #2ec4b6;
      --warning: #ff9f1c;
      --danger: #e63946;
      --info: #4cc9f0;
      --dark: #2b2d42;
      --light: #f8f9fa;
      --gray: #adb5bd;
      --white: #ffffff;
      --background: #f5f7fa;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Rubik', Arial, sans-serif;
      direction: rtl;
      margin: 0;
      padding: 0;
      background-color: var(--background);
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .hidden {
      display: none !important;
    }

    /* ========== 2. 驻专驻 ========== */
    h1, h2, h3, h4, h5, h6 {
      color: var(--dark);
      margin-top: 0;
      font-weight: 600;
      line-height: 1.3;
    }

    /* ========== 3. 专住转 专拽注 ========== */
    .card {
      background-color: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      padding: 24px;
      margin-bottom: 24px;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    /* ========== 4. 驻住 拽 ========== */
    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 15px;
      transition: all 0.2s;
      background-color: #f9fafc;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      background-color: white;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      font-size: 15px;
    }

    /* ========== 5. 驻转专 ========== */
    .btn {
      display: inline-block;
      border-radius: var(--radius-sm);
      padding: 10px 18px;
      font-weight: 500;
      transition: var(--transition);
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      letter-spacing: 0.3px;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
      color: var(--white);
      background-color: var(--primary);
    }

    .btn-lg {
      padding: 12px 24px;
      font-size: 16px;
      border-radius: var(--radius);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: var(--radius-sm);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      background-color: var(--primary-dark);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .btn-success {
      background-color: var(--success);
      background-image: linear-gradient(135deg, var(--success), #20a99b);
    }

    .btn-success:hover {
      background-color: #20a99b;
      background-image: linear-gradient(135deg, #20a99b, #19827a);
    }

    .btn-danger {
      background-color: var(--danger);
      background-image: linear-gradient(135deg, var(--danger), #d62839);
    }

    .btn-danger:hover {
      background-color: #d62839;
      background-image: linear-gradient(135deg, #d62839, #b21e2e);
    }

    .btn-warning {
      background-color: var(--warning);
      background-image: linear-gradient(135deg, var(--warning), #f2850d);
      color: #fff;
    }

    .btn-warning:hover {
      background-color: #f2850d;
      background-image: linear-gradient(135deg, #f2850d, #cf7108);
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      box-shadow: none;
    }

    .btn-outline:hover {
      background-color: var(--primary);
      color: white;
    }

    /* ========== 6. 住专  ========== */
    .navbar {
      background-color: var(--white);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .navbar-brand {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .navbar-nav {
      display: flex;
      align-items: center;
    }

    .nav-item {
      margin-right: 8px;
    }

    .nav-link {
      color: var(--dark);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
    }

    .nav-link:hover {
      color: var(--primary);
      background-color: rgba(67, 97, 238, 0.05);
    }

    .nav-link.active {
      color: var(--primary);
      background-color: rgba(67, 97, 238, 0.1);
      font-weight: 600;
    }

    .hamburger-menu {
      display: none;
      cursor: pointer;
      flex-direction: column;
      justify-content: space-between;
      width: 30px;
      height: 20px;
    }

    .hamburger-menu span {
      display: block;
      height: 3px;
      width: 100%;
      background-color: var(--dark);
      border-radius: 3px;
      transition: all 0.3s;
    }

    /* ========== 7. 住专 驻砖 ========== */
    .search-container {
      display: flex;
      margin-bottom: 24px;
      position: relative;
    }

    .search-container input {
      flex: 1;
      padding-left: 45px;
      margin-bottom: 0;
      height: 50px;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .search-container input:focus {
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
    }

    .search-container .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 18px;
    }

    /* ========== 8. 转专转 驻转专 驻注 砖专 ========== */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .dashboard-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .dashboard-filter select, .dashboard-filter input {
      margin-bottom: 0;
    }

    /* ========== 9.  ========== */
    .tabs {
      display: flex;
      margin-bottom: 24px;
      border-bottom: 1px solid #e9ecef;
      overflow-x: auto;
      white-space: nowrap;
      gap: 4px;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
      color: #5a5f69;
      transition: all 0.2s;
      position: relative;
      display: flex;
      align-items: center;
    }

    .tab:hover {
      color: var(--primary);
    }

    .tab.active {
      color: var(--primary);
      font-weight: 600;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, var(--primary), var(--primary-light));
      border-radius: 2px 2px 0 0;
    }

    /* ========== 10. 专砖转 驻专拽 ========== */
    .project-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
    }

    .project-card {
      border: none;
      border-radius: var(--radius);
      overflow: hidden;
      position: relative;
      transition: var(--transition);
      box-shadow: var(--shadow);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .project-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: 5px;
      background: linear-gradient(to bottom, var(--primary), var(--primary-light));
      border-radius: 5px 0 0 5px;
    }

    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    .project-card-content {
      padding: 20px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .project-card-title {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 20px;
      font-weight: 600;
      color: var(--dark);
    }

    .project-card-description {
      color: #5a5f69;
      margin-bottom: 15px;
      flex-grow: 1;
      line-height: 1.5;
    }

    .project-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }

    .project-type-indicator {
      position: absolute;
      top: 15px;
      left: 15px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .personal-project {
      background-color: rgba(46, 196, 182, 0.15);
      color: var(--success);
    }

    .team-project {
      background-color: rgba(76, 201, 240, 0.15);
      color: var(--secondary);
    }

    /* ========== 11. 转转 住 ========== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .badge-owner {
      background-color: rgba(255, 159, 28, 0.15);
      color: var(--warning);
    }

    .badge-member {
      background-color: rgba(76, 201, 240, 0.15);
      color: var(--secondary);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      background-color: #f0f2f5;
      color: #5a5f69;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      margin: 0 0 5px 5px;
    }

    .tag-blue {
      background-color: rgba(76, 201, 240, 0.15);
      color: #3183a1;
    }

    .tag-green {
      background-color: rgba(46, 196, 182, 0.15);
      color: var(--success);
    }

    .tag-red {
      background-color: rgba(230, 57, 70, 0.15);
      color: var(--danger);
    }

    .tag-yellow {
      background-color: rgba(255, 159, 28, 0.15);
      color: #cf7108;
    }

    .tag-purple {
      background-color: rgba(111, 66, 193, 0.15);
      color: #6f42c1;
    }

    .tag-cyan {
      background-color: rgba(23, 162, 184, 0.15);
      color: #17a2b8;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      margin-bottom: 15px;
    }

    .tag-item {
      display: flex;
      align-items: center;
      background-color: #e9ecef;
      padding: 3px 8px;
      border-radius: 16px;
      font-size: 12px;
    }

    .tag-close {
      margin-right: 5px;
      cursor: pointer;
    }

    .tag-input {
      flex-grow: 1;
      border: none;
      outline: none;
      padding: 5px;
      margin-bottom: 0;
    }

    /* ========== 12. 专砖转 砖转 ========== */
    .task-list {
      margin-top: 20px;
    }

    .task-item {
      border-radius: var(--radius);
      margin-bottom: 16px;
      padding: 16px;
      transition: var(--transition);
      border: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
      background-color: var(--white);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 15px;
    }

    .task-item:hover {
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }

    .task-item.completed {
      background-color: rgba(46, 196, 182, 0.05);
      border-right: 3px solid var(--success);
    }

    .task-item.help-request {
      background-color: rgba(255, 159, 28, 0.05);
      border-right: 3px solid var(--warning);
    }

    .task-content {
      flex-grow: 1;
    }

    .task-title {
      margin: 0 0 8px 0;
      font-weight: 600;
      font-size: 17px;
      color: var(--dark);
    }

    .task-description {
      color: #5a5f69;
      font-size: 14px;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
      font-size: 13px;
      color: #5a5f69;
    }

    .task-due-date {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .task-due-date.overdue {
      color: var(--danger);
      font-weight: 600;
    }

    .task-status {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      align-items: center;
      gap: 4px;
    }

    .status-not-started {
      background-color: rgba(173, 181, 189, 0.15);
      color: #5a5f69;
    }

    .status-in-progress {
      background-color: rgba(76, 201, 240, 0.15);
      color: #3183a1;
    }

    .status-completed {
      background-color: rgba(46, 196, 182, 0.15);
      color: var(--success);
    }

    .status-waiting {
      background-color: rgba(255, 159, 28, 0.15);
      color: #cf7108;
    }

    .status-blocked {
      background-color: rgba(230, 57, 70, 0.15);
      color: var(--danger);
    }

    .task-actions {
      display: flex;
      gap: 8px;
    }

    /* 驻转专 住住 专 */
    .quick-status-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .status-btn {
      font-size: 12px !important;
      padding: 3px 8px !important;
      border-radius: 12px !important;
      cursor: pointer;
      transition: all 0.2s;
      border: none !important;
    }

    .status-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* ========== 13. 专 专 爪转 ========== */
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
    }

    .assignee-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: var(--primary);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      margin-left: 5px;
    }

    /* 专 爪转 */
    .member-list {
      margin-top: 20px;
    }

    .member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: var(--radius);
      margin-bottom: 10px;
      transition: all 0.3s;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .member-item:hover {
      background-color: #e9ecef;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* 转驻专 砖转砖 */
    .user-menu {
      position: relative;
      cursor: pointer;
    }

    .user-menu-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
    }

    .user-menu-toggle:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }

    .user-menu-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background-color: var(--white);
      border-radius: var(--radius);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      padding: 10px 0;
      min-width: 220px;
      z-index: 1000;
      display: none;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .user-menu-item {
      padding: 10px 15px;
      display: flex;
      align-items: center;
      text-decoration: none;
      color: var(--dark);
      transition: all 0.2s;
      font-size: 14px;
    }

    .user-menu-item:hover {
      background-color: rgba(67, 97, 238, 0.05);
      color: var(--primary);
    }

    .user-menu-item.logout {
      color: var(--danger);
    }

    .user-menu-item.logout:hover {
      background-color: rgba(230, 57, 70, 0.05);
    }

    .user-menu-dropdown.show {
      display: block;
    }

    /* ========== 14. 专驻 专住 住住拽 ========== */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .chart-card {
      background-color: var(--white);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-height: 350px;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: var(--transition);
    }

    .chart-card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-3px);
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      text-align: center;
      color: var(--dark);
    }

    /* ========== 15.   ========== */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow-y: auto;
    }

    .modal-content {
      background-color: var(--white);
      margin: 5% auto;
      padding: 30px;
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .modal-title {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      color: var(--dark);
    }

    .modal-close {
      cursor: pointer;
      font-size: 28px;
      color: var(--gray);
      opacity: 0.7;
      transition: all 0.2s;
    }

    .modal-close:hover {
      opacity: 1;
      color: var(--danger);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* ========== 16. 住 转专转 ========== */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
      position: relative;
      overflow: hidden;
    }

    .auth-container::before {
      content: '';
      position: absolute;
      width: 2000px;
      height: 2000px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.05);
      top: -1000px;
      right: -1000px;
    }

    .auth-container::after {
      content: '';
      position: absolute;
      width: 1500px;
      height: 1500px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.05);
      bottom: -750px;
      left: -750px;
    }

    .auth-card {
      width: 100%;
      max-width: 450px;
      padding: 40px;
      background-color: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      position: relative;
      z-index: 10;
      overflow: hidden;
    }

    #auth-error {
    background-color: rgba(230, 57, 70, 0.1);
      border-right: 3px solid var(--danger);
      color: var(--danger);
      padding: 12px;
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
      font-size: 14px;
    }

    /* ========== 17. 专 爪转 ========== */
    .loader-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(67, 97, 238, 0.2);
      border-radius: 50%;
      border-top: 5px solid var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ========== 18. 转专转 ========== */
    .notifications-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 2000;
      max-width: 320px;
    }

    .notification {
      background-color: var(--white);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      animation: notificationFadeIn 0.3s;
      border-right: 5px solid var(--primary);
      position: relative;
      overflow: hidden;
      width: 100%;
    }

    .notification::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: 5px;
      background: linear-gradient(to bottom, var(--primary), var(--primary-light));
      border-radius: 5px 0 0 5px;
      opacity: 0;
    }

    .notification:hover::before {
      opacity: 1;
    }

    .notification-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 6px;
      color: var(--dark);
    }

    .notification-message {
      font-size: 14px;
      color: #5a5f69;
    }

    @keyframes notificationFadeIn {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* ========== 19. 住专转 驻注转 ========== */
    .activity-log {
      max-height: 400px;
      overflow-y: auto;
      padding: 0;
      margin: 0;
      list-style: none;
    }

    .activity-item {
      padding: 15px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .activity-time {
      color: var(--gray);
      font-size: 12px;
      margin-top: 4px;
    }

    /* ========== 20. 砖转 爪' ========== */
    .task-chat {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: var(--radius);
    }

    .chat-message {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
    }

    .chat-message-sender {
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .chat-message-time {
      font-size: 12px;
      color: var(--gray);
    }

    .chat-message-content {
      background-color: var(--white);
      padding: 10px 15px;
      border-radius: var(--radius);
      border-top-right-radius: 0;
      display: inline-block;
      max-width: 80%;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .chat-message.outgoing {
      align-items: flex-end;
    }

    .chat-message.outgoing .chat-message-content {
      background-color: var(--primary-light);
      color: var(--white);
      border-top-right-radius: var(--radius);
      border-top-left-radius: 0;
    }

    .chat-input-container {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      margin-bottom: 0;
    }

    /* ========== 21. 注转 拽爪 ========== */
    .file-upload-container {
      border: 2px dashed #ddd;
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-upload-container:hover {
      border-color: var(--primary);
      background-color: rgba(67, 97, 238, 0.02);
    }

    .file-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 15px;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #f8f9fa;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .file-delete {
      color: var(--danger);
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.2s;
    }

    .file-delete:hover {
      opacity: 1;
    }

    /* ========== 22. 转爪转 砖转 驻 专 ========== */
    .tasks-by-assignee {
      margin-top: 30px;
    }

    .assignee-tasks-container {
      margin-bottom: 30px;
    }

    .assignee-header {
      display: flex;
      align-items: center;
      gap: 12px;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: var(--radius);
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .unassigned-tasks-section {
      margin-top: 30px;
      border: 1px dashed #ccc;
      padding: 20px;
      border-radius: var(--radius);
      background-color: #fafafa;
    }

    /* ========== 23. 专住驻住转  ========== */
    @media (max-width: 768px) {
      .project-list {
        grid-template-columns: 1fr;
      }

      .charts-container {
        grid-template-columns: 1fr;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .dashboard-header > div:last-child {
        margin-top: 15px;
        width: 100%;
      }

      .dashboard-filter {
        flex-direction: column;
      }

      .hamburger-menu {
        display: flex;
      }

      .navbar-nav {
        display: none;
      }

      .navbar-nav.active {
        display: flex;
        flex-direction: column;
        position: absolute;
        top: 70px;
        left: 0;
        right: 0;
        background-color: var(--white);
        padding: 10px 0;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }

      .nav-item {
        width: 100%;
        margin-right: 0;
      }

      .nav-link {
        width: 100%;
        padding: 10px 24px;
      }

      .user-menu {
        width: 100%;
      }

      .user-menu-toggle {
        width: 100%;
        padding: 10px 24px;
        justify-content: space-between;
      }

      .user-menu-dropdown {
        width: 100%;
        position: static;
        box-shadow: none;
      }

      .modal-content {
        width: 95%;
        padding: 20px;
      }

      .row {
        flex-direction: column;
      }

      .task-item {
        flex-direction: column;
      }

      .task-actions {
        align-self: flex-end;
      }
    }
  </style>

  <!-- 住驻专转 Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-storage-compat.js"></script>

  <!-- 住驻专转 Chart.js 专驻 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
</head>
<body>
  <!-- 专 注 -->
  <div id="loader" class="loader-container">
    <div class="loader"></div>
  </div>

  <!-- 驻 转专转 -->
  <div id="notifications-panel" class="notifications-panel"></div>

  <!-- 专 转专转 -->
  <div id="auth-section" class="auth-container">
    <div class="auth-card">
      <div class="auth-logo" style="text-align: center; margin-bottom: 30px;">
        <i class="fas fa-tasks" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
        <h1 style="margin-bottom: 10px;">注专转  驻专拽</h1>
        <p style="color: #5a5f69; font-size: 14px; margin-top: 0;"> 转 驻专拽 砖转 砖 爪专 注</p>
      </div>

      <div id="auth-error" style="display: none;"></div>

      <div class="form-group">
        <label for="email">转转 </label>
        <div style="position: relative;">
          <i class="fas fa-envelope" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="email" id="email" placeholder="住 转 转转  砖" style="padding-left: 40px;">
        </div>
      </div>

      <div class="form-group" id="display-name-container" style="display: none;">
        <label for="display-name">砖 砖转砖</label>
        <div style="position: relative;">
          <i class="fas fa-user" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="text" id="display-name" placeholder="住 砖 砖转砖 转爪" style="padding-left: 40px;">
        </div>
      </div>

      <div class="form-group">
        <label for="password">住住</label>
        <div style="position: relative;">
          <i class="fas fa-lock" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="password" id="password" placeholder="住 住住" style="padding-left: 40px;">
        </div>
      </div>

      <!-- 驻转专 转专转 -->
      <div id="login-actions" style="display: flex; gap: 10px; margin-top: 20px;">
        <button id="login-btn" class="btn btn-lg" style="flex: 1;">转专转</button>
        <button id="switch-to-register" class="btn btn-success btn-lg" style="flex: 1;">专砖</button>
      </div>

      <!-- 驻转专 专砖 -->
      <div id="register-actions" style="display: none; gap: 10px; margin-top: 20px;">
        <button id="register-btn" class="btn btn-success btn-lg" style="flex: 1;">专砖</button>
        <button id="login-mode-btn" class="btn btn-outline btn-lg" style="flex: 1;">专 转专转</button>
      </div>
    </div>
  </div>

  <!-- 专 驻拽爪 -->
  <div id="app-section" class="hidden">
    <!-- 住专  -->
    <div class="navbar">
      <div class="navbar-container">
        <div style="display: flex; align-items: center;">
          <div class="hamburger-menu" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <a href="#" class="navbar-brand"><i class="fas fa-tasks" style="margin-left: 10px;"></i> 驻专拽</a>
        </div>
        <div class="navbar-nav" id="navbar-nav">
          <div class="nav-item">
            <a href="#" id="nav-projects" class="nav-link active"><i class="fas fa-folder" style="margin-left: 6px;"></i>驻专拽</a>
          </div>
          <div class="nav-item">
            <a href="#" id="nav-dashboard" class="nav-link"><i class="fas fa-clipboard-check" style="margin-left: 6px;"></i>砖转 砖</a>
          </div>
          <div class="nav-item">
            <a href="#" id="nav-stats" class="nav-link"><i class="fas fa-chart-pie" style="margin-left: 6px;"></i>住住拽转</a>
          </div>
          <div class="nav-item">
            <a href="#" id="nav-activity" class="nav-link"><i class="fas fa-history" style="margin-left: 6px;"></i>住专转 驻注转</a>
          </div>
          <div class="user-menu">
            <div class="user-menu-toggle">
              <div class="user-avatar" id="user-avatar"></div>
              <span id="user-email" style="margin: 0 8px; font-weight: 500;"></span>
              <i class="fas fa-chevron-down" style="font-size: 12px; color: #adb5bd;"></i>
            </div>
            <div class="user-menu-dropdown">
              <a href="#" class="user-menu-item"><i class="fas fa-user-circle" style="margin-left: 10px; color: var(--primary);"></i>驻专驻 砖</a>
              <a href="#" class="user-menu-item"><i class="fas fa-cog" style="margin-left: 10px; color: var(--gray);"></i>专转</a>
              <div style="margin: 8px 0; border-top: 1px solid #eee;"></div>
              <a href="#" id="logout-btn" class="user-menu-item logout"><i class="fas fa-sign-out-alt" style="margin-left: 10px; color: var(--danger);"></i>转转拽</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- 转爪转 专砖转 驻专拽 -->
      <div id="projects-view">
        <div class="dashboard-header">
          <div>
            <h2 style="margin-bottom: 8px; font-size: 24px; font-weight: 600;">驻专拽 砖</h2>
            <p style="color: #5a5f69; margin: 0;"> 转 驻专拽 砖 爪转 砖 拽 </p>
          </div>
          <button id="add-project-btn" class="btn btn-success">
            <i class="fas fa-plus" style="margin-left: 8px;"></i> 驻专拽 砖
          </button>
        </div>

        <!-- 专 驻砖 砖专 -->
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="search-projects" placeholder="驻砖 驻专拽 驻 砖, 转专  转转...">
        </div>

        <!-- 转驻专  砖专 -->
        <div class="tabs">
          <div class="tab active" data-filter="all">
            <i class="fas fa-th-large" style="margin-left: 8px;"></i>  驻专拽
          </div>
          <div class="tab" data-filter="personal">
            <i class="fas fa-user" style="margin-left: 8px;"></i> 驻专拽 砖
          </div>
          <div class="tab" data-filter="team">
            <i class="fas fa-users" style="margin-left: 8px;"></i> 驻专拽 爪转
          </div>
        </div>

        <!-- 转爪转 专砖转 驻专拽 -->
        <div id="projects-list" class="project-list">
          <!-- 驻专拽 爪  -->
        </div>
      </div>

      <!-- 转爪转 砖专 砖转 -->
      <div id="dashboard-view" class="hidden">
        <div class="dashboard-header">
          <div>
            <h2 style="margin-bottom: 8px; font-size: 24px; font-weight: 600;">砖转 砖</h2>
            <p style="color: #5a5f69; margin: 0;">住拽专 砖  砖转 砖  驻专拽</p>
          </div>
          <div>
            <button id="export-tasks-btn" class="btn btn-outline">
              <i class="fas fa-file-export" style="margin-left: 8px;"></i> 爪 砖转
            </button>
          </div>
        </div>

        <!-- 专 驻砖 驻专 -->
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="search-tasks" placeholder="驻砖 砖转 驻 砖, 转专  转转...">
        </div>

        <div class="dashboard-filter">
          <select id="dashboard-filter-project" class="form-control">
            <option value="all"> 驻专拽</option>
            <!-- 驻砖专转 转住驻 转 -->
          </select>
          <select id="dashboard-sort-by" class="form-control">
            <option value="deadline"> 驻 转专</option>
            <option value="name"> 驻 砖</option>
            <option value="project"> 驻 驻专拽</option>
            <option value="status"> 驻 住住</option>
          </select>
          <select id="dashboard-filter-tag" class="form-control">
            <option value="all"> 转转</option>
            <!-- 转转 转住驻 转 -->
          </select>
          <select id="dashboard-filter-status" class="form-control">
            <option value="all"> 住住</option>
            <option value="not-started">专 转</option>
            <option value="in-progress">转</option>
            <option value="waiting">转</option>
            <option value="blocked">转拽注</option>
            <option value="completed">砖</option>
          </select>
        </div>

        <div class="dashboard-section">
          <div class="section-header">
            <h3 class="section-title">砖转 爪注</h3>
          </div>
          <div id="dashboard-tasks" class="task-list">
            <!-- 砖转 爪  -->
          </div>
        </div>

        <div class="dashboard-section">
          <div class="section-header">
            <h3 class="section-title">砖转 砖砖</h3>
          </div>
          <div id="dashboard-completed-tasks" class="task-list">
            <!-- 砖转 砖砖 爪  -->
          </div>
        </div>

        <div class="dashboard-section">
          <div class="section-header">
            <h3 class="section-title">
              拽砖转 注专 爪转转
              <span class="badge" style="background-color: rgba(255, 159, 28, 0.15); color: var(--warning);"><i class="fas fa-hands-helping"></i></span>
            </h3>
          </div>
          <div id="dashboard-help-tasks" class="task-list">
            <!-- 拽砖转 注专 爪  -->
          </div>
        </div>
      </div>

      <!-- 转爪转 住住拽转 -->
      <div id="stats-view" class="hidden">
        <div class="dashboard-header">
          <div>
            <h2 style="margin-bottom: 8px; font-size: 24px; font-weight: 600;">住住拽转</h2>
            <p style="color: #5a5f69; margin: 0;">转 爪转 爪 砖 驻专拽 砖转 砖</p>
          </div>
        </div>

        <div class="charts-container">
          <div class="chart-card">
            <div class="chart-title">转拽转 驻专拽</div>
            <canvas id="projects-progress-chart"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">砖转 驻 住住</div>
            <canvas id="tasks-by-status-chart"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">注住 砖转 砖注</div>
            <canvas id="weekly-tasks-chart"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">转驻转 驻 转转</div>
            <canvas id="tasks-by-tag-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- 转爪转 住专转 驻注转 -->
      <div id="activity-view" class="hidden">
        <div class="dashboard-header">
          <div>
            <h2 style="margin-bottom: 8px; font-size: 24px; font-weight: 600;">住专转 驻注转</h2>
            <p style="color: #5a5f69; margin: 0;">注拽 专  驻注转 砖爪注 注专转</p>
          </div>
        </div>

        <div class="card">
          <ul id="activity-log" class="activity-log">
            <!-- 住专转 驻注转 转爪  -->
          </ul>
        </div>
      </div>

      <!-- 转爪转 驻专拽 住驻爪驻 -->
      <div id="project-detail-view" class="hidden">
        <div class="card">
          <button id="back-to-projects" class="btn">
            <i class="fas fa-arrow-right"></i> 专 专砖转 驻专拽
          </button>

          <div id="project-detail" style="margin-top: 20px;">
            <!-- 驻专 驻专拽 爪  -->
          </div>

          <!-- 专祝 转拽转 驻专拽 -->
          <div class="chart-card" style="margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
            <div class="chart-title">转拽转 驻专拽</div>
            <canvas id="project-progress-chart"></canvas>
          </div>

          <!-- 专 爪转 驻专拽 爪转 -->
          <div id="team-members-section" class="hidden" style="margin-top: 20px;">
            <div class="section-header">
              <h3 class="section-title">专 爪转</h3>
              <button id="add-member-btn" class="btn btn-success">
                <i class="fas fa-user-plus"></i> 住祝 专 爪转
              </button>
            </div>
            <div id="team-members-list" class="member-list">
              <!-- 专 爪转 爪  -->
            </div>
          </div>

          <div style="margin-top: 20px;">
            <div class="section-header">
              <h3 class="section-title">砖转</h3>
              <div>
                <button id="add-task-btn" class="btn">
                  <i class="fas fa-plus"></i> 住祝 砖
                </button>
                <button id="add-help-request-btn" class="btn btn-warning">
                  <i class="fas fa-hands-helping"></i> 拽砖转 注专
                </button>
              </div>
            </div>

            <div class="task-sort">
              <select id="task-sort-by" class="form-control">
                <option value="createdAt-desc">砖 砖</option>
                <option value="createdAt-asc">砖 砖</option>
                <option value="deadline-asc">转专 拽专 转专</option>
                <option value="name-asc">驻 砖 (-转)</option>
                <option value="status-asc">驻 住住</option>
              </select>
              <select id="task-filter-tag" class="form-control">
                <option value="all"> 转转</option>
                <!-- 转转 转住驻 转 -->
              </select>
              <select id="task-filter-status" class="form-control">
                <option value="all"> 住住</option>
                <option value="not-started">专 转</option>
                <option value="in-progress">转</option>
                <option value="waiting">转</option>
                <option value="blocked">转拽注</option>
                <option value="completed">砖</option>
              </select>
              <!-- 驻专 驻 专 - 专拽 驻专拽 爪转 -->
              <select id="task-filter-assignee" class="form-control hidden">
                <option value="all"> 专</option>
                <option value="none"> 专</option>
                <!-- 驻砖专转 转住驻 转 -->
              </select>
            </div>

            <!-- 转爪转  驻专拽 爪转 -->
            <div class="tabs hidden" id="task-view-tabs">
              <div class="tab active" data-view="list">转爪转 专砖</div>
              <div class="tab" data-view="assignee">驻 专</div>
            </div>

            <!-- 转爪转 专砖转 砖转 -->
            <div id="tasks-list-view">
              <div id="tasks-list" class="task-list">
                <!-- 砖转 爪  -->
              </div>
            </div>

            <!-- 转爪转 砖转 驻 专 -->
            <div id="tasks-by-assignee-view" class="hidden">
              <!-- 砖转  专 - 注 -->
              <div class="unassigned-tasks-section">
                <div class="section-header">
                  <h3 class="section-title">砖转  专</h3>
                </div>
                <div id="unassigned-tasks-list" class="task-list">
                  <!-- 砖转  专 爪  -->
                </div>
              </div>

              <!-- 砖转 驻 专 -->
              <div id="tasks-by-assignee" class="tasks-by-assignee">
                <!-- 砖转 驻 专 爪  -->
              </div>
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--  驻专拽 -->
  <div id="project-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="project-modal-title" class="modal-title">驻专拽 砖</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="form-group">
        <label for="project-name">砖 驻专拽:</label>
        <div style="position: relative;">
          <i class="fas fa-project-diagram" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="text" id="project-name" placeholder=" 砖 驻专拽" style="padding-left: 40px;">
        </div>
      </div>

      <div class="form-group">
        <label for="project-description">转专 驻专拽:</label>
        <textarea id="project-description" placeholder=" 转专 驻专拽" rows="4"></textarea>
      </div>

      <div class="form-group">
        <label for="project-deadline">转专 注:</label>
        <div style="position: relative;">
          <i class="fas fa-calendar-alt" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="date" id="project-deadline" style="padding-left: 40px;">
        </div>
      </div>

      <div class="form-group">
        <label for="project-type">住 驻专拽:</label>
        <div style="position: relative;">
          <i class="fas fa-tag" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <select id="project-type" style="padding-left: 40px;">
            <option value="personal">驻专拽 砖</option>
            <option value="team">驻专拽 爪转</option>
          </select>
        </div>
      </div>

      <input type="hidden" id="project-id">

      <div class="modal-footer">
        <button id="save-project-btn" class="btn btn-success">砖专</button>
        <button id="cancel-project-btn" class="btn btn-outline"></button>
      </div>
    </div>
  </div>

  <!--  专 爪转 -->
  <div id="team-member-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">住驻转 专 爪转 驻专拽</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="form-group">
        <label id="member-email-label" for="member-email">驻砖 (  砖):</label>
        <div style="position: relative;">
          <i class="fas fa-search" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="text" id="member-email" placeholder="   砖 砖 专 爪转" style="padding-left: 40px;">
        </div>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
           驻转 3 转  转 驻砖
        </div>
      </div>

      <div id="member-search-results" style="max-height: 300px; overflow-y: auto; margin-top: 15px;"></div>

      <div class="modal-footer">
        <button id="add-member-confirm-btn" class="btn btn-success" disabled>住祝 驻专拽</button>
        <button id="cancel-member-btn" class="btn btn-outline"></button>
      </div>
    </div>
  </div>

  <!--  爪' 砖 -->
  <div id="task-chat-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="chat-task-name" class="modal-title">爪' 砖</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="task-chat" id="task-chat-messages">
        <!-- 注转 爪' 爪  -->
      </div>

      <div class="chat-input-container">
        <input type="text" id="chat-message" class="chat-input" placeholder="拽 注...">
        <button id="send-chat-message" class="btn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>

      <input type="hidden" id="chat-task-id">
    </div>
  </div>

  <!--  砖 -->
  <div id="task-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="task-modal-title" class="modal-title">砖 砖</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="form-group">
        <label for="task-name">砖 砖:</label>
        <div style="position: relative;">
          <i class="fas fa-tasks" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="text" id="task-name" placeholder=" 砖 砖" style="padding-left: 40px;">
        </div>
      </div>

      <div class="form-group">
        <label for="task-description">转专 砖:</label>
        <textarea id="task-description" placeholder=" 转专 砖" rows="4"></textarea>
      </div>

      <!-- 砖: 注转 拽爪 -->
      <div class="form-group">
        <label>拽爪 爪专驻:</label>
        <div class="file-upload-container" id="file-upload-area">
          <i class="fas fa-cloud-upload-alt" style="font-size: 24px; color: var(--gray); margin-bottom: 10px;"></i>
          <p>专专 拽爪   抓 专转 拽爪</p>
          <input type="file" id="task-files" multiple style="display: none;">
        </div>
        <div class="file-preview" id="file-preview"></div>
      </div>

      <div class="row" style="display: flex; margin: 0 -10px;">
        <div class="col" style="flex: 1; padding: 0 10px;">
          <div class="form-group">
            <label for="task-deadline">转专 注:</label>
            <div style="position: relative;">
              <i class="fas fa-calendar-alt" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
              <input type="date" id="task-deadline" style="padding-left: 40px;">
            </div>
          </div>
        </div>
        <div class="col" style="flex: 1; padding: 0 10px;">
          <div class="form-group">
            <label for="task-status">住住:</label>
            <div style="position: relative;">
              <i class="fas fa-clipboard-list" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
              <select id="task-status" style="padding-left: 40px;">
                <option value="not-started">专 转</option>
                <option value="in-progress">转</option>
                <option value="waiting">转 专注/转专</option>
                <option value="blocked">转拽注</option>
                <option value="completed">砖</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group" id="task-blocked-reason-container" style="display: none;">
        <label for="task-blocked-reason">住转 注:</label>
        <div style="position: relative;">
          <i class="fas fa-exclamation-triangle" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="text" id="task-blocked-reason" placeholder="住专 注 砖 转拽注" style="padding-left: 40px;">
        </div>
      </div>

      <div class="form-group" id="task-waiting-for-container" style="display: none;">
        <label for="task-waiting-for">转 :</label>
        <div style="position: relative;">
          <i class="fas fa-hourglass-half" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="text" id="task-waiting-for" placeholder="转专  专注 砖 砖 转" style="padding-left: 40px;">
        </div>
      </div>

      <div class="form-group" id="task-tags-container">
        <label for="task-tags">转转:</label>
        <div class="tags-input">
          <div id="task-tags-items"></div>
          <input type="text" id="task-tag-input" class="tag-input" placeholder="住祝 转转 抓 Enter">
        </div>
      </div>

      <div id="task-assignee-section" class="form-group hidden">
        <label for="task-assignee">砖 :</label>
        <div style="position: relative;">
          <i class="fas fa-user-check" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <select id="task-assignee" style="padding-left: 40px;">
            <option value=""> 砖</option>
            <!-- 驻砖专转 专 爪转 转住驻 转 -->
          </select>
        </div>
      </div>

      <div id="task-help-section" class="form-group hidden">
        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="task-help-request" style="margin-left: 10px; width: auto;">
            <span>拽砖转 注专 爪转转</span>
          </label>
        </div>
      </div>

      <input type="hidden" id="task-id">
      <input type="hidden" id="task-project-id">
      <input type="hidden" id="task-tags-hidden">

      <div class="modal-footer">
        <button id="save-task-btn" class="btn btn-success">砖专</button>
        <button id="cancel-task-btn" class="btn btn-outline"></button>
      </div>
    </div>
  </div>

  <!--   砖转砖 -->
  <div id="user-management-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"> 砖转砖</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="form-group">
        <h4>住驻转 砖转砖 专砖</h4>
        <div style="position: relative;">
          <i class="fas fa-envelope" style="position: absolute; left: 12px; top: 14px; color: #adb5bd;"></i>
          <input type="email" id="authorized-email" placeholder="  砖 砖转砖" style="padding-left: 40px;">
        </div>
        <button id="add-authorized-btn" class="btn btn-success" style="margin-top: 10px;">住祝 砖转砖 专砖</button>
      </div>

      <div style="margin-top: 20px;">
        <h4>专砖转 砖转砖 专砖</h4>
        <div id="authorized-users-list" class="user-management-list" style="max-height: 300px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; border-radius: var(--radius);">
          <div>注 砖转砖...</div>
        </div>
      </div>
    </div>
  </div>

  <!--  拽砖转 专砖 -->
  <div id="pending-registrations-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">拽砖转 专砖 转转</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div id="pending-registrations-list" class="user-management-list" style="max-height: 400px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; border-radius: var(--radius);">
        <div>注 拽砖转 专砖...</div>
      </div>

      <div class="modal-footer">
        <button id="close-registrations-btn" class="btn btn-outline">住专</button>
      </div>
    </div>
  </div>

  <script>

    // 转爪专转 Firebase
    // 砖转 
    let auth;
    let db;
    let storage;
    let charts = {}; // 住 砖 拽 专驻

    // 驻拽爪 注转 转爪专转 Firebase 砖专转
    function initializeFirebase() {
      showLoader();

      fetch('/api/firebase-config')
        .then(response => {
          if (!response.ok) {
            throw new Error('注 注转 转爪专转 Firebase: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          console.log('转爪专转 Firebase 注 爪');

          // 砖专转   转砖
          adminEmail = data.adminEmail;

          // 转 Firebase 注 转爪专 砖转拽
          firebase.initializeApp(data.firebaseConfig);

          // 拽爪专 专 砖专转
          auth = firebase.auth();
          db = firebase.firestore();
          storage = firebase.storage();

          // 注拽 专 转专转 砖转砖
          startAuthListener();
        })
        .catch(error => {
          console.error('砖 注转 转爪专转 Firebase:', error);
          document.getElementById('auth-error').textContent = '砖 注转 专转 驻拽爪: ' + error.message;
          document.getElementById('auth-error').style.display = 'block';
          hideLoader();
        });
    }

    // 驻拽爪 注拽 专 爪 转专转 砖转砖
    // 注拽 专 爪 转专转 砖转砖
  function startAuthListener() {
    auth.onAuthStateChanged(user => {
      if (user) {
        // 砖转砖 专 - 拽   专砖
        showLoader();

        // 拽转 住住 砖转砖
        db.collection('users').doc(user.uid).get()
          .then(doc => {
            let userData;

            if (doc.exists) {
              userData = doc.data();

              // 拽 转拽转  住住 砖转砖
              if (user.email === adminEmail || (userData && userData.isAdmin)) {
                // 砖转砖    砖转砖 注 专砖转 
                currentUser = {
                  uid: user.uid,
                  email: user.email,
                  displayName: userData.displayName || user.email.split('@')[0],
                  isAdmin: true
                };

                // 注 砖拽 砖转砖
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.displayName;
                document.getElementById('user-avatar').textContent = (currentUser.displayName.charAt(0) || "?").toUpperCase();

                // 注 转驻专  (转拽 砖 拽  驻专 专 拽)
                updateUserMenuForAdmin();

                // 注转 驻专拽 砖 砖转砖
                loadProjects();
                hideLoader();
              } else if (userData.status === 'approved') {
                // 砖转砖 砖专
                currentUser = {
                  uid: user.uid,
                  email: user.email,
                  displayName: userData.displayName || user.email.split('@')[0],
                  isAdmin: false
                };

                // 注 砖拽 砖转砖
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.displayName;
                document.getElementById('user-avatar').textContent = (currentUser.displayName.charAt(0) || "?").toUpperCase();

                // 注转 驻专拽 砖 砖转砖
                loadProjects();
                hideLoader();
              } else if (userData.status === 'pending') {
                // 砖转砖 转 砖专
                document.getElementById('auth-error').textContent = '砖 砖 转 砖专  注专转. 住 砖 专 转专.';
                document.getElementById('auth-error').style.display = 'block';
                hideLoader();
                // 转拽 砖转砖
                auth.signOut();
              } else {
                // 砖转砖   爪  转拽
                document.getElementById('auth-error').textContent = '  专砖转 砖 注专转.';
                document.getElementById('auth-error').style.display = 'block';
                hideLoader();
                // 转拽 砖转砖
                auth.signOut();
              }
            } else {
              //  注 注 砖转砖 - 爪专转 专砖 注 住住 转
              if (user.email === adminEmail) {
                //   , 爪专 专砖 注 专砖转  砖专 
                return db.collection('users').doc(user.uid).set({
                  userId: user.uid,
                  email: user.email,
                  displayName: user.email.split('@')[0],
                  isAdmin: true,
                  status: 'approved',
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                  // 拽专 专拽专住转 转 驻拽爪  砖 转 转 转专转
                  startAuthListener();
                });
              } else {
                // 砖转砖 砖 砖 
                return db.collection('users').doc(user.uid).set({
                  userId: user.uid,
                  email: user.email,
                  displayName: user.email.split('@')[0],
                  isAdmin: false,
                  status: 'pending',
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                  document.getElementById('auth-error').textContent = '砖 砖 转 砖专  注专转. 住 砖 专 转专.';
                  document.getElementById('auth-error').style.display = 'block';
                  hideLoader();
                  // 转拽 砖转砖
                  auth.signOut();
                });
              }
            }
          })
          .catch(error => {
            hideLoader();
            console.error("Error checking user status:", error);
            document.getElementById('auth-error').textContent = '砖 拽转 专砖转: ' + error.message;
            document.getElementById('auth-error').style.display = 'block';
            // 转拽 砖转砖 拽专 砖 砖
            auth.signOut();
          });
      } else {
        // 砖转砖  专
        currentUser = null;
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('app-section').classList.add('hidden');
        document.getElementById('auth-error').style.display = 'none';
        hideLoader();
      }
    });
  }

        // 砖转 
        let adminEmail = null;
        let currentUser = null;
        let currentProjectId = null;
        let currentProjectData = null;
        let currentProjectMembers = [];
        let currentFilter = "all";
        let allTags = new Set();
        let allProjects = [];
        let userDashboardTasks = [];
        let currentTaskView = "list"; // 爪 转爪转 砖转: "list"  "assignee"
        let uploadedFiles = []; // 注专 住 拽爪 砖注

        // 驻 住住
        const statusLabels = {
          'not-started': '专 转',
          'in-progress': '转',
          'waiting': '转',
          'blocked': '转拽注',
          'completed': '砖'
        };

        // 住转专转 拽 -DOM 注 拽转 住住 专 砖 砖转砖
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('app-section').classList.add('hidden');

        // 爪转 住转专转 专
        function showLoader() {
          document.getElementById('loader').classList.remove('hidden');
        }

        function hideLoader() {
          document.getElementById('loader').classList.add('hidden');
        }

        // 专注 爪 - 转
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('switch-to-register').addEventListener('click', function() {
          document.getElementById('display-name-container').style.display = 'block';
          document.getElementById('login-actions').style.display = 'none';
          document.getElementById('register-actions').style.display = 'flex';
        });
        document.getElementById('login-mode-btn').addEventListener('click', function() {
          document.getElementById('display-name-container').style.display = 'none';
          document.getElementById('login-actions').style.display = 'flex';
          document.getElementById('register-actions').style.display = 'none';
        });
        document.getElementById('register-btn').addEventListener('click', register);
        document.getElementById('logout-btn').addEventListener('click', logout);

        // 专注 爪 - 
        document.getElementById('nav-projects').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('nav-projects').classList.add('active');
          document.getElementById('nav-dashboard').classList.remove('active');
          document.getElementById('nav-stats').classList.remove('active');
          document.getElementById('nav-activity').classList.remove('active');
          document.getElementById('projects-view').classList.remove('hidden');
          document.getElementById('dashboard-view').classList.add('hidden');
          document.getElementById('stats-view').classList.add('hidden');
          document.getElementById('activity-view').classList.add('hidden');
          document.getElementById('project-detail-view').classList.add('hidden');
        });

        document.getElementById('nav-dashboard').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('nav-dashboard').classList.add('active');
          document.getElementById('nav-projects').classList.remove('active');
          document.getElementById('nav-stats').classList.remove('active');
          document.getElementById('nav-activity').classList.remove('active');
          document.getElementById('projects-view').classList.add('hidden');
          document.getElementById('dashboard-view').classList.remove('hidden');
          document.getElementById('stats-view').classList.add('hidden');
          document.getElementById('activity-view').classList.add('hidden');
          document.getElementById('project-detail-view').classList.add('hidden');
          loadDashboard();
        });

        document.getElementById('nav-stats').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('nav-stats').classList.add('active');
          document.getElementById('nav-projects').classList.remove('active');
          document.getElementById('nav-dashboard').classList.remove('active');
          document.getElementById('nav-activity').classList.remove('active');
          document.getElementById('projects-view').classList.add('hidden');
          document.getElementById('dashboard-view').classList.add('hidden');
          document.getElementById('stats-view').classList.remove('hidden');
          document.getElementById('activity-view').classList.add('hidden');
          document.getElementById('project-detail-view').classList.add('hidden');
          loadStats();
        });

        document.getElementById('nav-activity').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('nav-activity').classList.add('active');
          document.getElementById('nav-projects').classList.remove('active');
          document.getElementById('nav-dashboard').classList.remove('active');
          document.getElementById('nav-stats').classList.remove('active');
          document.getElementById('projects-view').classList.add('hidden');
          document.getElementById('dashboard-view').classList.add('hidden');
          document.getElementById('stats-view').classList.add('hidden');
          document.getElementById('activity-view').classList.remove('hidden');
          document.getElementById('project-detail-view').classList.add('hidden');
          loadActivityLog();
        });

        // 住专  
        document.getElementById('hamburger-menu').addEventListener('click', function() {
          const navbarNav = document.getElementById('navbar-nav');
          navbarNav.classList.toggle('active');
        });

        // Toggle user menu
        document.querySelector('.user-menu-toggle').addEventListener('click', function() {
          document.querySelector('.user-menu-dropdown').classList.toggle('show');
        });

        // Close user menu when clicking outside
        window.addEventListener('click', function(e) {
          if (!e.target.closest('.user-menu')) {
            const dropdown = document.querySelector('.user-menu-dropdown');
            if (dropdown.classList.contains('show')) {
              dropdown.classList.remove('show');
            }
          }
        });

        // 驻砖 驻专拽
        document.getElementById('search-projects').addEventListener('input', function() {
          const searchTerm = this.value.trim().toLowerCase();
          filterProjects(searchTerm);
        });

        // 驻砖 砖转
        document.getElementById('search-tasks').addEventListener('input', function() {
          const searchTerm = this.value.trim().toLowerCase();
          filterDashboardTasks(searchTerm);
        });

        // 爪 砖转
        document.getElementById('export-tasks-btn').addEventListener('click', exportTasks);

        // 专注 爪 - 驻专拽
        document.getElementById('add-project-btn').addEventListener('click', showAddProjectModal);
        document.getElementById('save-project-btn').addEventListener('click', saveProject);
        document.getElementById('cancel-project-btn').addEventListener('click', () => {
          document.getElementById('project-modal').style.display = 'none';
        });

        // 专注 爪 - 专 爪转
        document.getElementById('add-member-btn').addEventListener('click', showAddMemberModal);
        document.getElementById('add-member-confirm-btn').addEventListener('click', addMemberToProject);
        document.getElementById('cancel-member-btn').addEventListener('click', () => {
          document.getElementById('team-member-modal').style.display = 'none';
        });

        // 专注 爪 - 驻砖 专 爪转 驻 拽
        // 注  专注 驻砖
  document.getElementById('member-email').addEventListener('input', function() {
    // 专拽  砖 驻转 3 转, 爪注 驻砖
    if (this.value.trim().length >= 3) {
      searchUserByEmailOrName();
    } else {
      document.getElementById('member-search-results').innerHTML = '<div> 驻转 3 转 驻砖</div>';
      document.getElementById('add-member-confirm-btn').disabled = true;
    }
  });

        // 专注 爪 - 砖转
        document.getElementById('add-task-btn').addEventListener('click', () => showAddTaskModal(false));
        document.getElementById('add-help-request-btn').addEventListener('click', () => showAddTaskModal(true));
        document.getElementById('save-task-btn').addEventListener('click', saveTask);
        document.getElementById('cancel-task-btn').addEventListener('click', () => {
          document.getElementById('task-modal').style.display = 'none';
        });

        // 专注 爪' 砖
        document.getElementById('send-chat-message').addEventListener('click', sendChatMessage);
        document.getElementById('chat-message').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            sendChatMessage();
          }
        });

        // 驻 专专转 注转 拽爪
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('task-files');

        fileUploadArea.addEventListener('click', () => {
          fileInput.click();
        });

        fileUploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          fileUploadArea.style.borderColor = 'var(--primary)';
        });

        fileUploadArea.addEventListener('dragleave', () => {
          fileUploadArea.style.borderColor = '#ddd';
        });

        fileUploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          fileUploadArea.style.borderColor = '#ddd';

          if (e.dataTransfer.files.length > 0) {
            handleFiles(e.dataTransfer.files);
          }
        });

        fileInput.addEventListener('change', () => {
          if (fileInput.files.length > 0) {
            handleFiles(fileInput.files);
          }
        });

        // 专注 转转
        document.getElementById('task-tag-input').addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && this.value.trim() !== '') {
            e.preventDefault();
            addTag(this.value.trim());
            this.value = '';
          }
        });

        // 专注 砖 住住 砖
        document.getElementById('task-status').addEventListener('change', function() {
          const status = this.value;
          const blockedContainer = document.getElementById('task-blocked-reason-container');
          const waitingContainer = document.getElementById('task-waiting-for-container');

          // 住转专/爪 砖 砖转 转 住住
          blockedContainer.style.display = (status === 'blocked') ? 'block' : 'none';
          waitingContainer.style.display = (status === 'waiting') ? 'block' : 'none';
        });

        // 住专转  X
        document.querySelectorAll('.modal-close').forEach(close => {
          close.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
          });
        });

        // 专注 住 砖专
        document.getElementById('dashboard-filter-project').addEventListener('change', filterDashboardTasks);
        document.getElementById('dashboard-sort-by').addEventListener('change', filterDashboardTasks);
        document.getElementById('dashboard-filter-tag').addEventListener('change', filterDashboardTasks);
        document.getElementById('dashboard-filter-status').addEventListener('change', filterDashboardTasks);

        // 专注  砖转 驻专拽
        document.getElementById('task-sort-by').addEventListener('change', function() {
          loadTasks(currentProjectId);
        });

        document.getElementById('task-filter-tag').addEventListener('change', function() {
          loadTasks(currentProjectId);
        });

        document.getElementById('task-filter-status').addEventListener('change', function() {
          loadTasks(currentProjectId);
        });

        document.getElementById('task-filter-assignee').addEventListener('change', function() {
          if (currentTaskView === "list") {
            loadTasks(currentProjectId);
          } else {
            displayTasksByAssignee();
          }
        });

        // 专注 专 专砖转 驻专拽
        document.getElementById('back-to-projects').addEventListener('click', () => {
          document.getElementById('projects-view').classList.remove('hidden');
          document.getElementById('project-detail-view').classList.add('hidden');
          document.getElementById('nav-projects').classList.add('active');
          document.getElementById('nav-dashboard').classList.remove('active');
          document.getElementById('nav-stats').classList.remove('active');
          document.getElementById('nav-activity').classList.remove('active');
        });

        // 专注  住 驻专拽
        document.querySelectorAll('.tabs .tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            // 拽     砖 转爪转 砖转
            if (!e.target.closest('#task-view-tabs')) {
              document.querySelectorAll('.tabs .tab:not([data-view])').forEach(t => {
                t.classList.remove('active');
              });
              e.target.classList.add('active');
              currentFilter = e.target.dataset.filter;
              loadProjects();
            }
          });
        });

        // 专注 驻转 转爪转 砖转 (专砖 / 驻 专)
        document.addEventListener('click', function(e) {
          if (e.target.classList.contains('tab') && e.target.closest('#task-view-tabs')) {
            // 住专转 住  
            e.target.closest('#task-view-tabs').querySelectorAll('.tab').forEach(tab => {
              tab.classList.remove('active');
            });

            // 住驻转 住  
            e.target.classList.add('active');

            // 砖 转爪转 砖转
            const view = e.target.dataset.view;
            currentTaskView = view;

            if (view === 'list') {
              document.getElementById('tasks-list-view').classList.remove('hidden');
              document.getElementById('tasks-by-assignee-view').classList.add('hidden');
              loadTasks(currentProjectId);
            } else if (view === 'assignee') {
              document.getElementById('tasks-list-view').classList.add('hidden');
              document.getElementById('tasks-by-assignee-view').classList.remove('hidden');
              displayTasksByAssignee();
            }
          }
        });
        // 驻拽爪 爪转  拽砖转 专砖 转转
function showPendingRegistrationsModal() {
  // 拽 专砖转 
  if (!currentUser || !currentUser.isAdmin) {
    alert('专拽  注专转 砖 专砖  拽砖转 专砖');
    return;
  }

  // 爪 转 
  document.getElementById('pending-registrations-modal').style.display = 'block';

  // 注 转 专砖转 拽砖转 专砖 转转
  loadPendingRegistrations();
}

// 驻拽爪 注转 拽砖转 专砖 转转
function loadPendingRegistrations() {
  const pendingList = document.getElementById('pending-registrations-list');
  pendingList.innerHTML = '注 拽砖转 专砖...';

  db.collection('users')
    .where('status', '==', 'pending')
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        pendingList.innerHTML = '<div> 拽砖转 专砖 转转.</div>';
        return;
      }

      // 住驻专 砖专转 拽专
      let pendingHTML = '<div>住驻专 拽砖转 专砖 转转: ' + snapshot.size + '</div>';

      snapshot.forEach(doc => {
        const userData = doc.data();
        const creationTime = userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleString() : ' 注';

        pendingHTML += `
          <div class="user-management-item">
            <div>
              <strong>${userData.email}</strong>
              <div style="font-size: 12px; color: #666;">
                专砖: ${creationTime}
              </div>
            </div>
            <div>
              <button class="btn btn-sm btn-success approve-user-btn" data-id="${doc.id}" data-email="${userData.email}">
                <i class="fas fa-check"></i> 砖专
              </button>
              <button class="btn btn-sm btn-danger reject-user-btn" data-id="${doc.id}" data-email="${userData.email}">
                <i class="fas fa-times"></i> 
              </button>
            </div>
          </div>
        `;
      });

      pendingList.innerHTML = pendingHTML;

      // 住祝  驻转专 专 砖 住驻 -DOM
      pendingList.querySelectorAll('.approve-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const userId = this.getAttribute('data-id');
          const userEmail = this.getAttribute('data-email');
          approveUserRegistration(userId, userEmail);
        });
      });

      pendingList.querySelectorAll('.reject-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const userId = this.getAttribute('data-id');
          const userEmail = this.getAttribute('data-email');
          rejectUserRegistration(userId, userEmail);
        });
      });
    })
    .catch(error => {
      console.error("Error loading pending registrations:", error);
      pendingList.innerHTML = '<div style="color: var(--danger);">砖 注转 拽砖转 专砖: ' + error.message + '</div>';
    });
}
        // 驻拽爪 注 转驻专 砖转砖 转 住 砖转砖
        function updateUserMenuForAdmin() {
        if (currentUser && currentUser.isAdmin) {
          const userMenu = document.querySelector('.user-menu-dropdown');
          if (userMenu) {
            // 拽  专 拽 驻专 转驻专 专砖转
            const existingItem = userMenu.querySelector('.admin-menu-item');
            if (existingItem) {
              // 驻专 专 拽,  爪专 住祝 砖
              return;
            }

            // 住祝  拽砖转 专砖
            const pendingRequestsItem = document.createElement('a');
            pendingRequestsItem.href = '#';
            pendingRequestsItem.className = 'user-menu-item admin-menu-item';
            pendingRequestsItem.textContent = '拽砖转 专砖 转转';
            pendingRequestsItem.addEventListener('click', showPendingRegistrationsModal);

            // 住祝 转驻专 驻 驻专 转转拽转
            const logoutItem = userMenu.querySelector('#logout-btn');
            if (logoutItem) {
              userMenu.insertBefore(pendingRequestsItem, logoutItem);
            } else {
              userMenu.appendChild(pendingRequestsItem);
            }
          }
        }
      }
      function approveUserRegistration(userId, userEmail) {
      if (confirm(` 转  砖专爪 砖专 转 砖转砖 ${userEmail}?`)) {
        showLoader();

        db.collection('users').doc(userId).update({
          status: 'approved',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
          approvedBy: currentUser.uid
        })
        .then(() => {
          hideLoader();
          showNotification('砖转砖 砖专', `砖转砖 ${userEmail} 砖专 爪`, 'success');
          loadPendingRegistrations(); // 专注 专砖
        })
        .catch(error => {
          hideLoader();
          console.error("Error approving user:", error);
          showNotification('砖', '砖 砖专 砖转砖: ' + error.message, 'danger');
        });
      }
    }

    function rejectUserRegistration(userId, userEmail) {
      if (confirm(` 转  砖专爪 转 转 砖转砖 ${userEmail}?`)) {
        showLoader();

        db.collection('users').doc(userId).update({
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rejectedBy: currentUser.uid
        })
        .then(() => {
          hideLoader();
          showNotification('砖转砖 ', `砖转砖 ${userEmail}  爪`, 'success');
          loadPendingRegistrations(); // 专注 专砖
        })
        .catch(error => {
          hideLoader();
          console.error("Error rejecting user:", error);
          showNotification('砖', '砖 转 砖转砖: ' + error.message, 'danger');
        });
      }
    }

    function rejectUserRegistration(userId, userEmail) {
      if (confirm(` 转  砖专爪 转 转 砖转砖 ${userEmail}?`)) {
        showLoader();

        db.collection('users').doc(userId).update({
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rejectedBy: currentUser.uid
        })
        .then(() => {
          hideLoader();
          alert(`砖转砖 ${userEmail} `);
          loadPendingRegistrations(); // 专注 专砖
        })
        .catch(error => {
          hideLoader();
          console.error("Error rejecting user:", error);
          alert('砖 转 砖转砖: ' + error.message);
        });
      }
    }
    // 爪转 驻专拽 砖拽
function displayProjects(projects) {
  const projectsList = document.getElementById('projects-list');

  if (projects.length === 0) {
    projectsList.innerHTML = '<div style="text-align: center; padding: 20px;"> 驻专拽. 抓 注 "驻专拽 砖"  转.</div>';
    return;
  }

  projectsList.innerHTML = '';

  projects.forEach(project => {
    const { id, data, role, type } = project;

    // 爪转 转专 驻专 拽
    let deadlineText = ' 转专 注';
    let isOverdue = false;

    if (data.deadline) {
      const date = new Date(data.deadline);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      deadlineText = date.toLocaleDateString('he-IL');

      if (date < today) {
        isOverdue = true;
      }
    }

    // 爪专转 专住 驻专拽
    const projectCard = document.createElement('div');
    projectCard.className = 'card project-card';
    projectCard.style.borderRight = `5px solid ${isOverdue ? 'var(--danger)' : 'var(--primary)'}`;

    // 拽专 住 驻专拽
    const typeIndicator = document.createElement('div');
    typeIndicator.className = `project-type-indicator ${data.type === 'personal' ? 'personal-project' : 'team-project'}`;
    typeIndicator.textContent = data.type === 'personal' ? '砖' : '爪转';
    projectCard.appendChild(typeIndicator);

    // 转 专住
    const cardContent = document.createElement('div');
    cardContent.className = 'project-card-content';
    cardContent.innerHTML = `
      <h3 class="project-card-title">${data.name}</h3>
      <div class="project-card-description">${data.description || ' 转专'}</div>
      <div class="project-card-footer">
        <div>
          <div><i class="fas fa-calendar-alt"></i> ${deadlineText}</div>
          ${role === 'owner' ? '<span class="badge badge-owner"></span>' : '<span class="badge badge-member">专</span>'}
        </div>
        ${role === 'owner' ?
          `<button class="btn btn-sm btn-danger delete-project" data-id="${id}">
            <i class="fas fa-trash"></i>
           </button>` : ''}
      </div>
    `;
    projectCard.appendChild(cardContent);

    // 专注 爪 注 专住 驻专拽
    projectCard.addEventListener('click', (e) => {
      if (!e.target.closest('.delete-project')) {
        openProject(id, role);
      }
    });

    // 专注 拽转 驻专拽
    const deleteButton = projectCard.querySelector('.delete-project');
    if (deleteButton) {
      deleteButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm(' 转  砖专爪 拽 驻专拽 ?')) {
          deleteProject(id);
        }
      });
    }

    projectsList.appendChild(projectCard);
  });
}
    //  砖砖转砖 专砖 注专转
    function ensureUserIsRegistered(email, uid, isAdmin = false) {
      // 拽  砖转砖 专 专砖 注专转
      db.collection('users').doc(uid).get()
        .then(doc => {
          if (!doc.exists) {
            // 住驻转 砖转砖 注专转
            return db.collection('users').doc(uid).set({
              userId: uid,
              email: email,
              displayName: email.split('@')[0],
              isAdmin: isAdmin,
              status: 'approved',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } else if (isAdmin && !doc.data().isAdmin) {
            // 注 砖转砖   爪专
            return db.collection('users').doc(uid).update({
              isAdmin: true,
              status: 'approved'
            });
          }
        })
        .catch(error => {
          console.error("Error checking user:", error);
        });
    }

    // 驻拽爪转 转
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showAuthError('   住住');
        return;
      }

      showLoader();
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
          hideLoader();
          console.error("Login error:", error);
          showAuthError('砖 转专转: ' + error.message);
        });
    }

    function register() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const displayName = document.getElementById('display-name').value.trim();

      if (!email || !password) {
        showAuthError('   住住');
        return;
      }

      if (password.length < 6) {
        showAuthError('住住 转  驻转 6 转');
        return;
      }

      if (!displayName) {
        showAuthError('   砖转砖');
        return;
      }

      showLoader();

      // 拽    
      if (email === adminEmail) {
        //   - 驻砖专  专砖 砖专转
        auth.createUserWithEmailAndPassword(email, password)
          .then(userCredential => {
            const user = userCredential.user;

            // 爪专转 专砖转 砖转砖  住
            return db.collection('users').doc(user.uid).set({
              userId: user.uid,
              email: email,
              displayName: displayName,
              isAdmin: true,
              status: 'approved',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          })
          .then(() => {
            hideLoader();
            // 砖转砖 注专 转 住  专  转
          })
          .catch(error => {
            hideLoader();
            console.error("Registration error:", error);
            showAuthError('砖 专砖: ' + error.message);
          });
      } else {
        // 专砖 砖转砖 专
        auth.createUserWithEmailAndPassword(email, password)
          .then(userCredential => {
            const user = userCredential.user;

            // 砖专转 注 注 砖转砖 注 住住 "转 砖专"
            return db.collection('users').doc(user.uid).set({
              userId: user.uid,
              email: email,
              displayName: displayName,
              isAdmin: false,
              status: 'pending',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          })
          .then(() => {
            hideLoader();
            alert('专砖转 爪! 拽砖 砖 转 砖专 . 转转拽 注专转 注 砖专.');
            // 转转拽转 转 注 砖专
            return auth.signOut();
          })
          .catch(error => {
            hideLoader();
            console.error("Registration error:", error);
            showAuthError('砖 专砖: ' + error.message);
          });
      }
    }

    function logout() {
      showLoader();
      auth.signOut()
        .catch(error => {
          hideLoader();
          console.error("Logout error:", error);
        });
    }

    function showAuthError(message) {
      const errorElement = document.getElementById('auth-error');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }

    // 砖 - 爪转 转专
    function showNotification(title, message, type = 'info') {
      const notificationsPanel = document.getElementById('notifications-panel');

      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.style.borderRightColor = type === 'success' ? 'var(--success)' :
                                            type === 'warning' ? 'var(--warning)' :
                                            type === 'danger' ? 'var(--danger)' : 'var(--primary)';

      notification.innerHTML = `
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
      `;

      notificationsPanel.appendChild(notification);

      // 住专转 转专 专 5 砖转
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          notificationsPanel.removeChild(notification);
        }, 300);
      }, 5000);
    }

    // 砖 - 拽转 转专 注
    function checkDeadlines() {
      if (!currentUser) return;

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      const threeDay = new Date(today);
      threeDay.setDate(threeDay.getDate() + 3);

      // 爪 砖转 注 转专 注 拽专
      db.collection('tasks')
        .where('assigneeId', '==', currentUser.uid)
        .where('status', '!=', 'completed')
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const task = doc.data();

            if (task.deadline) {
              const deadlineDate = new Date(task.deadline);
              deadlineDate.setHours(0, 0, 0, 0);

              if (deadlineDate.getTime() === tomorrow.getTime()) {
                showNotification('转专转 砖', `砖 "${task.name}" 爪专 住转 专!`, 'warning');
              } else if (deadlineDate.getTime() === today.getTime()) {
                showNotification('转专转 砖', `砖 "${task.name}" 爪专 住转 !`, 'danger');
              } else if (deadlineDate < today) {
                showNotification('砖 专', `砖 "${task.name}" 注专 转 转专 注!`, 'danger');
              } else if (deadlineDate <= threeDay) {
                showNotification('砖 转拽专转', `转专 驻转 -3  砖 "${task.name}"`, 'info');
              }
            }
          });
        });
    }

    // 砖 - 驻拽爪 驻 拽爪 砖注
    function handleFiles(files) {
      const filePreview = document.getElementById('file-preview');

      Array.from(files).forEach(file => {
        // 拽转  拽抓 (拽住 10MB)
        if (file.size > 10 * 1024 * 1024) {
          showNotification('砖', `拽抓 ${file.name}  . 拽住 10MB.`, 'danger');
          return;
        }

        // 住驻 注专 拽爪
        uploadedFiles.push(file);

        // 转爪 拽
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';

        // 拽注转 拽 驻 住 拽抓
        let icon = 'fa-file';
        if (file.type.startsWith('image/')) icon = 'fa-file-image';
        else if (file.type.startsWith('video/')) icon = 'fa-file-video';
        else if (file.type.startsWith('audio/')) icon = 'fa-file-audio';
        else if (file.type.includes('pdf')) icon = 'fa-file-pdf';
        else if (file.type.includes('word')) icon = 'fa-file-word';
        else if (file.type.includes('excel') || file.type.includes('sheet')) icon = 'fa-file-excel';

        fileItem.innerHTML = `
          <i class="fas ${icon}" style="margin-left: 5px;"></i>
          <span>${file.name}</span>
          <i class="fas fa-times file-delete" data-name="${file.name}"></i>
        `;

        filePreview.appendChild(fileItem);
      });

      // 住驻转 专注 拽
      document.querySelectorAll('.file-delete').forEach(deleteBtn => {
        deleteBtn.addEventListener('click', function() {
          const fileName = this.getAttribute('data-name');

          // 住专 注专
          uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);

          // 住专 转爪
          this.closest('.file-item').remove();
        });
      });
    }

    // 砖 - 注转 拽爪 -Firebase Storage
    async function uploadTaskFiles(taskId) {
      if (!uploadedFiles.length) return [];

      const filesMetadata = [];

      for (const file of uploadedFiles) {
        try {
          // 爪专转 驻 转 住专'
          const fileRef = storage.ref(`tasks/${taskId}/${Date.now()}_${file.name}`);

          // 注转 拽抓
          const snapshot = await fileRef.put(file);

          // 拽转 URL 砖 拽抓
          const downloadURL = await snapshot.ref.getDownloadURL();

          filesMetadata.push({
            name: file.name,
            path: snapshot.ref.fullPath,
            type: file.type,
            size: file.size,
            url: downloadURL,
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (error) {
          console.error(`Error uploading file ${file.name}:`, error);
        }
      }

      // 拽 注专 拽爪 拽 转
      uploadedFiles = [];
      document.getElementById('file-preview').innerHTML = '';

      return filesMetadata;
    }

    // 砖 - 注转 拽爪 砖 砖
    function loadTaskFiles(taskId) {
      const filePreview = document.getElementById('file-preview');
      filePreview.innerHTML = '';

      db.collection('tasks').doc(taskId).get()
        .then(doc => {
          if (doc.exists) {
            const task = doc.data();

            if (task.files && task.files.length > 0) {
              task.files.forEach(file => {
                // 拽注转 拽 驻 住 拽抓
                let icon = 'fa-file';
                if (file.type.startsWith('image/')) icon = 'fa-file-image';
                else if (file.type.startsWith('video/')) icon = 'fa-file-video';
                else if (file.type.startsWith('audio/')) icon = 'fa-file-audio';
                else if (file.type.includes('pdf')) icon = 'fa-file-pdf';
                else if (file.type.includes('word')) icon = 'fa-file-word';
                else if (file.type.includes('excel') || file.type.includes('sheet')) icon = 'fa-file-excel';

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                  <a href="${file.url}" target="_blank" style="display:flex; align-items:center; text-decoration:none; color:inherit;">
                    <i class="fas ${icon}" style="margin-left: 5px;"></i>
                    <span>${file.name}</span>
                  </a>
                  <i class="fas fa-times file-delete" data-id="${taskId}" data-path="${file.path}"></i>
                `;

                filePreview.appendChild(fileItem);
              });

              // 住驻转 专注 拽
              document.querySelectorAll('.file-delete').forEach(deleteBtn => {
                deleteBtn.addEventListener('click', function() {
                  const taskId = this.getAttribute('data-id');
                  const filePath = this.getAttribute('data-path');

                  if (confirm(' 转  砖专爪 拽 拽抓 ?')) {
                    deleteTaskFile(taskId, filePath, this.closest('.file-item'));
                  }
                });
              });
            } else {
              filePreview.innerHTML = '<div style="color:#888;"> 拽爪 爪专驻</div>';
            }
          }
        })
        .catch(error => {
          console.error("Error loading task files:", error);
        });
    }

    // 砖 - 拽转 拽抓 砖 砖
    function deleteTaskFile(taskId, filePath, fileElement) {
      showLoader();

      // 拽转 拽抓 住专'
      storage.ref(filePath).delete()
        .then(() => {
          // 注 砖 驻专住专
          return db.collection('tasks').doc(taskId).get()
            .then(doc => {
              if (doc.exists) {
                const task = doc.data();
                const updatedFiles = task.files.filter(file => file.path !== filePath);

                return db.collection('tasks').doc(taskId).update({
                  files: updatedFiles
                });
              }
            });
        })
        .then(() => {
          // 住专转  转爪
          if (fileElement) {
            fileElement.remove();
          }

          hideLoader();
          showNotification('拽抓 拽', '拽抓 拽 爪', 'success');

          //   拽爪 住驻, 住祝 注
          const filePreview = document.getElementById('file-preview');
          if (filePreview.children.length === 0) {
            filePreview.innerHTML = '<div style="color:#888;"> 拽爪 爪专驻</div>';
          }

          // 专注 住专转 驻注转
          logActivity(`拽 拽抓 砖`, taskId);
        })
        .catch(error => {
          hideLoader();
          console.error("Error deleting file:", error);
          showNotification('砖', '专注 砖 拽转 拽抓', 'danger');
        });
    }

    // 砖 - 驻拽爪转 住专转 驻注转
    // 驻拽爪 转注 驻注转 - 专转 转
  function logActivity(action, objectId, details = null) {
    // 驻拽爪 专转 转 注 专转 专砖转 转转
    console.debug('Activity logging disabled:', action, objectId, details);
    return Promise.resolve(); // 专 Promise 砖住转   砖专 注 转转
  }
    function loadActivityLog() {
      const activityLog = document.getElementById('activity-log');
      activityLog.innerHTML = '<li class="activity-item">注 住专...</li>';

      db.collection('activity_log')
        .orderBy('timestamp', 'desc')
        .limit(50)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            activityLog.innerHTML = '<li class="activity-item"> 驻注转 爪</li>';
            return;
          }

          activityLog.innerHTML = '';

          snapshot.forEach(doc => {
            const activity = doc.data();
            const date = activity.timestamp ? new Date(activity.timestamp.toDate()) : new Date();
            const timeStr = date.toLocaleString('he-IL');

            let actionIcon = '';

            // 转转 拽 驻注
            switch(activity.action) {
              case '爪专 驻专拽':
                actionIcon = 'fa-project-diagram';
                break;
              case '注专 驻专拽':
                actionIcon = 'fa-edit';
                break;
              case '拽 驻专拽':
                actionIcon = 'fa-trash-alt';
                break;
              case '爪专 砖':
                actionIcon = 'fa-tasks';
                break;
              case '注专 砖':
                actionIcon = 'fa-edit';
                break;
              case '拽 砖':
                actionIcon = 'fa-trash-alt';
                break;
              case '住祝 专 爪转':
                actionIcon = 'fa-user-plus';
                break;
              case '住专 专 爪转':
                actionIcon = 'fa-user-minus';
                break;
              case '注 拽抓':
                actionIcon = 'fa-file-upload';
                break;
              case '拽 拽抓':
                actionIcon = 'fa-file-excel';
                break;
              case '砖 砖':
                actionIcon = 'fa-check-circle';
                break;
              default:
                actionIcon = 'fa-history';
            }

            const activityItem = document.createElement('li');
            activityItem.className = 'activity-item';
            activityItem.innerHTML = `
              <span class="activity-icon"><i class="fas ${actionIcon}"></i></span>
              <strong>${activity.displayName}</strong> ${activity.action}
              ${activity.details ? `<div style="margin-top: 5px; color: #666;">${activity.details}</div>` : ''}
              <div><span class="activity-time">${timeStr}</span></div>
            `;

            activityLog.appendChild(activityItem);
          });
        })
        .catch(error => {
          console.error("Error loading activity log:", error);
          activityLog.innerHTML = '<li class="activity-item">砖 注转 住专</li>';
        });
    }

    // 砖 - 驻拽爪转 住住拽转 专驻
    function loadStats() {
      showLoader();

      // 拽转 专驻 拽
      for (const chartId in charts) {
        if (charts[chartId]) {
          charts[chartId].destroy();
        }
      }

      Promise.all([
        loadProjectsProgressChart(),
        loadTasksByStatusChart(),
        loadWeeklyTasksChart(),
        loadTasksByTagChart()
      ])
        .then(() => {
          hideLoader();
        })
        .catch(error => {
          console.error("Error loading statistics:", error);
          hideLoader();
          showNotification('砖', '专注 砖 注转 住住拽转', 'danger');
        });
    }

    function loadProjectsProgressChart() {
      return db.collection('projects')
        .where('userId', '==', currentUser.uid)
        .get()
        .then(projectsSnapshot => {
          const projectIds = projectsSnapshot.docs.map(doc => doc.id);

          if (projectIds.length === 0) {
            return [];
          }

          // 拽转 砖转  驻专拽
          const projectPromises = projectIds.map(projectId => {
            return db.collection('tasks')
              .where('projectId', '==', projectId)
              .get()
              .then(tasksSnapshot => {
                const totalTasks = tasksSnapshot.size;
                const completedTasks = tasksSnapshot.docs.filter(doc => doc.data().status === 'completed').length;
                const project = projectsSnapshot.docs.find(doc => doc.id === projectId).data();

                return {
                  name: project.name,
                  progress: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0,
                  totalTasks
                };
              });
          });

          return Promise.all(projectPromises);
        })
        .then(projectProgress => {
          //  驻专拽 驻 转 砖转 ( 转专 拽)
          projectProgress.sort((a, b) => b.totalTasks - a.totalTasks);

          //  -10 驻专拽 
          const topProjects = projectProgress.slice(0, 10);

          const ctx = document.getElementById('projects-progress-chart').getContext('2d');

          charts.projectsProgress = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: topProjects.map(p => p.name),
              datasets: [{
                label: '转拽转 ',
                data: topProjects.map(p => p.progress),
                backgroundColor: topProjects.map(p => {
                  // 爪注 驻  转拽转
                  if (p.progress >= 75) return 'rgba(40, 167, 69, 0.7)';
                  if (p.progress >= 50) return 'rgba(23, 162, 184, 0.7)';
                  if (p.progress >= 25) return 'rgba(255, 193, 7, 0.7)';
                  return 'rgba(220, 53, 69, 0.7)';
                }),
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  title: {
                    display: true,
                    text: ' 转拽转'
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: '砖 驻专拽'
                  }
                }
              },
              plugins: {
                legend: {
                  display: false
                }
              }
            }
          });
        });
    }

    function loadTasksByStatusChart() {
      return Promise.all([
        // 砖转 砖砖转砖 专 注
        db.collection('tasks')
          .where('assigneeId', '==', currentUser.uid)
          .get(),

        // 砖转 驻专拽 砖
        db.collection('projects')
          .where('userId', '==', currentUser.uid)
          .where('type', '==', 'personal')
          .get()
          .then(projectsSnapshot => {
            const projectIds = projectsSnapshot.docs.map(doc => doc.id);
            if (projectIds.length === 0) return { docs: [] };

            return db.collection('tasks')
              .where('projectId', 'in', projectIds)
              .get();
          })
      ])
        .then(([assignedTasks, personalTasks]) => {
          //  砖转 注专 
          const allTasks = [...assignedTasks.docs, ...personalTasks.docs];

          // 住驻专转 砖转 驻 住住
          const statusCounts = {
            'not-started': 0,
            'in-progress': 0,
            'waiting': 0,
            'blocked': 0,
            'completed': 0
          };

          allTasks.forEach(doc => {
            const status = doc.data().status || 'not-started';
            if (statusCounts[status] !== undefined) {
              statusCounts[status]++;
            }
          });

          const ctx = document.getElementById('tasks-by-status-chart').getContext('2d');

          charts.tasksByStatus = new Chart(ctx, {
            type: 'pie',
            data: {
              labels: [
                '专 转',
                '转',
                '转',
                '转拽注',
                '砖'
              ],
              datasets: [{
                data: [
                  statusCounts['not-started'],
                  statusCounts['in-progress'],
                  statusCounts['waiting'],
                  statusCounts['blocked'],
                  statusCounts['completed']
                ],
                backgroundColor: [
                  '#e9ecef',
                  '#4895ef',
                  '#ffc107',
                  '#dc3545',
                  '#28a745'
                ]
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'bottom',
                }
              }
            }
          });
        });
    }

    function loadWeeklyTasksChart() {
      // 爪专转 转专 砖注
      const dates = [];
      const today = new Date();

      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(today.getDate() - i);
        dates.push(date);
      }

      return Promise.all([
        // 砖转 砖砖转砖 专 注
        db.collection('tasks')
          .where('assigneeId', '==', currentUser.uid)
          .get(),

        // 砖转 驻专拽 砖
        db.collection('projects')
          .where('userId', '==', currentUser.uid)
          .where('type', '==', 'personal')
          .get()
          .then(projectsSnapshot => {
            const projectIds = projectsSnapshot.docs.map(doc => doc.id);
            if (projectIds.length === 0) return { docs: [] };

            return db.collection('tasks')
              .where('projectId', 'in', projectIds)
              .get();
          })
      ])
        .then(([assignedTasks, personalTasks]) => {
          //  砖转 注专 
          const allTasks = [...assignedTasks.docs, ...personalTasks.docs].map(doc => {
            const data = doc.data();
            return {
              deadline: data.deadline,
              status: data.status
            };
          });

          // 专 砖转 驻 转专
          const tasksByDate = dates.map(date => {
            const dateStr = date.toISOString().split('T')[0];

            return {
              date: dateStr,
              label: new Intl.DateTimeFormat('he-IL', { weekday: 'short', day: 'numeric', month: 'numeric' }).format(date),
              count: allTasks.filter(task => task.deadline === dateStr).length,
              completed: allTasks.filter(task => task.deadline === dateStr && task.status === 'completed').length
            };
          });

          const ctx = document.getElementById('weekly-tasks-chart').getContext('2d');

          charts.weeklyTasks = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: tasksByDate.map(d => d.label),
              datasets: [
                {
                  label: '住 砖转',
                  data: tasksByDate.map(d => d.count),
                  backgroundColor: 'rgba(54, 162, 235, 0.7)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1
                },
                {
                  label: '砖转 砖砖',
                  data: tasksByDate.map(d => d.completed),
                  backgroundColor: 'rgba(75, 192, 192, 0.7)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 1
                }
              ]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: '住驻专 砖转'
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: '转专'
                  }
                }
              }
            }
          });
        });
    }

    function loadTasksByTagChart() {
      return Promise.all([
        // 砖转 砖砖转砖 专 注
        db.collection('tasks')
          .where('assigneeId', '==', currentUser.uid)
          .get(),

        // 砖转 驻专拽 砖
        db.collection('projects')
          .where('userId', '==', currentUser.uid)
          .where('type', '==', 'personal')
          .get()
          .then(projectsSnapshot => {
            const projectIds = projectsSnapshot.docs.map(doc => doc.id);
            if (projectIds.length === 0) return { docs: [] };

            return db.collection('tasks')
              .where('projectId', 'in', projectIds)
              .get();
          })
      ])
        .then(([assignedTasks, personalTasks]) => {
          //  砖转 注专 
          const allTasks = [...assignedTasks.docs, ...personalTasks.docs];

          // 住驻专转 砖转 驻 转转
          const tagCounts = {};

          allTasks.forEach(doc => {
            const tags = doc.data().tags || [];
            tags.forEach(tag => {
              if (!tagCounts[tag]) {
                tagCounts[tag] = 0;
              }
              tagCounts[tag]++;
            });
          });

          //  转转 驻 砖转 (驻爪转 转专 拽)
          const sortedTags = Object.entries(tagCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10); // Top 10 tags

          const ctx = document.getElementById('tasks-by-tag-chart').getContext('2d');

          // 爪专转 爪注 拽专 转转
          const colors = sortedTags.map((_, index) => {
            const hue = (index * 137) % 360; // 驻专 爪注
            return `hsla(${hue}, 70%, 60%, 0.7)`;
          });

          charts.tasksByTag = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: sortedTags.map(tag => tag[0]),
              datasets: [{
                data: sortedTags.map(tag => tag[1]),
                backgroundColor: colors,
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right',
                }
              }
            }
          });
        });
    }

    // 砖 - 爪 转
    function exportTasks() {
      if (!userDashboardTasks || userDashboardTasks.length === 0) {
        showNotification(' 砖转 爪', ' 爪 砖转 爪', 'warning');
        return;
      }

      // 转 CSV
      let csvContent = '砖 砖,驻专拽,转专,转专 注,住住,转转\n';

      userDashboardTasks.forEach(task => {
        const project = allProjects.find(p => p.id === task.data.projectId);
        const projectName = project ? project.data.name : '';
        const description = task.data.description ? task.data.description.replace(/,/g, ' ').replace(/\n/g, ' ') : '';
        const deadline = task.data.deadline || '';
        const status = statusLabels[task.data.status] || '';
        const tags = task.data.tags ? task.data.tags.join(';') : '';

        csvContent += `"${task.data.name}","${projectName}","${description}","${deadline}","${status}","${tags}"\n`;
      });

      // 爪专转 拽抓 专
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `砖转_${new Date().toLocaleDateString('he-IL')}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showNotification('爪 砖', '砖转 爪 爪 拽抓 CSV', 'success');

      // 专砖 驻注转
      logActivity('爪 砖转', currentUser.uid, `爪 ${userDashboardTasks.length} 砖转`);
    }

    // 砖 - 爪' 砖
    function showTaskChat(taskId, taskName) {
      document.getElementById('chat-task-name').textContent = taskName;
      document.getElementById('chat-task-id').value = taskId;
      document.getElementById('chat-message').value = '';

      // 注转 注转 爪' 拽转
      const chatContainer = document.getElementById('task-chat-messages');
      chatContainer.innerHTML = '<div class="chat-message"><div class="chat-message-content">注 注转...</div></div>';

      db.collection('task_messages')
        .where('taskId', '==', taskId)
        .orderBy('timestamp', 'asc')
        .get()
        .then(snapshot => {
          chatContainer.innerHTML = '';

          if (snapshot.empty) {
            chatContainer.innerHTML = `
              <div class="chat-message">
                <div class="chat-message-sender">注专转</div>
                <div class="chat-message-time">注砖</div>
                <div class="chat-message-content">专  爪' 砖!</div>
              </div>
            `;
            return;
          }

          snapshot.forEach(doc => {
            const message = doc.data();
            addChatMessageToUI(message, currentUser.uid);
          });

          //  转转转
          chatContainer.scrollTop = chatContainer.scrollHeight;
        })
        .catch(error => {
          console.error("Error loading chat messages:", error);
          chatContainer.innerHTML = '<div class="chat-message"><div class="chat-message-content">砖 注转 注转</div></div>';
        });

      document.getElementById('task-chat-modal').style.display = 'block';
    }

    function sendChatMessage() {
      const message = document.getElementById('chat-message').value.trim();
      const taskId = document.getElementById('chat-task-id').value;

      if (!message || !taskId) return;

      // 砖转 注 驻专住专
      const messageData = {
        taskId: taskId,
        userId: currentUser.uid,
        displayName: currentUser.displayName || currentUser.email.split('@')[0],
        message: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection('task_messages').add(messageData)
        .then(() => {
          // 拽 砖 
          document.getElementById('chat-message').value = '';

          // 住驻转 注 -UI
          addChatMessageToUI({
            ...messageData,
            timestamp: new Date()
          }, currentUser.uid);

          //  转转转
          const chatContainer = document.getElementById('task-chat-messages');
          chatContainer.scrollTop = chatContainer.scrollHeight;

          // 注  注 专 砖 砖
          db.collection('tasks').doc(taskId).update({
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });

          // 专砖 驻注转
          // 专砖 驻注转
  logActivity('砖 注 爪', taskId, '砖 注 爪 砖');
        })
        .catch(error => {
          console.error("Error sending message:", error);
          showNotification('砖', '专注 砖 砖转 注', 'danger');
        });
    }

    function addChatMessageToUI(message, currentUserId) {
      const chatContainer = document.getElementById('task-chat-messages');
      const isCurrentUser = message.userId === currentUserId;

      const messageElement = document.createElement('div');
      messageElement.className = `chat-message ${isCurrentUser ? 'outgoing' : ''}`;

      // 驻专 转专
      const timestamp = message.timestamp instanceof Date ? message.timestamp :
                        message.timestamp ? new Date(message.timestamp.toDate()) : new Date();
      const timeStr = timestamp.toLocaleTimeString('he-IL', {
        hour: '2-digit',
        minute: '2-digit'
      });

      messageElement.innerHTML = `
        ${!isCurrentUser ? `<div class="chat-message-sender">${message.displayName}</div>` : ''}
        <div class="chat-message-time">${timeStr}</div>
        <div class="chat-message-content">${message.message}</div>
      `;

      chatContainer.appendChild(messageElement);
    }

    // 驻拽爪转 转转
    function addTag(tagName) {
      const tagsContainer = document.getElementById('task-tags-items');
      const existingTags = Array.from(tagsContainer.querySelectorAll('.tag-item')).map(tag =>
        tag.textContent.replace('', '').trim()
      );

      if (existingTags.includes(tagName)) {
        return; // 注转 驻转
      }

      const tagElement = document.createElement('div');
      tagElement.className = 'tag-item';
      tagElement.innerHTML = `
        ${tagName}
        <span class="tag-close"></span>
      `;

      tagElement.querySelector('.tag-close').addEventListener('click', function() {
        tagElement.remove();
        updateTagsHiddenField();
      });

      tagsContainer.appendChild(tagElement);
      updateTagsHiddenField();
    }

    function updateTagsHiddenField() {
      const tagsContainer = document.getElementById('task-tags-items');
      const tags = Array.from(tagsContainer.querySelectorAll('.tag-item')).map(tag =>
        tag.textContent.replace('', '').trim()
      );

      document.getElementById('task-tags-hidden').value = JSON.stringify(tags);
    }

    function loadTagsToInput(tags) {
      const tagsContainer = document.getElementById('task-tags-items');
      tagsContainer.innerHTML = '';

      if (tags && tags.length > 0) {
        tags.forEach(tag => addTag(tag));
      }
    }

    // 驻拽爪 住驻转 专 爪转
    function showAddMemberModal() {
      document.getElementById('member-email').value = '';
      document.getElementById('member-search-results').innerHTML = '';
      document.getElementById('add-member-confirm-btn').disabled = true;
      document.getElementById('team-member-modal').style.display = 'block';
    }

    // 驻拽爪转 住 砖专
    function loadDashboard() {
      showLoader();

      // 专砖转 注 转  驻专拽 注专 住
      updateProjectsDropdown();

      // 注转 砖转 砖 砖转砖
      Promise.all([
        // 砖转 砖砖转砖 专 注
        db.collection('tasks')
          .where('assigneeId', '==', currentUser.uid)
          .get(),

        // 砖转 驻专拽 砖 砖 砖转砖
        db.collection('projects')
          .where('userId', '==', currentUser.uid)
          .where('type', '==', 'personal')
          .get()
          .then(projectsSnapshot => {
            const projectIds = projectsSnapshot.docs.map(doc => doc.id);
            if (projectIds.length === 0) return { docs: [] };

            return db.collection('tasks')
              .where('projectId', 'in', projectIds)
              .get();
          }),

        // 砖转 砖 拽砖转 注专 驻专拽 砖 砖转砖
        db.collection('projects')
          .where('userId', '==', currentUser.uid)
          .get()
          .then(projectsSnapshot => {
            const projectIds = projectsSnapshot.docs.map(doc => doc.id);
            if (projectIds.length === 0) return { docs: [] };

            return db.collection('tasks')
              .where('projectId', 'in', projectIds)
              .where('isHelpRequest', '==', true)
              .get();
          }),

        // 拽砖转 注专 驻专拽 砖砖转砖 专 
        db.collection('project_members')
          .where('userId', '==', currentUser.uid)
          .get()
          .then(membershipsSnapshot => {
            const projectIds = membershipsSnapshot.docs.map(doc => doc.data().projectId);
            if (projectIds.length === 0) return { docs: [] };

            // Firebase  queries -10 注专 -in  转专
            const projectBatches = [];
            for (let i = 0; i < projectIds.length; i += 10) {
              const batch = projectIds.slice(i, i + 10);
              projectBatches.push(batch);
            }

            const queries = projectBatches.map(batch =>
              db.collection('tasks')
                .where('projectId', 'in', batch)
                .where('isHelpRequest', '==', true)
                .get()
            );

            return Promise.all(queries).then(results => {
              //  转爪转  -queries
              const mergedDocs = [];
              results.forEach(result => {
                result.docs.forEach(doc => mergedDocs.push(doc));
              });
              return { docs: mergedDocs };
            });
          })
      ])
      .then(([assignedTasks, personalTasks, ownedHelpTasks, memberHelpTasks]) => {
        //   砖转 注转 驻转
        const uniqueTasks = new Map();

        function addToMap(snapshot, source) {
          snapshot.docs.forEach(doc => {
            if (!uniqueTasks.has(doc.id)) {
              const taskData = doc.data();
              uniqueTasks.set(doc.id, {
                id: doc.id,
                data: taskData,
                source: source
              });

              // 砖专转 转转 住
              if (taskData.tags && taskData.tags.length > 0) {
                taskData.tags.forEach(tag => allTags.add(tag));
              }
            }
          });
        }

        addToMap(assignedTasks, 'assigned');
        addToMap(personalTasks, 'personal');
        addToMap(ownedHelpTasks, 'ownedHelp');
        addToMap(memberHelpTasks, 'memberHelp');

        // 砖专转 砖转 砖转 
        userDashboardTasks = Array.from(uniqueTasks.values());

        // 注 住 砖 转转
        updateTagsDropdown();

        // 拽转 转专 注
        checkDeadlines();

        // 爪转 砖转 砖专
        filterDashboardTasks();

        hideLoader();
      })
      .catch(error => {
        console.error("Error loading dashboard:", error);
        hideLoader();
        showNotification('砖 注转 砖转', error.message, 'danger');
      });
    }

    function updateProjectsDropdown() {
      const projectSelect = document.getElementById('dashboard-filter-project');
      projectSelect.innerHTML = '<option value="all"> 驻专拽</option>';

      allProjects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.data.name;
        projectSelect.appendChild(option);
      });
    }

    function updateTagsDropdown() {
      const tagSelect = document.getElementById('dashboard-filter-tag');
      tagSelect.innerHTML = '<option value="all"> 转转</option>';

      allTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        tagSelect.appendChild(option);
      });
    }

    function filterDashboardTasks(searchTerm = '') {
      const projectFilter = document.getElementById('dashboard-filter-project').value;
      const sortBy = document.getElementById('dashboard-sort-by').value;
      const tagFilter = document.getElementById('dashboard-filter-tag').value;
      const statusFilter = document.getElementById('dashboard-filter-status').value;

      // 住 砖转
      let filteredTasks = userDashboardTasks.filter(task => {
        // 住 驻 驻专拽
        if (projectFilter !== 'all' && task.data.projectId !== projectFilter) {
          return false;
        }

        // 住 驻 转转
        if (tagFilter !== 'all') {
          const taskTags = task.data.tags || [];
          if (!taskTags.includes(tagFilter)) {
            return false;
          }
        }

        // 住 驻 住住
        if (statusFilter !== 'all' && task.data.status !== statusFilter) {
          return false;
        }

        // 住 驻 拽住 驻砖
        if (searchTerm) {
          const searchLower = searchTerm.toLowerCase();
          const nameMatch = task.data.name && task.data.name.toLowerCase().includes(searchLower);
          const descMatch = task.data.description && task.data.description.toLowerCase().includes(searchLower);
          const tagsMatch = task.data.tags && task.data.tags.some(tag => tag.toLowerCase().includes(searchLower));

          return nameMatch || descMatch || tagsMatch;
        }

        return true;
      });

      //  砖转
      filteredTasks.sort((a, b) => {
        switch (sortBy) {
          case 'deadline':
            //   转专, 砖 住祝
            if (!a.data.deadline) return 1;
            if (!b.data.deadline) return -1;
            return new Date(a.data.deadline) - new Date(b.data.deadline);
          case 'name':
            return a.data.name.localeCompare(b.data.name);
          case 'project':
            const projectA = allProjects.find(p => p.id === a.data.projectId);
            const projectB = allProjects.find(p => p.id === b.data.projectId);
            return (projectA?.data.name || '').localeCompare(projectB?.data.name || '');
          case 'status':
            const statusOrder = {
              'blocked': 0,
              'waiting': 1,
              'not-started': 2,
              'in-progress': 3,
              'completed': 4
            };
            const statusA = statusOrder[a.data.status] || 999;
            const statusB = statusOrder[b.data.status] || 999;
            return statusA - statusB;
          default:
            return 0;
        }
      });

      // 爪转 砖转
      displayDashboardTasks(filteredTasks);
    }

    function displayDashboardTasks(tasks) {
      const pendingTasksContainer = document.getElementById('dashboard-tasks');
      const completedTasksContainer = document.getElementById('dashboard-completed-tasks');
      const helpTasksContainer = document.getElementById('dashboard-help-tasks');

      pendingTasksContainer.innerHTML = '';
      completedTasksContainer.innerHTML = '';
      helpTasksContainer.innerHTML = '';

      // 拽  砖 砖转
      if (tasks.length === 0) {
        pendingTasksContainer.innerHTML = '<div> 砖转 转爪.</div>';
        completedTasksContainer.innerHTML = '<div> 砖转 砖砖.</div>';
        helpTasksContainer.innerHTML = '<div> 拽砖转 注专.</div>';
        return;
      }

      // 住 砖转 驻 住
      const completedTasks = tasks.filter(task => task.data.status === 'completed');
      const helpTasks = tasks.filter(task => task.data.isHelpRequest && task.data.status !== 'completed');
      const pendingTasks = tasks.filter(task => task.data.status !== 'completed' && !task.data.isHelpRequest);

      // 爪转 砖转 驻转转
      if (pendingTasks.length === 0) {
        pendingTasksContainer.innerHTML = '<div> 砖转 爪注.</div>';
      } else {
        pendingTasks.forEach(task => {
          pendingTasksContainer.appendChild(createDashboardTaskElement(task));
        });
      }

      // 爪转 砖转 砖砖
      if (completedTasks.length === 0) {
        completedTasksContainer.innerHTML = '<div> 砖转 砖砖.</div>';
      } else {
        completedTasks.forEach(task => {
          completedTasksContainer.appendChild(createDashboardTaskElement(task));
        });
      }

      // 爪转 拽砖转 注专
      if (helpTasks.length === 0) {
        helpTasksContainer.innerHTML = '<div> 拽砖转 注专 专注.</div>';
      } else {
        helpTasks.forEach(task => {
          helpTasksContainer.appendChild(createDashboardTaskElement(task));
        });
      }
    }

    function createDashboardTaskElement(task) {
  // 爪 转 驻专拽 砖
  const project = allProjects.find(p => p.id === task.data.projectId) || { data: { name: '驻专拽  注' } };

  // 爪专转  砖
  const taskElement = document.createElement('div');
  taskElement.className = `task-item ${task.data.status === 'completed' ? 'completed' : ''} ${task.data.isHelpRequest ? 'help-request' : ''}`;

  // 拽转 转专 注 祝
  let dueDateClass = '';
  let dueDateText = ' 转专 注';

  if (task.data.deadline) {
    const dueDate = new Date(task.data.deadline);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (dueDate < today && task.data.status !== 'completed') {
      dueDateClass = 'overdue';
    }

    dueDateText = dueDate.toLocaleDateString('he-IL');
  }

  // 爪专转 转转
  let tagsHtml = '';

  if (task.data.tags && task.data.tags.length > 0) {
    tagsHtml = '<div class="tags-container">';

    task.data.tags.forEach(tag => {
      const tagClass = getTagColorClass(tag);
      tagsHtml += '<span class="tag ' + tagClass + '">' + tag + '</span>';
    });

    tagsHtml += '</div>';
  }

  // 拽转 转专 住住 砖
  const statusClass = `status-${task.data.status || 'not-started'}`;
  const statusText = statusLabels[task.data.status || 'not-started'];
  const statusHtml = `<span class="task-status ${statusClass}">${statusText}</span>`;

  // 转 转 -HTML
  let innerHtml = '';

  // 拽 专砖 - 转 砖
  innerHtml += '<div style="display: flex; align-items: flex-start;">';
  innerHtml += '<div class="task-content">';
  innerHtml += '<h4 class="task-title">' + task.data.name + '</h4>';
  innerHtml += '<div class="task-description">' + (task.data.description || ' 转专') + '</div>';
  innerHtml += '<div class="task-meta">';
  innerHtml += '<span><i class="fas fa-briefcase"></i> ' + (project.data ? project.data.name : '驻专拽  注') + '</span>';
  innerHtml += '<span class="task-due-date ' + dueDateClass + '"><i class="fas fa-calendar-alt"></i> ' + dueDateText + '</span>';
  innerHtml += statusHtml;

  if (task.data.isHelpRequest) {
    innerHtml += '<span class="badge" style="background-color: var(--warning); color: white;"><i class="fas fa-hands-helping"></i> 拽砖转 注专</span>';
  }

  // 注 注 专 砖 (专拽 驻专拽 爪转)
  if (task.data.assigneeId && project.data.type === 'team') {
    // 驻砖 专 专砖转 专 爪转 砖 驻专拽
    const projectMembers = currentProjectMembers.filter(member => member.userId === task.data.assigneeId);
    let assigneeName = ' 注';
    let assigneeInitial = '?';

    if (projectMembers.length > 0) {
      assigneeName = projectMembers[0].displayName || projectMembers[0].email || '砖转砖';
      assigneeInitial = (assigneeName.charAt(0) || '?').toUpperCase();
    } else if (task.data.assigneeId === currentUser.uid) {
      assigneeName = currentUser.displayName || currentUser.email || '砖转砖';
      assigneeInitial = (assigneeName.charAt(0) || '?').toUpperCase();
    }

    innerHtml += '<span class="task-assignee">';
    innerHtml += `<span class="assignee-avatar">${assigneeInitial}</span>`;
    innerHtml += `<span>${assigneeName}</span>`;
    innerHtml += '</span>';
  }

  innerHtml += '</div>'; // 住专转 task-meta
  innerHtml += tagsHtml;
  innerHtml += '</div>'; // 住专转 task-content
  innerHtml += '</div>'; // 住专转 div 注

  // 拽 砖 - 驻转专 驻注
  innerHtml += '<div class="task-actions">';
  innerHtml += '<button class="btn btn-sm chat-task" data-id="' + task.id + '" data-name="' + task.data.name + '">';
  innerHtml += '<i class="fas fa-comments"></i>';
  innerHtml += '</button>';
  innerHtml += '<button class="btn btn-sm view-task" data-project-id="' + task.data.projectId + '" data-task-id="' + task.id + '">';
  innerHtml += '<i class="fas fa-eye"></i>';
  innerHtml += '</button>';

  if (task.data.isHelpRequest && !task.data.assigneeId) {
    innerHtml += '<button class="btn btn-sm btn-warning take-help-task" data-id="' + task.id + '">';
    innerHtml += '<i class="fas fa-hand-holding-heart"></i> 拽 砖';
    innerHtml += '</button>';
  }

  innerHtml += '</div>'; // 住专转 task-actions

  // 住驻转 -HTML 
  taskElement.innerHTML = innerHtml;

  // 住驻转 专注
  const chatButton = taskElement.querySelector('.chat-task');
  if (chatButton) {
    chatButton.addEventListener('click', function() {
      const taskId = this.getAttribute('data-id');
      const taskName = this.getAttribute('data-name');
      showTaskChat(taskId, taskName);
    });
  }

  const viewButton = taskElement.querySelector('.view-task');
  if (viewButton) {
    viewButton.addEventListener('click', function() {
      const projectId = this.getAttribute('data-project-id');
      const taskId = this.getAttribute('data-task-id');
      openProject(projectId, null, taskId);
    });
  }

  const takeHelpButton = taskElement.querySelector('.take-help-task');
  if (takeHelpButton) {
    takeHelpButton.addEventListener('click', function() {
      const taskId = this.getAttribute('data-id');
      takeHelpTask(taskId);
    });
  }

  return taskElement;
}
    function getTagColorClass(tag) {
      // 转 爪注 转转 驻 砖
      const tagLower = tag.toLowerCase();

      if (tagLower.includes('祝') || tagLower.includes('砖')) {
        return 'tag-red';
      } else if (tagLower.includes('')) {
        return 'tag-yellow';
      } else if (tagLower.includes('')) {
        return 'tag-green';
      } else if (tagLower.includes('') || tagLower.includes('转拽')) {
        return 'tag-red';
      } else if (tagLower.includes('驻转')) {
        return 'tag-blue';
      } else if (tagLower.includes('注爪')) {
        return 'tag-purple';
      } else if (tagLower.includes('转')) {
        return 'tag-cyan';
      }

      //   转 住驻爪驻转, 专 爪注 驻 hash 砖 砖
      const hash = tag.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 6;

      const colors = ['tag-blue', 'tag-green', 'tag-red', 'tag-yellow', 'tag-purple', 'tag-cyan'];
      return colors[hash];
    }

    function takeHelpTask(taskId) {
      if (!confirm(' 转  砖专爪 拽转 转 砖?')) {
        return;
      }

      showLoader();

      db.collection('tasks').doc(taskId).update({
        assigneeId: currentUser.uid,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        hideLoader();
        loadDashboard(); // 专注 砖专
        showNotification('砖 住驻', '砖 住驻 砖转 砖', 'success');

        // 专砖 驻注转
        logActivity('拽 砖转 注专', taskId);
      })
      .catch(error => {
        hideLoader();
        console.error("Error taking help task:", error);
        showNotification('砖', '砖 拽转 砖: ' + error.message, 'danger');
      });
    }

    // 驻砖 砖转砖 驻 
    // 驻砖 砖转砖 驻   砖 砖转砖
  function searchUserByEmailOrName() {
    const searchTerm = document.getElementById('member-email').value.trim();
    const resultsDiv = document.getElementById('member-search-results');

    if (!searchTerm || searchTerm.length < 3) {
      resultsDiv.innerHTML = '<div> 驻转 3 转 驻砖</div>';
      return;
    }

    resultsDiv.innerHTML = '<div class="text-center">驻砖 砖转砖...</div>';

    // 砖 砖  砖拽
    document.getElementById('member-email-label').textContent = '驻砖 (  砖):';

    // 驻砖 驻  拽
    const emailQuery = db.collection('users')
      .where('email', '==', searchTerm.toLowerCase())
      .where('status', '==', 'approved')  // 专拽 砖转砖 砖专
      .limit(5);

    // 驻砖 驻 砖 砖转砖
    const nameQuery = db.collection('users')
      .where('displayName', '>=', searchTerm)
      .where('displayName', '<=', searchTerm + '\uf8ff') // 专拽 驻砖 prefix
      .where('status', '==', 'approved')  // 专拽 砖转砖 砖专
      .limit(5);

    // 爪注 砖 驻砖 拽
    Promise.all([emailQuery.get(), nameQuery.get()])
      .then(([emailResults, nameResults]) => {
        const uniqueUsers = new Map(); // 注转 驻转

        // 住驻转 转爪转 驻砖 驻 
        emailResults.forEach(doc => {
          uniqueUsers.set(doc.id, doc.data());
        });

        // 住驻转 转爪转 驻砖 驻 砖
        nameResults.forEach(doc => {
          uniqueUsers.set(doc.id, doc.data());
        });

        if (uniqueUsers.size === 0) {
          resultsDiv.innerHTML = '<div style="color: var(--danger); padding: 10px; background-color: #f8d7da; border-radius: 4px; margin-top: 10px;">砖转砖  爪.  转 专砖 注专转.</div>';
          document.getElementById('add-member-confirm-btn').disabled = true;
          return;
        }

        let resultsHTML = '';
        let foundUsers = [];

        // 注 转爪转
        uniqueUsers.forEach((userData, userId) => {
          // 拽  砖转砖 专 驻专拽
          const isMember = currentProjectMembers.some(member => member.userId === userId);

          foundUsers.push({
            userId: userId,
            email: userData.email,
            displayName: userData.displayName || userData.email.split('@')[0],
            isMember: isMember
          });
        });

        // 爪转 转爪转
        if (foundUsers.length > 0) {
          resultsHTML = '<div style="margin-top: 15px;">';

          foundUsers.forEach(user => {
            resultsHTML += `
              <div class="user-search-result ${user.isMember ? 'already-member' : ''}"
                   data-id="${user.userId}"
                   data-email="${user.email}"
                   data-name="${user.displayName}"
                   style="background-color: #f0f0f0; padding: 15px; border-radius: var(--radius); margin-bottom: 10px; cursor: pointer; ${user.isMember ? 'opacity: 0.7;' : ''}">
                <div style="font-weight: 500; font-size: 16px;">${user.displayName}</div>
                <div style="color: #666;">${user.email}</div>
                ${user.isMember ? '<div style="color: var(--warning); margin-top: 5px;">砖转砖  专 专 驻专拽</div>' : ''}
              </div>
            `;
          });

          resultsHTML += '</div>';
          resultsDiv.innerHTML = resultsHTML;

          // 住驻转 专注 专转 砖转砖
          document.querySelectorAll('.user-search-result').forEach(result => {
            result.addEventListener('click', function() {
              if (this.classList.contains('already-member')) {
                return; //  专 专   注砖 
              }

              // 住  转爪转  专转
              document.querySelectorAll('.user-search-result').forEach(el => {
                el.classList.remove('selected');
                el.style.border = 'none';
              });

              // 住 专
              this.classList.add('selected');
              this.style.border = '2px solid var(--primary)';

              // 驻注转 驻转专 住驻
              const addButton = document.getElementById('add-member-confirm-btn');
              addButton.disabled = false;

              // 砖专转 驻专 砖转砖 专 驻转专
              addButton.dataset.id = this.dataset.id;
              addButton.dataset.email = this.dataset.email;
              addButton.dataset.name = this.dataset.name;
            });
          });
        }
      })
      .catch(error => {
        console.error("Error searching for user:", error);
        resultsDiv.innerHTML = '<div style="color: var(--danger);">砖 驻砖 砖转砖</div>';
      });
  }
    // 住驻转 专 驻专拽
    function addMemberToProject() {
    const addButton = document.getElementById('add-member-confirm-btn');

    // 拽  专 砖转砖
    if (addButton.disabled || !addButton.dataset.id) {
      alert(' 专 砖转砖 住驻');
      return;
    }

    const userId = addButton.dataset.id;
    const userEmail = addButton.dataset.email;
    const userName = addButton.dataset.name;

    showLoader();

    // 拽  砖转砖 专 拽 驻专拽
    if (currentProjectMembers.some(member => member.userId === userId)) {
      hideLoader();
      alert('砖转砖  专 拽 驻专拽');
      return;
    }

    // 住驻转 砖转砖 专砖转 专 砖 驻专拽
    db.collection('project_members').add({
      projectId: currentProjectId,
      userId: userId,
      email: userEmail,
      displayName: userName,
      role: 'member',
      addedBy: currentUser.uid,
      addedAt: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
      hideLoader();
      document.getElementById('team-member-modal').style.display = 'none';

      // 专砖 驻注转
      logActivity('住祝 专 爪转', currentProjectId, `住祝 转 ${userName} 驻专拽`);

      showNotification('专 爪转 住祝', '专 爪转 住祝 爪 驻专拽', 'success');

      loadProjectMembers(currentProjectId);
    })
    .catch(error => {
      hideLoader();
      console.error("Error adding team member:", error);
      alert('砖 住驻转 专 爪转');
    });
  }

    // 驻拽爪转 驻专拽
    function loadProjects() {
      showLoader();
      const projectsList = document.getElementById('projects-list');
      projectsList.innerHTML = '<div>注 驻专拽...</div>';

      // 转 注 专拽 驻专拽 砖砖转砖  注 砖
      db.collection('projects')
        .where('userId', '==', currentUser.uid)
        .get()
        .then(snapshot => {
          let allProjectsList = [];

          snapshot.forEach(doc => {
            const project = doc.data();
            allProjectsList.push({
              id: doc.id,
              data: project,
              role: 'owner',
              type: project.type || 'personal'
            });
          });

          // 砖专转 驻专拽 砖转 
          allProjects = allProjectsList;

          // 住 驻 住 砖专  爪专
          if (currentFilter !== "all") {
            allProjectsList = allProjectsList.filter(p => p.data.type === currentFilter);
          }

          // 住 驻 驻砖  拽
          const searchTerm = document.getElementById('search-projects').value.trim().toLowerCase();
          if (searchTerm) {
            allProjectsList = filterProjectsBySearchTerm(allProjectsList, searchTerm);
          }

          // 爪转 驻专拽
          displayProjects(allProjectsList);
          hideLoader();

          // 专拽 专 砖爪转 转 驻专拽 砖 砖转砖, 住 注  驻专拽 砖 专 
          if (currentFilter === "all" || currentFilter === "team") {
            loadTeamProjects();
          }
        })
        .catch(error => {
          console.error("Error loading projects:", error);
          projectsList.innerHTML = '<div>砖 注转 驻专拽. 住 砖 专 转专.</div>';
          hideLoader();
        });
    }

    // 驻拽爪 住 驻专拽 驻  驻砖
    function filterProjectsBySearchTerm(projects, searchTerm) {
      return projects.filter(project => {
        const nameMatch = project.data.name && project.data.name.toLowerCase().includes(searchTerm);
        const descMatch = project.data.description && project.data.description.toLowerCase().includes(searchTerm);
        return nameMatch || descMatch;
      });
    }

    // 驻拽爪 住 驻专拽 驻  驻砖 (砖砖 抓 转 注)
    function filterProjects(searchTerm) {
      let filteredProjects = [...allProjects];

      // 住 驻 住  专
      if (currentFilter !== "all") {
        filteredProjects = filteredProjects.filter(p => p.data.type === currentFilter);
      }

      // 住 驻  驻砖
      if (searchTerm) {
        filteredProjects = filterProjectsBySearchTerm(filteredProjects, searchTerm);
      }

      displayProjects(filteredProjects);
    }

    // 驻拽爪 驻专转 注转 驻专拽 爪转 砖砖转砖 专 
    function loadTeamProjects() {
      db.collection('project_members')
        .where('userId', '==', currentUser.uid)
        .get()
        .then(memberships => {
          if (memberships.empty) return;

          const projectIds = memberships.docs.map(doc => doc.data().projectId);

          // 砖驻转 驻专拽   拽 -batch
          const promises = projectIds.map(projectId =>
            db.collection('projects').doc(projectId).get()
              .then(doc => {
                if (doc.exists) {
                  const project = doc.data();
                  // 拽 砖驻专拽  专 专砖
                  if (!allProjects.some(p => p.id === doc.id)) {
                    allProjects.push({
                      id: doc.id,
                      data: project,
                      role: 'member',
                      type: project.type
                    });
                  }
                }
                return null;
              })
              .catch(error => {
                console.error("Error loading team project:", error);
                return null;
              })
          );

          Promise.all(promises)
            .then(() => {
              // 住 驻 住 砖专  爪专
              let projectsToDisplay = allProjects;
              if (currentFilter !== "all") {
                projectsToDisplay = allProjects.filter(p => p.data.type === currentFilter);
              }

              // 住 驻 驻砖  拽
              const searchTerm = document.getElementById('search-projects').value.trim().toLowerCase();
              if (searchTerm) {
                projectsToDisplay = filterProjectsBySearchTerm(projectsToDisplay, searchTerm);
              }

              // 爪转 驻专拽 注
              displayProjects(projectsToDisplay);

              // 注 专 驻专拽 砖专
              updateProjectsDropdown();
            })
            .catch(error => {
              console.error("Error loading team projects:", error);
            });
        })
        .catch(error => {
          console.error("Error loading team memberships:", error);
        });
    }

    function loadProjectMembers(projectId) {
      console.log('Starting loadProjectMembers with id:', projectId);

      const membersList = document.getElementById('team-members-list');
      if (!membersList) {
        console.error('Error: team-members-list element not found!');
        return;
      }

      membersList.innerHTML = '<div>注 专 爪转...</div>';

      db.collection('project_members')
        .where('projectId', '==', projectId)
        .get()
        .then(snapshot => {
          console.log('Members data received, count:', snapshot.size);

          if (snapshot.empty && (!currentProjectData || currentProjectData.userId !== currentUser.uid)) {
            membersList.innerHTML = '<div> 专 爪转 住驻 驻专拽.</div>';
            currentProjectMembers = [];
            return;
          }

          membersList.innerHTML = '';
          currentProjectMembers = [];

          // 住驻转 注 驻专拽
          if (currentProjectData) {
            console.log('Adding project owner to members list');
            currentProjectMembers.push({
              userId: currentProjectData.userId,
              email: currentProjectData.ownerEmail || currentUser.email,
              displayName: currentProjectData.ownerName || currentUser.displayName || currentUser.email.split('@')[0],
              role: 'owner'
            });

            const ownerItem = document.createElement('div');
            ownerItem.className = 'member-item';
            ownerItem.innerHTML = `
              <div>
                <strong>${currentProjectData.ownerName || currentUser.displayName || currentUser.email.split('@')[0]}</strong>
                <div>${currentProjectData.ownerEmail || currentUser.email}</div>
                <span class="badge badge-owner"> 驻专拽</span>
              </div>
            `;
            membersList.appendChild(ownerItem);
          }

          // 住驻转 砖专 专 爪转
          console.log('Adding other team members');
          snapshot.forEach(doc => {
            const member = doc.data();
            const memberId = doc.id;

            currentProjectMembers.push({
              userId: member.userId,
              email: member.email,
              displayName: member.displayName,
              role: member.role
            });

            const memberItem = document.createElement('div');
            memberItem.className = 'member-item';
            memberItem.innerHTML = `
              <div>
                <strong>${member.displayName}</strong>
                <div>${member.email}</div>
              </div>
            `;

            // 驻砖专转 住专转 专 爪转 专拽 注 驻专拽
            if (currentProjectData && currentProjectData.userId === currentUser.uid) {
              const removeButton = document.createElement('button');
              removeButton.className = 'btn btn-sm btn-danger';
              removeButton.innerHTML = '<i class="fas fa-user-minus"></i>';
              removeButton.addEventListener('click', function() {
                if (confirm(` 住专 转 ${member.displayName} 驻专拽?`)) {
                  removeTeamMember(memberId, member.displayName);
                }
              });
              memberItem.appendChild(removeButton);
            }

            membersList.appendChild(memberItem);
          });

          // 注 专驻 专 砖转
          updateAssigneeDropdown();

          console.log('Finished loading members');
        })
        .catch(error => {
          console.error("Error loading team members:", error);
          membersList.innerHTML = '<div>砖 注转 专 爪转.</div>';
        });
    }

    // 注 专砖转 专 砖转 专驻
    function updateAssigneeDropdown() {
      const assigneeFilter = document.getElementById('task-filter-assignee');
      if (!assigneeFilter) return;

      assigneeFilter.innerHTML = '<option value="all"> 专</option>';
      assigneeFilter.innerHTML += '<option value="none"> 专</option>';

      // 住驻转  专 爪转 专砖
      currentProjectMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member.userId;
        option.textContent = member.displayName;
        assigneeFilter.appendChild(option);
      });

      // 爪转 专驻 专拽 驻专拽 爪转
      if (currentProjectData && currentProjectData.type === 'team') {
        assigneeFilter.classList.remove('hidden');
      } else {
        assigneeFilter.classList.add('hidden');
      }

      // 注  转转 专 砖 注专转 砖
      const taskAssignee = document.getElementById('task-assignee');
      if (taskAssignee) {
        taskAssignee.innerHTML = '<option value=""> 砖</option>';

        currentProjectMembers.forEach(member => {
          const option = document.createElement('option');
          option.value = member.userId;
          option.textContent = member.displayName;
          taskAssignee.appendChild(option);
        });
      }
    }

    function removeTeamMember(membershipId, memberName) {
      showLoader();

      db.collection('project_members').doc(membershipId).delete()
        .then(() => {
          hideLoader();

          // 专砖 驻注转
          logActivity('住专 专 爪转', currentProjectId, `住专 转 ${memberName} 驻专拽`);

          showNotification('专 爪转 住专', '专 爪转 住专 爪 驻专拽', 'success');

          loadProjectMembers(currentProjectId);
        })
        .catch(error => {
          hideLoader();
          console.error("Error removing team member:", error);
          showNotification('砖', '砖 住专转 专 爪转: ' + error.message, 'danger');
        });
    }

    function openProject(projectId, userRole, taskIdToShow = null) {
      console.log('Starting openProject with id:', projectId);
      showLoader();

      currentProjectId = projectId;

      try {
        // 砖 转爪 - 砖转砖 拽住 拽 住 砖专
        console.log('Changing view');
        document.getElementById('projects-view').classList.add('hidden');
        document.getElementById('dashboard-view').classList.add('hidden');
        document.getElementById('stats-view').classList.add('hidden');
        document.getElementById('activity-view').classList.add('hidden');
        document.getElementById('project-detail-view').classList.remove('hidden');

        // 注转 驻专 驻专拽
        console.log('Loading project details');
        db.collection('projects').doc(projectId).get()
          .then(doc => {
            console.log('Received doc:', doc.exists);
            if (!doc.exists) {
              hideLoader();
              showNotification('砖', '驻专拽  爪', 'danger');
              return;
            }

            const project = doc.data();
            console.log('Project data received:', project);
            currentProjectData = project;

            // 爪转 转专 驻专 拽
            let deadlineText = ' 转专 注';
            let deadlineClass = '';

            if (project.deadline) {
              const date = new Date(project.deadline);
              const today = new Date();
              today.setHours(0, 0, 0, 0);

              deadlineText = date.toLocaleDateString('he-IL');

              if (date < today) {
                deadlineClass = 'text-danger';
              }
            }

            console.log('Updating project detail HTML');
            // 爪转 驻专 驻专拽
            const projectDetail = document.getElementById('project-detail');
            if (!projectDetail) {
              console.error('Error: project-detail element not found!');
              hideLoader();
              return;
            }

            projectDetail.innerHTML = `
              <h2 style="margin-bottom: 15px;">${project.name}</h2>
              <div style="background-color: var(--light); padding: 15px; border-radius: var(--radius); margin-bottom: 20px;">
                <p style="margin-bottom: 15px;">${project.description || ' 转专'}</p>
                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                  <div>
                    <strong><i class="fas fa-tag"></i> 住 驻专拽:</strong>
                    <span class="badge ${project.type === 'personal' ? 'personal-project' : 'team-project'}" style="margin-right: 5px;">
                      ${project.type === 'personal' ? '砖' : '爪转'}
                    </span>
                  </div>
                  <div>
                    <strong><i class="fas fa-calendar-alt"></i> 转专 注:</strong>
                    <span class="${deadlineClass}">${deadlineText}</span>
                  </div>
                </div>
              </div>
            `;

            console.log('Project detail HTML updated');

            // 住驻转 驻转专 注专 专拽  砖爪专 转 驻专拽
            if (project.userId === currentUser.uid) {
              console.log('Adding edit button for project owner');
              const editButton = document.createElement('button');
              editButton.className = 'btn';
              editButton.innerHTML = '<i class="fas fa-edit"></i> 注专 驻专拽';
              editButton.addEventListener('click', function() {
                showEditProjectModal(projectId, project);
              });
              projectDetail.appendChild(editButton);
            }

            console.log('Setting up team members section');
            // 爪转 专 爪转 专拽 驻专拽 爪转
            const teamMembersSection = document.getElementById('team-members-section');
            if (teamMembersSection) {
              // 砖砖 拽住 拽 style 砖专
              if (project.type === 'team') {
                teamMembersSection.classList.remove('hidden');
              } else {
                teamMembersSection.classList.add('hidden');
              }
            } else {
              console.error('Error: team-members-section element not found!');
            }

            // 专转 转爪 砖  驻 住 驻专拽
            const taskViewTabs = document.getElementById('task-view-tabs');
            if (project.type === 'team') {
              taskViewTabs.classList.remove('hidden');
            } else {
              taskViewTabs.classList.add('hidden');
              // 驻专拽 砖 转 爪 转 转爪转 专砖
              document.getElementById('tasks-list-view').classList.remove('hidden');
              document.getElementById('tasks-by-assignee-view').classList.add('hidden');
              currentTaskView = "list";
            }

            if (project.type === 'team') {
              console.log('Loading project members');
              loadProjectMembers(projectId);

              // 爪转 驻转专 住驻转 专 专拽 注 驻专拽
              const addMemberBtn = document.getElementById('add-member-btn');
              if (addMemberBtn) {
                //  砖驻转专 专  砖转砖  注 驻专拽
                if (project.userId === currentUser.uid) {
                  addMemberBtn.style.display = 'block';
                  console.log('Add member button shown (project owner)');
                } else {
                  addMemberBtn.style.display = 'none';
                  console.log('Add member button hidden (not project owner)');
                }
              } else {
                console.error('Error: add-member-btn element not found!');
              }
            }

            console.log('Updating task tags dropdown');
            // 注 住 驻 转转
            updateProjectTaskTagsDropdown(projectId);

            console.log('Loading tasks');
            // 注转 砖转 砖 驻专拽
            loadTasks(projectId, taskIdToShow);

            // 注转 专祝 转拽转 驻专拽
            loadProjectProgressChart(projectId);

            console.log('Project loaded successfully');
          })
          .catch(function(error) {
            console.error('Error in openProject:', error);
            console.error('Error details:', error.message, error.stack);
            hideLoader();

            // 拽专 砖 砖, 专 爪 拽
            document.getElementById('projects-view').classList.remove('hidden');
            document.getElementById('project-detail-view').classList.add('hidden');

            showNotification('砖', '砖 注转 驻专 驻专拽: ' + (error.message || '注  注'), 'danger');
          });
      } catch (e) {
        // 转驻住转 砖转 砖注转 转专砖 驻 
        console.error('Unexpected error in openProject function:', e);
        hideLoader();

        // 专 爪 拽
        document.getElementById('projects-view').classList.remove('hidden');
        document.getElementById('project-detail-view').classList.add('hidden');

        showNotification('砖', '砖 驻转转 驻专拽: ' + (e.message || '注  注'), 'danger');
      }
    }

    // 砖 - 注转 专祝 转拽转 驻专拽
    function loadProjectProgressChart(projectId) {
    // 拽  砖  拽住 专祝
    const canvas = document.getElementById('project-progress-chart');
    if (!canvas) return;

    // 专转  拽住 拽住 专祝
    canvas.style.maxHeight = '250px'; //  拽住
    canvas.style.maxWidth = '100%'; // 专 拽住
    canvas.height = 250; //  拽住

    // 拽转 专祝 拽  砖
    if (charts.projectProgress) {
      charts.projectProgress.destroy();
    }

    // 砖: 拽转 拽砖专 砖 拽住 -   住专
    const ctx = canvas.getContext('2d');
    if (!ctx) {
      console.error(" 转 拽 拽砖专 2d 拽住");
      return;
    }

    // 注转 砖转 砖 驻专拽
    db.collection('tasks')
      .where('projectId', '==', projectId)
      .get()
      .then(snapshot => {
        if (snapshot.empty) {
          //  砖转, 爪 专祝 专拽
          charts.projectProgress = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: [' 砖转'],
              datasets: [{
                data: [1],
                backgroundColor: ['#e9ecef']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true, // 砖专 住 -专
              plugins: {
                legend: {
                  position: 'right', // 注专 转 拽专 爪  住 
                  labels: {
                    boxWidth: 12, // 拽 转 转转 爪注 拽专
                    padding: 10 // 专  驻专 拽专
                  }
                }
              },
              cutout: '60%' //  转 驻
            }
          });
          return;
        }

        // 砖 住住拽转 砖 砖转
        const statuses = {
          'not-started': 0,
          'in-progress': 0,
          'waiting': 0,
          'blocked': 0,
          'completed': 0
        };

        snapshot.forEach(doc => {
          const task = doc.data();
          const status = task.status || 'not-started';

          if (statuses[status] !== undefined) {
            statuses[status]++;
          }
        });

        // 爪专转 专祝
        charts.projectProgress = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: [
              '专 转',
              '转',
              '转',
              '转拽注',
              '砖'
            ],
            datasets: [{
              data: [
                statuses['not-started'],
                statuses['in-progress'],
                statuses['waiting'],
                statuses['blocked'],
                statuses['completed']
              ],
              backgroundColor: [
                '#e9ecef',  // 专 转
                '#4895ef',  // 转
                '#ffc107',  // 转
                '#dc3545',  // 转拽注
                '#28a745'   // 砖
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true, // 砖专 住 -专
            plugins: {
              legend: {
                position: 'right', // 注专 转 拽专 爪  住 
                labels: {
                  boxWidth: 12, // 拽 转 转转 爪注 拽专
                  padding: 10 // 专  驻专 拽专
                }
              },
              tooltip: {
                bodyFont: {
                  size: 12 //  拽住 驻
                }
              }
            },
            // 专转  驻 砖 注
            cutout: '60%' //  转 驻 ( 转专 = 注转 拽 转专)
          }
        });
      })
      .catch(error => {
        console.error('Error loading project progress chart:', error);
      });
  }
    function updateProjectTaskTagsDropdown(projectId) {
      // 注转 转转 砖转 砖 驻专拽 
      db.collection('tasks')
        .where('projectId', '==', projectId)
        .get()
        .then(snapshot => {
          const tags = new Set();

          snapshot.forEach(doc => {
            const task = doc.data();
            if (task.tags && task.tags.length > 0) {
              task.tags.forEach(tag => tags.add(tag));
            }
          });

          // 注 专驻
          const tagSelect = document.getElementById('task-filter-tag');
          tagSelect.innerHTML = '<option value="all"> 转转</option>';

          tags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            tagSelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error("Error loading project tags:", error);
        });
    }

    function showAddProjectModal() {
      document.getElementById('project-modal-title').textContent = '驻专拽 砖';
      document.getElementById('project-name').value = '';
      document.getElementById('project-description').value = '';
      document.getElementById('project-deadline').value = '';
      document.getElementById('project-type').value = 'personal';
      document.getElementById('project-type').disabled = false;
      document.getElementById('project-id').value = '';

      document.getElementById('project-modal').style.display = 'block';
    }

    function showEditProjectModal(projectId, project) {
      document.getElementById('project-modal-title').textContent = '注专转 驻专拽';
      document.getElementById('project-name').value = project.name || '';
      document.getElementById('project-description').value = project.description || '';
      document.getElementById('project-deadline').value = project.deadline || '';
      document.getElementById('project-type').value = project.type || 'personal';
      document.getElementById('project-id').value = projectId;

      // 注专转 驻专拽 拽  转 砖转 转 住 驻专拽
      document.getElementById('project-type').disabled = true;

      document.getElementById('project-modal').style.display = 'block';
    }

    function saveProject() {
      const name = document.getElementById('project-name').value.trim();
      const description = document.getElementById('project-description').value.trim();
      const deadline = document.getElementById('project-deadline').value;
      const type = document.getElementById('project-type').value;
      const projectId = document.getElementById('project-id').value;

      if (!name) {
       alert('  砖 驻专拽');
       return;
     }

     showLoader();

     const projectData = {
       name,
       description,
       deadline,
       updatedAt: firebase.firestore.FieldValue.serverTimestamp()
     };

     let savePromise;
     let actionType;

     if (projectId) {
       // 注 驻专拽 拽 -  砖转 转 住
       savePromise = db.collection('projects').doc(projectId).update(projectData);
       actionType = '注专 驻专拽';
     } else {
       // 爪专转 驻专拽 砖
       projectData.userId = currentUser.uid;
       projectData.type = type;
       projectData.ownerEmail = currentUser.email;
       projectData.ownerName = currentUser.displayName || currentUser.email.split('@')[0];
       projectData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
       savePromise = db.collection('projects').add(projectData);
       actionType = '爪专 驻专拽';
     }

     savePromise
       .then((result) => {
         hideLoader();
         document.getElementById('project-modal').style.display = 'none';
         document.getElementById('project-type').disabled = false; // 专转 专 爪 驻注

         // 专砖 驻注转
         const idToLog = projectId || (result ? result.id : null);
         if (idToLog) {
           logActivity(actionType, idToLog, `${actionType} "${name}"`);
         }

         showNotification('驻专拽 砖专', '驻专拽 砖专 爪', 'success');

         if (projectId) {
           //   注专转 驻专拽 拽
           openProject(projectId);
         } else {
           //   驻专拽 砖
           loadProjects();
         }
       })
       .catch(error => {
         hideLoader();
         console.error("Error saving project:", error);
         showNotification('砖', '砖 砖专转 驻专拽: ' + error.message, 'danger');
         document.getElementById('project-type').disabled = false;
       });
   }

   function deleteProject(projectId) {
     if (!confirm(' 转  砖专爪 拽 驻专拽 ?  砖转 专 爪转 拽.')) {
       return;
     }

     showLoader();

     // 专砖转 拽转  砖转 砖转 驻专拽
     db.collection('tasks')
       .where('projectId', '==', projectId)
       .get()
       .then(snapshot => {
         const batch = db.batch();

         snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });

          return batch.commit();
        })
        .then(() => {
          // 拽转 专 爪转 驻专拽 ( 砖)
          return db.collection('project_members')
            .where('projectId', '==', projectId)
            .get();
        })
        .then(snapshot => {
          const batch = db.batch();

          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });

          return batch.commit();
        })
        .then(() => {
          // 拽转 驻专拽 注爪
          return db.collection('projects').doc(projectId).delete();
        })
        .then(() => {
          hideLoader();
          // 专砖 驻注转
          logActivity('拽 驻专拽', projectId);

          showNotification('驻专拽 拽', '驻专拽 转转 拽 爪', 'success');

          // 拽  驻专拽  拽
          if (currentProjectId === projectId) {
            document.getElementById('projects-view').classList.remove('hidden');
            document.getElementById('project-detail-view').classList.add('hidden');
            document.getElementById('nav-projects').classList.add('active');
            currentProjectId = null;
          }

          // 专注 专砖转 驻专拽
          loadProjects();
        })
        .catch(error => {
          hideLoader();
          console.error("Error deleting project:", error);
          showNotification('砖', '砖 拽转 驻专拽: ' + error.message, 'danger');
        });
    }

    // 驻拽爪转 砖转
    function loadTasks(projectId, taskIdToShow = null) {
      console.log('Starting loadTasks with id:', projectId);

      const tasksList = document.getElementById('tasks-list');
      if (!tasksList) {
        console.error('Error: tasks-list element not found!');
        hideLoader();
        return;
      }

      tasksList.innerHTML = '<div>注 砖转...</div>';

      try {
        // 拽转 驻专专 砖 住 
        const sortByElement = document.getElementById('task-sort-by');
        const filterTagElement = document.getElementById('task-filter-tag');
        const filterStatusElement = document.getElementById('task-filter-status');
        const filterAssigneeElement = document.getElementById('task-filter-assignee');

        if (!sortByElement || !filterTagElement || !filterStatusElement) {
          console.error('Error: Sort or filter elements not found!');
          hideLoader();
          return;
        }

        const sortValue = sortByElement.value;
        const [sortField, sortDirection] = sortValue.split('-');
        const filterTag = filterTagElement.value;
        const filterStatus = filterStatusElement.value;
        const filterAssignee = filterAssigneeElement ? filterAssigneeElement.value : 'all';

        console.log('Query parameters:', {sortField, sortDirection, filterTag, filterStatus, filterAssignee});

        let query = db.collection('tasks')
          .where('projectId', '==', projectId);

        // 住驻转  砖转  驻砖专
        if (sortField === 'createdAt') {
          query = query.orderBy(sortField, sortDirection);
        }

        console.log('Fetching tasks from database');
        query.get()
          .then(snapshot => {
            console.log('Tasks data received, count:', snapshot.size);

            if (snapshot.empty) {
              tasksList.innerHTML = '<div style="text-align: center; padding: 15px;"> 砖转 驻专拽 . 抓 注 "住祝 砖" 住驻转 砖 砖.</div>';

              // 注 转爪转 砖转 驻 专
              if (currentTaskView === "assignee") {
                document.getElementById('unassigned-tasks-list').innerHTML = '<div> 砖转  专.</div>';
                document.getElementById('tasks-by-assignee').innerHTML = '';
              }

              hideLoader();
              return;
            }

            // 住祝 注 砖转
            let tasks = snapshot.docs.map(doc => {
              return {
                id: doc.id,
                data: doc.data()
              };
            });

            console.log('Processing and sorting tasks');

            // 住 驻 转转  专
            if (filterTag !== 'all') {
              tasks = tasks.filter(task => {
                const tags = task.data.tags || [];
                return tags.includes(filterTag);
              });
            }

            // 住 驻 住住  专
            if (filterStatus !== 'all') {
              tasks = tasks.filter(task => task.data.status === filterStatus);
            }

            // 住 驻 专  专
            if (filterAssignee !== 'all' && currentTaskView === 'list') {
              if (filterAssignee === 'none') {
                tasks = tasks.filter(task => !task.data.assigneeId);
              } else {
                tasks = tasks.filter(task => task.data.assigneeId === filterAssignee);
              }
            }

            //  转 爪专 ( 砖  createdAt 砖专 转 砖转)
            if (sortField !== 'createdAt') {
              tasks.sort((a, b) => {
                let valA = a.data[sortField] || '';
                let valB = b.data[sortField] || '';

                //   转专
                if (sortField === 'deadline') {
                  valA = valA ? new Date(valA) : new Date(9999, 11, 31);
                  valB = valB ? new Date(valB) : new Date(9999, 11, 31);
                }

                //   住住
                if (sortField === 'status') {
                  const statusOrder = {
                    'blocked': 0,
                    'waiting': 1,
                    'not-started': 2,
                    'in-progress': 3,
                    'completed': 4
                  };
                  valA = statusOrder[a.data.status || 'not-started'] || 999;
                  valB = statusOrder[b.data.status || 'not-started'] || 999;
                }

                if (sortDirection === 'asc') {
                  return valA > valB ? 1 : -1;
                } else {
                  return valA < valB ? 1 : -1;
                }
              });
            }

            console.log('Rendering tasks to UI');

            // 砖专转 砖转 砖转  砖砖 转爪转 砖转
            const allTasks = [...tasks];

            //  转爪  驻 专砖, 爪 转 砖转 专砖
            if (currentTaskView === "list") {
              // 专专 砖转
              tasksList.innerHTML = '';

              tasks.forEach(task => {
                try {
                  const taskElement = createTaskElement(task);
                  tasksList.appendChild(taskElement);
                } catch (err) {
                  console.error('Error creating task element:', err, task);
                }
              });
            } else if (currentTaskView === "assignee") {
              //  转爪  驻 专, 爪 转 砖转 驻 专
              displayTasksByAssignee(allTasks);
            }

            //  砖 砖 住驻爪驻转 爪
            if (taskIdToShow) {
              console.log('Showing specific task:', taskIdToShow);
              const taskToShow = tasks.find(t => t.id === taskIdToShow);
              if (taskToShow) {
                showEditTaskModal(taskIdToShow, taskToShow.data);
              }
            }

            hideLoader();
            console.log('Tasks loaded successfully');
          })
          .catch(error => {
            console.error("Error loading tasks:", error);
            hideLoader();
            tasksList.innerHTML = '<div>砖 注转 砖转.</div>';
            showNotification('砖', '砖 注转 砖转: ' + error.message, 'danger');
          });
      } catch (e) {
        console.error('Unexpected error in loadTasks:', e);
        hideLoader();
        tasksList.innerHTML = '<div>砖 转 爪驻 注转 砖转.</div>';
        showNotification('砖', '砖 转 爪驻 注转 砖转: ' + e.message, 'danger');
      }
    }

    // 驻拽爪 转爪转 砖转 驻 专
    function displayTasksByAssignee(tasks = null) {
      if (!tasks) {
        //   转拽 砖转, 注 砖
        loadTasks(currentProjectId);
        return;
      }

      const unassignedContainer = document.getElementById('unassigned-tasks-list');
      const assigneeContainer = document.getElementById('tasks-by-assignee');

      unassignedContainer.innerHTML = '';
      assigneeContainer.innerHTML = '';

      // 拽转 驻专 砖 专
      const assigneeFilter = document.getElementById('task-filter-assignee').value;

      // 拽爪转 砖转 驻 专
      const tasksByAssignee = new Map();

      // 砖转  专
      const unassignedTasks = tasks.filter(task => !task.data.assigneeId);

      // 住 驻 住住  专
      const statusFilter = document.getElementById('task-filter-status').value;

      let filteredUnassigned = unassignedTasks;
      if (statusFilter !== 'all') {
        filteredUnassigned = unassignedTasks.filter(task => task.data.status === statusFilter);
      }

      // 砖转 注 专
      tasks.forEach(task => {
        if (task.data.assigneeId) {
          // 住 驻 住住  专
          if (statusFilter !== 'all' && task.data.status !== statusFilter) {
            return;
          }

          // 住 驻 专 住驻爪驻  专
          if (assigneeFilter !== 'all' && assigneeFilter !== 'none' && task.data.assigneeId !== assigneeFilter) {
            return;
          }

          if (!tasksByAssignee.has(task.data.assigneeId)) {
            tasksByAssignee.set(task.data.assigneeId, []);
          }

          tasksByAssignee.get(task.data.assigneeId).push(task);
        }
      });

      // 爪转 砖转  专
      if (assigneeFilter === 'all' || assigneeFilter === 'none') {
        if (filteredUnassigned.length === 0) {
          unassignedContainer.innerHTML = '<div> 砖转  专.</div>';
        } else {
          filteredUnassigned.forEach(task => {
            unassignedContainer.appendChild(createTaskElement(task));
          });
        }
      } else {
        unassignedContainer.innerHTML = '<div>爪转 专拽 砖转 砖 专 砖专.</div>';
      }

      // 爪转 砖转 驻 专
      if (tasksByAssignee.size === 0 && (assigneeFilter === 'all' || assigneeFilter !== 'none')) {
        assigneeContainer.innerHTML = '<div> 砖转 注 专.</div>';
      } else {
        // 爪专转 拽专  专
        tasksByAssignee.forEach((tasks, assigneeId) => {
          // 爪转 驻专 专
          let assigneeName = ' 注';
          let assigneeInitial = '?';

          const assignee = currentProjectMembers.find(member => member.userId === assigneeId);
          if (assignee) {
            assigneeName = assignee.displayName;
            assigneeInitial = assigneeName.charAt(0).toUpperCase();
          } else if (assigneeId === currentUser.uid) {
            assigneeName = currentUser.displayName || currentUser.email.split('@')[0];
            assigneeInitial = assigneeName.charAt(0).toUpperCase();
          }

          // 爪专转 拽专 专
          const assigneeSection = document.createElement('div');
          assigneeSection.className = 'assignee-tasks-container';

          // 转专转 注 驻专 专
          const assigneeHeader = document.createElement('div');
          assigneeHeader.className = 'assignee-header';
          assigneeHeader.innerHTML = `
            <div class="assignee-avatar">${assigneeInitial}</div>
            <h3>${assigneeName}</h3>
          `;
          assigneeSection.appendChild(assigneeHeader);

          // 专砖转 砖转 砖 专
          const tasksList = document.createElement('div');
          tasksList.className = 'task-list';

          tasks.forEach(task => {
            tasksList.appendChild(createTaskElement(task));
          });

          assigneeSection.appendChild(tasksList);
          assigneeContainer.appendChild(assigneeSection);
        });
      }
    }

    function createTaskElement(task) {
    const { id, data } = task;

    // 爪转 转专 驻专 拽
    let deadlineText = ' 转专 注';
    let isOverdue = false;

    if (data.deadline) {
      const date = new Date(data.deadline);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      deadlineText = date.toLocaleDateString('he-IL');

      if (date < today && data.status !== 'completed') {
        isOverdue = true;
      }
    }

    // 爪专转  砖
    const taskItem = document.createElement('div');
    taskItem.className = `task-item ${data.status === 'completed' ? 'completed' : ''} ${data.isHelpRequest ? 'help-request' : ''}`;

    // 拽转 注 注 住住
    const statusClass = `status-${data.status || 'not-started'}`;
    const statusText = statusLabels[data.status || 'not-started'];

    // 注 注 专 砖
    let assigneeInfo = '';
    if (currentProjectData && currentProjectData.type === 'team' && data.assigneeId) {
      const assignee = currentProjectMembers.find(m => m.userId === data.assigneeId);
      if (assignee) {
        assigneeInfo = `
          <div class="task-assignee">
            <span class="assignee-avatar">${assignee.displayName.charAt(0).toUpperCase()}</span>
            <span>${assignee.displayName}</span>
          </div>
        `;
      }
    }

    // 爪专转 转转
    let tagsHtml = '';
    if (data.tags && data.tags.length > 0) {
      tagsHtml = '<div class="tags-container">';
      data.tags.forEach(tag => {
        const tagClass = getTagColorClass(tag);
        tagsHtml += `<span class="tag ${tagClass}">${tag}</span>`;
      });
      tagsHtml += '</div>';
    }

    // 注 住祝 注 住住 (住转 注  转 ...)
    let statusExtraInfo = '';
    if (data.status === 'blocked' && data.blockedReason) {
      statusExtraInfo = `<div style="margin-top: 5px; color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> 住转 注: ${data.blockedReason}</div>`;
    } else if (data.status === 'waiting' && data.waitingFor) {
      statusExtraInfo = `<div style="margin-top: 5px; color: var(--warning);"><i class="fas fa-hourglass-half"></i> 转 : ${data.waitingFor}</div>`;
    }

    // 拽  砖 拽爪
    let filesInfo = '';
    if (data.files && data.files.length > 0) {
      filesInfo = `<div style="margin-top: 5px; color: var(--primary);"><i class="fas fa-paperclip"></i> ${data.files.length} 拽爪 爪专驻</div>`;
    }

    // 爪专转 转 -HTML
    taskItem.innerHTML = `
      <div style="display: flex; align-items: flex-start;">
        <div class="task-content">
          <h4 class="task-title">${data.name}</h4>
          <div class="task-description">${data.description || ' 转专'}</div>
          <div class="task-meta">
            <span class="task-due-date ${isOverdue ? 'overdue' : ''}"><i class="fas fa-calendar-alt"></i> ${deadlineText}</span>
            <span class="task-status ${statusClass}">${statusText}</span>
            ${data.isHelpRequest ? '<span class="badge" style="background-color: var(--warning); color: white;"><i class="fas fa-hands-helping"></i> 拽砖转 注专</span>' : ''}
            ${assigneeInfo}
          </div>
          ${statusExtraInfo}
          ${filesInfo}
          ${tagsHtml}

          <!--  住祝 转 驻转专 住住 专 -->
          <div class="quick-status-buttons" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">
          </div>
        </div>
      </div>
      <div class="task-actions">
        <button class="btn btn-sm chat-task" data-id="${id}" data-name="${data.name}">
          <i class="fas fa-comments"></i>
        </button>
        <button class="btn btn-sm edit-task" data-id="${id}">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger delete-task" data-id="${id}">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;

    // 住驻转 驻转专 砖 住住 专
    const quickStatusButtons = taskItem.querySelector('.quick-status-buttons');
    if (quickStatusButtons) {
      // 住专 住住 驻  注
      const statuses = [
        { value: 'not-started', label: '专 转', color: '#e9ecef', textColor: '#212529' },
        { value: 'in-progress', label: '转', color: '#4895ef', textColor: '#ffffff' },
        { value: 'waiting', label: '转', color: '#ffc107', textColor: '#212529' },
        { value: 'blocked', label: '转拽注', color: '#dc3545', textColor: '#ffffff' },
        { value: 'completed', label: '砖', color: '#28a745', textColor: '#ffffff' }
      ];

      // 住驻转 驻转专  住住, 注 
      statuses.forEach(status => {
        //  爪 驻转专 住住 
        if (status.value === data.status) {
          return;
        }

        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn btn-sm status-btn';
        button.textContent = status.label;
        button.style.backgroundColor = status.color;
        button.style.color = status.textColor;
        button.style.border = 'none';
        button.style.fontSize = '12px';
        button.style.padding = '3px 8px';
        button.dataset.status = status.value;
        button.dataset.taskId = id;

        // 住驻转 驻转专 
        quickStatusButtons.appendChild(button);
      });
    }

    // 住驻转 专注
    const chatButton = taskItem.querySelector('.chat-task');
    if (chatButton) {
      chatButton.addEventListener('click', function() {
        const taskId = this.getAttribute('data-id');
        const taskName = this.getAttribute('data-name');
        showTaskChat(taskId, taskName);
      });
    }

    const editButton = taskItem.querySelector('.edit-task');
    if (editButton) {
      editButton.addEventListener('click', function() {
        db.collection('tasks').doc(id).get()
          .then(doc => {
            if (doc.exists) {
              showEditTaskModal(id, doc.data());
            }
          })
          .catch(error => {
            console.error("Error fetching task:", error);
          });
      });
    }

    const deleteButton = taskItem.querySelector('.delete-task');
    if (deleteButton) {
      deleteButton.addEventListener('click', function() {
        if (window.confirm(" 拽 转 砖?")) {
          deleteTask(id);
        }
      });
    }

    // 住驻转 专注 爪 驻转专 住住 专
    const statusButtons = taskItem.querySelectorAll('.status-btn');
    statusButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.stopPropagation(); // 注 驻转转  注专
        const newStatus = this.dataset.status;
        const taskId = this.dataset.taskId;
        const statusLabel = this.textContent;

        if (confirm(` 砖转 转 住住 砖 -${statusLabel}?`)) {
          quickUpdateTaskStatus(taskId, newStatus);
        }
      });
    });

    return taskItem;
  }
  // 驻拽爪 注 专 砖 住住 砖
function quickUpdateTaskStatus(taskId, newStatus) {
  showLoader();

  // 注 转专 
  const updates = {
    status: newStatus,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  // 住驻转 砖转 转 住住
  if (newStatus === 'completed') {
    updates.completedAt = firebase.firestore.FieldValue.serverTimestamp();
    updates.completedBy = currentUser.uid;
  }

  //   砖 砖专 住 砖,  专砖转 拽专 转
  db.collection('tasks').doc(taskId).get()
    .then(doc => {
      if (!doc.exists) {
        throw new Error('砖  拽转');
      }

      const taskData = doc.data();

      // 驻 砖转  转 住住 砖
      if (newStatus !== 'blocked' && taskData.blockedReason) {
        // 拽转 住转 注  住住  '转拽注'
        updates.blockedReason = firebase.firestore.FieldValue.delete();
      }

      if (newStatus !== 'waiting' && taskData.waitingFor) {
        // 拽转 砖 "转 "  住住  '转'
        updates.waitingFor = firebase.firestore.FieldValue.delete();
      }

      // 注 砖
      return db.collection('tasks').doc(taskId).update(updates);
    })
    .then(() => {
      hideLoader();
      showNotification('住住 注', '住住 砖 注 爪', 'success');

      // 专砖 驻注转
      logActivity('注 住住 砖', taskId, `砖 转 住住 砖 -${statusLabels[newStatus]}`);

      // 注 砖 砖 砖转
      if (currentTaskView === "list") {
        loadTasks(currentProjectId);
      } else {
        displayTasksByAssignee();
      }

      // 专注 专祝 转拽转 驻专拽
      loadProjectProgressChart(currentProjectId);
    })
    .catch(error => {
      hideLoader();
      console.error("Error updating task status:", error);
      showNotification('砖', '砖 注 住住 砖: ' + error.message, 'danger');
    });
}
    function showAddTaskModal(isHelpRequest = false) {
      document.getElementById('task-modal-title').textContent = isHelpRequest ? '拽砖转 注专 砖' : '砖 砖';
      document.getElementById('task-name').value = '';
      document.getElementById('task-description').value = '';
      document.getElementById('task-deadline').value = '';
      document.getElementById('task-id').value = '';
      document.getElementById('task-project-id').value = currentProjectId;
      document.getElementById('task-tags-hidden').value = '[]';
      document.getElementById('task-status').value = 'not-started';
      document.getElementById('task-blocked-reason').value = '';
      document.getElementById('task-waiting-for').value = '';

      // 住转专转 砖转 转 住住
      document.getElementById('task-blocked-reason-container').style.display = 'none';
      document.getElementById('task-waiting-for-container').style.display = 'none';

      // 驻住 转转
      document.getElementById('task-tags-items').innerHTML = '';
      document.getElementById('task-tag-input').value = '';

      // 驻住 拽爪
      uploadedFiles = [];
      document.getElementById('file-preview').innerHTML = '';

      //  转专 注 砖 驻专拽 专专转   拽
      if (currentProjectData && currentProjectData.deadline) {
        document.getElementById('task-deadline').value = currentProjectData.deadline;
      }

      // 爪转 专转 专 专拽 驻专拽 爪转
      const assigneeSection = document.getElementById('task-assignee-section');
      const assigneeSelect = document.getElementById('task-assignee');

      if (currentProjectData && currentProjectData.type === 'team') {
        //  专砖转 专 爪转
        assigneeSelect.innerHTML = '<option value=""> 砖</option>';

        currentProjectMembers.forEach(member => {
          const option = document.createElement('option');
          option.value = member.userId;
          option.textContent = member.displayName;
          assigneeSelect.appendChild(option);
        });

        assigneeSection.classList.remove('hidden');
      } else {
        assigneeSection.classList.add('hidden');
      }

      // 拽 拽砖转 注专
      document.getElementById('task-help-section').classList.toggle('hidden', !(currentProjectData && currentProjectData.type === 'team'));
      document.getElementById('task-help-request').checked = isHelpRequest;

      document.getElementById('task-modal').style.display = 'block';
    }
    // 驻拽爪 注 专 砖 住住 砖
    function quickUpdateTaskStatus(taskId, newStatus) {
      showLoader();

      // 注 转专 
      const updates = {
        status: newStatus,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // 住驻转 砖转 转 住住
      if (newStatus === 'completed') {
        updates.completedAt = firebase.firestore.FieldValue.serverTimestamp();
        updates.completedBy = currentUser.uid;
      }

      // 拽转 砖转  专 砖砖 住住
      if (newStatus !== 'blocked') {
        updates.blockedReason = firebase.firestore.FieldValue.delete();
      }

      if (newStatus !== 'waiting') {
        updates.waitingFor = firebase.firestore.FieldValue.delete();
      }

      db.collection('tasks').doc(taskId).update(updates)
        .then(() => {
          hideLoader();
          showNotification('住住 注', '住住 砖 注 爪', 'success');

          // 专砖 驻注转
          logActivity('注 住住 砖', taskId, `砖 转 住住 砖 -${getStatusLabel(newStatus)}`);

          // 注 砖 砖 砖转
          if (currentTaskView === "list") {
            loadTasks(currentProjectId);
          } else {
            displayTasksByAssignee();
          }

          // 专注 专祝 转拽转 驻专拽
          loadProjectProgressChart(currentProjectId);
        })
        .catch(error => {
          hideLoader();
          console.error("Error updating task status:", error);
          showNotification('砖', '砖 注 住住 砖', 'danger');
        });
    }

    // 驻拽爪 注专 拽转 转转 住住 注专转
    function getStatusLabel(status) {
      const statusLabels = {
        'not-started': '专 转',
        'in-progress': '转',
        'waiting': '转',
        'blocked': '转拽注',
        'completed': '砖'
      };

      return statusLabels[status] || status;
    }

    function showEditTaskModal(taskId, task) {
      document.getElementById('task-modal-title').textContent = task.isHelpRequest ? '注专转 拽砖转 注专' : '注专转 砖';
      document.getElementById('task-name').value = task.name || '';
      document.getElementById('task-description').value = task.description || '';
      document.getElementById('task-deadline').value = task.deadline || '';
      document.getElementById('task-id').value = taskId;
      document.getElementById('task-project-id').value = task.projectId;
      document.getElementById('task-status').value = task.status || 'not-started';
      document.getElementById('task-blocked-reason').value = task.blockedReason || '';
      document.getElementById('task-waiting-for').value = task.waitingFor || '';

      // 爪转/住转专转 砖转 转 住住
      document.getElementById('task-blocked-reason-container').style.display = (task.status === 'blocked') ? 'block' : 'none';
      document.getElementById('task-waiting-for-container').style.display = (task.status === 'waiting') ? 'block' : 'none';

      // 注转 转转
      loadTagsToInput(task.tags || []);

      // 注转 拽爪
      loadTaskFiles(taskId);

      // 爪转 专转 专 专拽 驻专拽 爪转
      const assigneeSection = document.getElementById('task-assignee-section');
      const assigneeSelect = document.getElementById('task-assignee');

      if (currentProjectData && currentProjectData.type === 'team') {
        //  专砖转 专 爪转
        assigneeSelect.innerHTML = '<option value=""> 砖</option>';

        currentProjectMembers.forEach(member => {
          const option = document.createElement('option');
          option.value = member.userId;
          option.textContent = member.displayName;

          // 专转 专 
          if (task.assigneeId && task.assigneeId === member.userId) {
            option.selected = true;
          }

          assigneeSelect.appendChild(option);
        });

        assigneeSection.classList.remove('hidden');
      } else {
        assigneeSection.classList.add('hidden');
      }

      // 拽 拽砖转 注专
      document.getElementById('task-help-section').classList.toggle('hidden', !(currentProjectData && currentProjectData.type === 'team'));
      document.getElementById('task-help-request').checked = task.isHelpRequest || false;

      document.getElementById('task-modal').style.display = 'block';
    }

    async function saveTask() {
      const name = document.getElementById('task-name').value.trim();
      const description = document.getElementById('task-description').value.trim();
      const deadline = document.getElementById('task-deadline').value;
      const taskId = document.getElementById('task-id').value;
      const projectId = document.getElementById('task-project-id').value;
      const tagsJson = document.getElementById('task-tags-hidden').value;
      const tags = tagsJson ? JSON.parse(tagsJson) : [];
      const status = document.getElementById('task-status').value;
      const blockedReason = document.getElementById('task-blocked-reason').value.trim();
      const waitingFor = document.getElementById('task-waiting-for').value.trim();

      // 注 注 拽砖转 注专
      const isHelpRequest = document.getElementById('task-help-request').checked;

      // 注 注 专 (专拽 驻专拽 爪转)
      let assigneeId = null;
      if (currentProjectData && currentProjectData.type === 'team') {
        assigneeId = document.getElementById('task-assignee').value;

        //   拽砖转 注专  专, 驻住 转 专
        if (isHelpRequest && !assigneeId) {
          assigneeId = null;
        }
      }

      if (!name) {
        showNotification('砖 ', '  砖 砖', 'warning');
        return;
      }

      if (!projectId) {
        showNotification('砖', ' 专 驻专拽', 'danger');
        return;
      }

      showLoader();

      const taskData = {
        name,
        description,
        deadline,
        projectId,
        tags,
        isHelpRequest,
        status,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // 住驻转 注 注 爪 砖 转 住住
      if (status === 'blocked' && blockedReason) {
        taskData.blockedReason = blockedReason;
      } else if (taskId) {
        // 拽转 砖  砖  转拽注 - 专拽 注 砖 拽转
        taskData.blockedReason = firebase.firestore.FieldValue.delete();
      }

      if (status === 'waiting' && waitingFor) {
        taskData.waitingFor = waitingFor;
      } else if (taskId) {
        // 拽转 砖  砖  转 - 专拽 注 砖 拽转
        taskData.waitingFor = firebase.firestore.FieldValue.delete();
      }

      // 住驻转 砖 专 专拽 驻专拽 爪转
      if (currentProjectData && currentProjectData.type === 'team') {
        taskData.assigneeId = assigneeId || null;
      }

      try {
        // 注转 拽爪 -Storage,  砖
        let filesMetadata = [];
        if (uploadedFiles.length > 0) {
          // 砖 转 转 拽转  注转  拽爪
          let actualTaskId = taskId;

          if (!actualTaskId) {
            //   砖 砖, 爪专 专砖 砖 -ID 砖
            const newTaskRef = db.collection('tasks').doc();
            actualTaskId = newTaskRef.id;
          }

          // 注转 拽爪
          filesMetadata = await uploadTaskFiles(actualTaskId);

          // 住驻转 注 拽爪 转 砖
          if (taskId) {
            //   砖 拽转, 砖专转 拽爪 拽  住驻转 砖
            const existingTask = await db.collection('tasks').doc(taskId).get();
            if (existingTask.exists) {
              const existingFiles = existingTask.data().files || [];
              taskData.files = [...existingFiles, ...filesMetadata];
            } else {
              taskData.files = filesMetadata;
            }
          } else {
            //   砖 砖
            taskData.files = filesMetadata;
          }
        }

        let savePromise;
        let actionType;

        if (taskId) {
          // 注 砖 拽转
          savePromise = db.collection('tasks').doc(taskId).update(taskData);
          actionType = '注专 砖';
        } else {
          // 爪专转 砖 砖 - 爪专 住专 转 驻注转 拽
          // 拽专 砖 砖 砖, 驻砖   转 砖转 砖 专
          if (taskData.blockedReason === firebase.firestore.FieldValue.delete()) {
            delete taskData.blockedReason;
          }

          if (taskData.waitingFor === firebase.firestore.FieldValue.delete()) {
            delete taskData.waitingFor;
          }

          taskData.createdBy = currentUser.uid;
          taskData.createdAt = firebase.firestore.FieldValue.serverTimestamp();

          //  爪专 专砖 ID (拽专 砖 注转 拽爪), 砖转砖 
         if (filesMetadata.length > 0) {
           const preCreatedTaskId = filesMetadata[0].path.split('/')[1];
           savePromise = db.collection('tasks').doc(preCreatedTaskId).set(taskData);
         } else {
           savePromise = db.collection('tasks').add(taskData);
         }

         actionType = '爪专 砖';
       }

       savePromise
         .then((result) => {
           hideLoader();
           document.getElementById('task-modal').style.display = 'none';

           // 专砖 驻注转
           const idToLog = taskId || (result && result.id ? result.id : null);
           if (idToLog) {
             logActivity(actionType, idToLog, `${actionType} "${name}"`);
           }

           showNotification('砖 砖专', '砖 砖专 爪', 'success');

           // 注 住 驻 转转
           updateProjectTaskTagsDropdown(projectId);

           // 注 砖 砖 砖转
           if (currentTaskView === "list") {
             loadTasks(projectId);
           } else {
             displayTasksByAssignee();
           }

           // 专注 专祝 转拽转 驻专拽
           loadProjectProgressChart(projectId);
         })
         .catch(error => {
           hideLoader();
           console.error("Error saving task:", error);
           showNotification('砖', '砖 砖专转 砖: ' + error.message, 'danger');
         });
     } catch (error) {
       hideLoader();
       console.error("Error processing task save:", error);
       showNotification('砖', '砖 注 砖: ' + error.message, 'danger');
     }
   }

   function deleteTask(taskId) {
     showLoader();

     // 拽转 转 砖 专砖 驻注转
     db.collection('tasks').doc(taskId).get()
       .then(doc => {
         if (doc.exists) {
           const taskData = doc.data();

           // 拽转 拽爪  拽
           const files = taskData.files || [];
           const deleteFilePromises = files.map(file =>
             storage.ref(file.path).delete().catch(error => {
               console.error("Error deleting file:", error);
               // 砖   砖 砖 拽转 拽抓
               return null;
             })
           );

           return Promise.all(deleteFilePromises)
             .then(() => {
               // 拽转 砖 注爪
               return db.collection('tasks').doc(taskId).delete()
                 .then(() => {
                   // 专砖 驻注转
                   logActivity('拽 砖', taskId, `拽 转 砖 "${taskData.name}"`);

                   hideLoader();
                   showNotification('砖 拽', '砖 拽 爪', 'success');

                   // 专注 转爪转 砖转
                   if (currentTaskView === "list") {
                     loadTasks(currentProjectId);
                   } else {
                     displayTasksByAssignee();
                   }

                   // 专注 专祝 转拽转 驻专拽
                   loadProjectProgressChart(currentProjectId);
                 });
             });
         } else {
           // 砖  爪
           return db.collection('tasks').doc(taskId).delete();
         }
       })
       .catch(error => {
         hideLoader();
         console.error("Error deleting task:", error);
         showNotification('砖', '砖 拽转 砖: ' + error.message, 'danger');
       });
   }

   // 住专转  爪 抓 转
   window.addEventListener('click', function(e) {
     if (e.target.classList.contains('modal')) {
       e.target.style.display = 'none';
     }
   });

   // 住驻转    注转
   console.log("Debugging mode enabled");

   // 注拽 专 砖转
   window.addEventListener('error', function(e) {
     console.error("Global error:", e.message, e);
   });

   //  专注 爪 注 驻转专 住驻转 砖转砖 专砖
   document.addEventListener('DOMContentLoaded', function() {
     // 住驻转 专注 驻转专 住驻转 砖转砖 专砖
     const addAuthorizedBtn = document.getElementById('add-authorized-btn');
     if (addAuthorizedBtn) {
       addAuthorizedBtn.addEventListener('click', function() {
         const email = document.getElementById('authorized-email').value.trim();
         if (email) {
           addAuthorizedUserByEmail(email);
         } else {
           alert('   转拽');
         }
       });
     }

     // 拽转 转专转  注
     setTimeout(() => {
       if (currentUser) {
         checkDeadlines();
       }
     }, 2000);
   });

   // 驻注转 转 Firebase 注转 祝
   document.addEventListener('DOMContentLoaded', initializeFirebase);
  </script>
</body>
</html>
